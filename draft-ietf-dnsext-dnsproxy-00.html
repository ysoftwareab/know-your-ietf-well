<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>DNS Proxy Implementation Guidelines</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="DNS Proxy Implementation Guidelines">
<meta name="keywords" content="DNS, Proxy">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">DNSEXT</td><td class="header">R. Bellis</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Nominet UK</td></tr>
<tr><td class="header">Intended status: BCP</td><td class="header">November 28, 2008</td></tr>
<tr><td class="header">Expires: June 1, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />DNS Proxy Implementation Guidelines<br />draft-ietf-dnsext-dnsproxy-00</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on June 1, 2009.</p>

<h3>Abstract</h3>

<p> This document provides guidelines for the implementation of DNS proxies, as found in
                broadband routers and other similar network devices.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<br />
<a href="#anchor3">3.</a>&nbsp;
The Transparency Principle<br />
<br />
<a href="#anchor4">4.</a>&nbsp;
Protocol Conformance<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#flags">4.1.</a>&nbsp;
Unexpected Flags and Data<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#unknown">4.2.</a>&nbsp;
Unknown Resource Record Types<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.3.</a>&nbsp;
Packet Size Limits<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.3.1.</a>&nbsp;
TCP Transport<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.3.2.</a>&nbsp;
Extension Mechanisms for DNS (EDNS0)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">4.3.3.</a>&nbsp;
IP Fragmentation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.4.</a>&nbsp;
Secret Key Transaction Authentication for DNS (TSIG)<br />
<br />
<a href="#anchor10">5.</a>&nbsp;
DHCP's Interaction with DNS<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.1.</a>&nbsp;
Domain Name Server (DHCP Option 6)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">5.2.</a>&nbsp;
Domain Name (DHCP Option 15)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.3.</a>&nbsp;
DHCP Leases<br />
<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">6.1.</a>&nbsp;
Forgery Resilience<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">6.2.</a>&nbsp;
Interface Binding<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">6.3.</a>&nbsp;
Packet Filtering<br />
<br />
<a href="#iana">7.</a>&nbsp;
IANA Considerations<br />
<br />
<a href="#anchor17">8.</a>&nbsp;
Change Log<br />
<br />
<a href="#anchor18">9.</a>&nbsp;
Acknowledgements<br />
<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
Informative References<br />
<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> Recent research (<a class='info' href='#SAC035'>[SAC035]<span> (</span><span class='info'>Bellis, R. and L. Phifer, &ldquo;Test Report: DNSSEC Impact on Broadband Routers and Firewalls,&rdquo; September&nbsp;2008.</span><span>)</span></a>, <a class='info' href='#DOTSE'>[DOTSE]<span> (</span><span class='info'>Ahlund and Wallstrom, &ldquo;DNSSEC Tests of Consumer Broadband Routers,&rdquo; February&nbsp;2008.</span><span>)</span></a>) has shown that
                many commonly-used broadband routers (and similar devices) contain DNS proxies which
                are incompatible in various ways with current DNS standards. 
</p>
<p> These proxies are usual simple DNS forwarders, but do not usually have any caching
                capabilities. The proxy serves as a convenient default DNS resolver for clients on
                the LAN, but relies on an upstream resolver (e.g. at an ISP) to perform recursive
                DNS lookups.
</p>
<p> This documents describes the incompatibilities that have been discovered and offers
                guidelines to implementors on how to provide maximum interoperability.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
                "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be
                interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
The Transparency Principle</h3>

<p> It is not considered practical for a simple DNS proxy to directly implement all
                current and future DNS features.
</p>
<p> There are several reasons why this is the case:
</p>
<p>
                </p>
<ul class="text">
<li> broadband routers usually have limited hardware resources 
</li>
<li> firmware upgrade cycles are long, and many users do not routinely apply
                        upgrades when they become available
</li>
<li> no-one knows what those future DNS features will be, nor how they might be
                        implemented
</li>
<li> it would substantially complicate the configuration UI of the device
</li>
</ul><p>
            
</p>
<p> Furthermore some modern DNS protocol extensions (see e.g. EDNS0, below) are intended
                to be used as "hop-by-hop" mechanisms. If the DNS proxy is considered to be such a
                "hop" in the resolution chain then for it to function correctly it would need to be
                fully compliant with all such mechanisms.
</p>
<p> Research has shown that the more actively a proxy participates in the DNS protocol
                then the more likely it is that it will somehow interfere with the flow of messages
                between the DNS client and the upstream recursive resolvers.
</p>
<p> The task of the proxy SHOULD therefore be no more and no less than to receive DNS
                requests from clients on the LAN side, forward those verbatim to one of the known
                upstream recursive resolvers on the WAN side, and ensure that the whole response is
                returned verbatim to the original client.
</p>
<p> It is RECOMMENDED that proxies should be as transparent as possible, such that any
                "hop-by-hop" mechanisms or newly introduced protocol extensions operate as if the
                proxy were not there.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Protocol Conformance</h3>

<a name="flags"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Unexpected Flags and Data</h3>

<p> The Transparency Principle above, when combined with <a class='info' href='#RFC0793'>Postel's Robustness Principle<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> [RFC0793], suggests that DNS proxies should not
                    arbitrarily reject or otherwise drop requests or responses based on perceived
                    non-compliance with standards.
</p>
<p> For example, some proxies have been observed to drop any packet containing
                    either the "Authentic Data" (AD) or "Checking Disabled" (CD) bits from <a class='info' href='#RFC4035'>DNSSEC<span> (</span><span class='info'>Arends, R., Austein, R., Larson, M., Massey, D., and S. Rose, &ldquo;Protocol Modifications for the DNS Security Extensions,&rdquo; March&nbsp;2005.</span><span>)</span></a> [RFC4035]. This may be because <a class='info' href='#RFC1035'>[RFC1035]<span> (</span><span class='info'>Mockapetris, P., &ldquo;Domain names - implementation and specification,&rdquo; November&nbsp;1987.</span><span>)</span></a>
                    originally specified that these unused "Z" flag bits "MUST" be zero. However
                    these flag bits were always intended to be reserved for future use, so refusing
                    to proxy any packet containing these flags (now that uses for those flags have
                    indeed been defined) is not appropriate.
</p>
<p> Therefore it is RECOMMENDED that proxies SHOULD ignore any unknown DNS flags and
                    proxy those packets as usual.
</p>
<a name="unknown"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Unknown Resource Record Types</h3>

<p>
                    <a class='info' href='#RFC3597'>[RFC3597]<span> (</span><span class='info'>Gustafsson, A., &ldquo;Handling of Unknown DNS Resource Record (RR) Types,&rdquo; September&nbsp;2003.</span><span>)</span></a> requires that resolvers MUST handle Resource Records
                    (RRs) of unknown type transparently.
</p>
<p> All requests and responses MUST be proxied regardless of the values of the QTYPE
                    and QCLASS fields.
</p>
<p> Similarly all responses MUST be proxied regardless of the values of the TYPE and
                    CLASS fields of any Resource Record therein.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Packet Size Limits</h3>

<p>
                    <a class='info' href='#RFC1035'>[RFC1035]<span> (</span><span class='info'>Mockapetris, P., &ldquo;Domain names - implementation and specification,&rdquo; November&nbsp;1987.</span><span>)</span></a> specifies that the maximum size of the DNS payload in a
                    UDP packet is 512 octets. Where the required portions of a response would not
                    fit inside that limit the DNS server MUST set the "TrunCation" (TC) bit in the
                    DNS response header to indicate that truncation has occurred. There are however
                    two standard mechanisms (described below) for transporting responses larger than
                    512 octets.
</p>
<p> Many proxies have been observed to truncate all responses at 512 octets, and
                    others at a packet size related to the WAN MTU, in either case doing so without
                    correctly setting the TC bit.
</p>
<p> Other proxies have been observed to incorrectly remove the TC bit in server
                    responses which correctly had the TC bit set by the server.
</p>
<p> If a DNS response is truncated but the TC bit is not set then client failures
                    may result, in particular a na√Øve DNS client library might suffer crashes due to
                    reading beyond the end of the data actually received.
</p>
<p> Therefore if a proxy must unilaterally truncate a response then the proxy MUST
                    set the TC bit. Similarly, proxies MUST NOT remove the TC bit from responses.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.1"></a><h3>4.3.1.&nbsp;
TCP Transport</h3>

<p> Should a UDP query fail because of truncation the standard fail-over
                        mechanism is to retry the query using TCP, as described in section 6.1.3.2
                        of <a class='info' href='#RFC1123'>[RFC1123]<span> (</span><span class='info'>Braden, R., &ldquo;Requirements for Internet Hosts - Application and Support,&rdquo; October&nbsp;1989.</span><span>)</span></a> .
</p>
<p> DNS proxies SHOULD therefore be prepared to receive and forward queries over
                        TCP.
</p>
<p> Note that it is unlikely that a client would send a request over TCP unless
                        it had already received a truncated UDP response. Some "smart" proxies have
                        been observed to first forward a request received over TCP to an upstream
                        resolver over UDP, only for the response to be truncated, causing the proxy
                        to retry over TCP. Such behaviour increases network traffic and causes delay
                        in DNS resolution since the initial UDP request is doomed to fail.
</p>
<p> Therefore whenever a proxy receives a request over TCP, the proxy SHOULD
                        forward the query over TCP and SHOULD NOT attempt the same query over UDP
                        first.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.2"></a><h3>4.3.2.&nbsp;
Extension Mechanisms for DNS (EDNS0)</h3>

<p> The <a class='info' href='#RFC2671'>Extension Mechanism for DNS<span> (</span><span class='info'>Vixie, P., &ldquo;Extension Mechanisms for DNS (EDNS0),&rdquo; August&nbsp;1999.</span><span>)</span></a> [RFC2671] was introduced
                        to allow the transport of larger DNS packets over UDP and also to allow for
                        additional request and response flags.
</p>
<p> A client may send an OPT Resource Record (OPT RR) in the Additional Section
                        of a request to indicate that it supports a specific receive buffer size.
                        The OPT RR also includes the "DNSSEC OK" (DO) flag used by DNSSEC to
                        indicate that DNSSEC-related RRs should be returned to the client.
</p>
<p> However some proxies have been observed to either reject (with a FORMERR
                        response code) or black-hole any packet containing an OPT RR. As per <a class='info' href='#flags'>Section&nbsp;4.1<span> (</span><span class='info'>Unexpected Flags and Data</span><span>)</span></a> proxies SHOULD NOT refuse to proxy such packets. 
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.3"></a><h3>4.3.3.&nbsp;
IP Fragmentation</h3>

<p> Support for UDP packet sizes exceeding the WAN MTU depends on the router's
                        algorithm for handling fragmented IP packets. Several options are possible:
</p>
<p>
                        </p>
<ol class="text">
<li> fragments are dropped
</li>
<li> fragments are forwarded individually as they're received 
</li>
<li> complete packets are reassembled on the router, and then
                                re-fragmented (if necessary) as they're forwarded to the client 
</li>
</ol><p>
                    
</p>
<p> Option 1 above will cause compatibility problems with EDNS0 unless the DNS
                        client is configured to advertise an EDNS0 buffer size limited to 28 octets
                        less than the MTU. Note that RFC 2671 does recommend that the path MTU
                        should be taken into account when using EDNS0.
</p>
<p> Also, whilst the EDNS0 specification allows for a buffer size of up to 65535
                        octets, most common DNS server implementations do not support a buffer size
                        above 4096 octets.
</p>
<p> Therefore it is RECOMMENDED (whichever of options 2 or 3 above is in use)
                        that routers SHOULD be capable of forwarding UDP packets up to a payload
                        size of at least 4096 octets.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Secret Key Transaction Authentication for DNS (TSIG)</h3>

<p>
                    <a class='info' href='#RFC2845'>[RFC2845]<span> (</span><span class='info'>Vixie, P., Gudmundsson, O., Eastlake, D., and B. Wellington, &ldquo;Secret Key Transaction Authentication for DNS (TSIG),&rdquo; May&nbsp;2000.</span><span>)</span></a> defines TSIG, which is a hop-by-hop mechanism for
                    authenticating DNS requests and responses at the packet level. 
</p>
<p> Whilst it's not impossible for a simple DNS proxy to implement TSIG directly it
                    is not advised since parsing and validating received packets is a
                    computationally intensive task, best left to full-featured DNS clients.
</p>
<p> DNS proxies SHOULD be transparent to TSIG signed packets.
</p>
<p> Similarly, as per <a class='info' href='#unknown'>Section&nbsp;4.2<span> (</span><span class='info'>Unknown Resource Record Types</span><span>)</span></a>, DNS proxies SHOULD be capable to
                    proxying packets containing <a class='info' href='#RFC2930'>TKEY<span> (</span><span class='info'>Eastlake, D., &ldquo;Secret Key Establishment for DNS (TKEY RR),&rdquo; September&nbsp;2000.</span><span>)</span></a> [RFC2930] Resource Records
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
DHCP's Interaction with DNS</h3>

<p> Whilst this document is primarily about DNS proxies, most consumers rely on <a class='info' href='#RFC2131'>DHCP<span> (</span><span class='info'>Droms, R., &ldquo;Dynamic Host Configuration Protocol,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2131] to obtain network configuration settings. Such
                settings include the client machine's IP address, subnet mask and default gateway,
                but also include DNS related settings.
</p>
<p> It is therefore appropriate to examine how DHCP affects client DNS configuration.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Domain Name Server (DHCP Option 6)</h3>

<p> Most routers default to supplying their own IP address in the DHCP "Domain Name
                    Server" <a class='info' href='#RFC2132'>option<span> (</span><span class='info'>Alexander, S. and R. Droms, &ldquo;DHCP Options and BOOTP Vendor Extensions,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2132]. The net result is that without
                    explicit re-configuration many DNS clients will by default send queries to the
                    router's DNS proxy. This is understandable behaviour given that the correct
                    upstream settings are not usually known at boot time. 
</p>
<p> Most routers learn their own DNS settings via values supplied by an ISP via DHCP
                    or PPP over the WAN interface. However whilst many routers do allow the end-user
                    to override those values, some routers only use those end-user supplied values
                    to affect the proxy's own forwarding function, and do not offer these values via
                    DHCP.
</p>
<p> When using such a device the only way to avoid using the DNS proxy is to
                    hard-code the required values in the client operating system. This may be
                    acceptable for a desktop system but it is inappropriate for mobile devices which
                    are regularly used on many different networks.
</p>
<p> End users SHOULD be able to send their DNS queries directly to specified
                    upstream resolvers, ideally without hard-coding those settings in their stub
                    resolver.
</p>
<p> It is therefore RECOMMENDED that routers SHOULD support end-user configuration
                    of values for the "Domain Name Server" DHCP option.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Domain Name (DHCP Option 15)</h3>

<p> A significant amount of traffic to the DNS Root Name Servers is for invalid
                    top-level domain names, and some of that traffic can be attributed to particular
                    equipment vendors whose firmware defaults this DHCP option to specific values. 
</p>
<p> Since no standard exists for a "local" scoped domain name suffix it is
                    RECOMMENDED that the default value for this option SHOULD be empty, and that
                    this option SHOULD NOT be sent to clients when no value is configured. 
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
DHCP Leases</h3>

<p> It is noted that some DHCP servers in broadband gateways by default offer their
                    own IP address for the "Domain Name Server" option (as describe above) but then
                    automatically start offering the upstream settings once they've been learnt over
                    the WAN interface.
</p>
<p> In general this behaviour is desirable, but the effect for the end-user is that
                    the settings used depend on whether the DHCP lease was obtained before or after
                    the WAN link was established.
</p>
<p> If the DHCP lease is obtained whilst the WAN link is down then the DHCP client
                    (and hence the DNS client) will not receive the correct values until the DHCP
                    lease is renewed.
</p>
<p> Whilst no specific recommendations are given here, vendors may wish to give
                    consideration to the length of DHCP leases, and whether some mechanism for
                    forcing a DHCP lease renewal (i.e. by toggling the LAN port link state whenever
                    the WAN link state changes from DOWN to UP) might be appropriate.
</p>
<p> Another possibility is that the learnt upstream values might be persisted in
                    non-volatile memory such that on reboot the same values can be automatically
                    offered via DHCP. However this does run the risk that incorrect values are
                    initially offered if the device is moved or connected to another ISP.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>This document introduces no new protocols. However there are some security related
                recommendations for vendors that are listed here.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Forgery Resilience</h3>

<p> Whilst DNS proxies are not usually full-feature resolvers they nevertheless
                    share some characteristics with them.
</p>
<p> Notwithstanding the recommendations above about transparency many DNS proxies
                    are observed to pick a new Query ID for outbound requests to ensure that
                    responses are directed to the correct client.
</p>
<p> It has been standard guidance for many years that each DNS query should use a
                    randomly generated Query ID. However many proxies have been observed picking
                    sequential Query IDs for successive requests.
</p>
<p> DNS proxies SHOULD follow the relevant recommendations in <a class='info' href='#I-D.ietf-dnsext-forgery-resilience'>[I&#8209;D.ietf&#8209;dnsext&#8209;forgery&#8209;resilience]<span> (</span><span class='info'>Hubert, B. and R. Mook, &ldquo;Measures for making DNS more resilient against forged answers,&rdquo; December&nbsp;2008.</span><span>)</span></a>, particularly those in Section
                    9.2 relating to randomisation of Query IDs and source ports.
</p>
<p> NB: Changing the Query ID is incompatible with transparent proxying of any TSIG
                    records since the TSIG signature includes the Query ID. It SHOULD be avoided
                    wherever possible.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Interface Binding</h3>

<p> Some routers have been observed to have their DNS proxy listening on both
                    internal (LAN) and external (WAN) interfaces. In this configuration it is
                    possible for the proxy to be used to mount reflector attacks as described in
                        <a class='info' href='#RFC5358'>[RFC5358]<span> (</span><span class='info'>Damas, J. and F. Neves, &ldquo;Preventing Use of Recursive Nameservers in Reflector Attacks,&rdquo; October&nbsp;2008.</span><span>)</span></a>
</p>
<p> The DNS proxy in a router SHOULD NOT by default be accessible from the WAN
                    interfaces of the device.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Packet Filtering</h3>

<p> The Transparency and Robustness Principles are not entirely compatible with the
                    Deep Packet Inspection features of security appliances such as firewalls which
                    are intended to protect systems on the inside of a network from rogue traffic.
</p>
<p> However a clear distinction may be made between traffic that is intrinsically
                    malformed and that which merely contains unexpected data.
</p>
<p> Examples of malformed packets which MAY be dropped include:
</p>
<p>
                    </p>
<ul class="text">
<li> invalid compression pointers (i.e. those that run forward of the current
                            packet offset, or which might cause a parsing loop).
</li>
<li> incorrect counts for the Question, Answer, Authority and Additional
                            Sections (although care should be taken where truncation is a
                            possibility).
</li>
</ul><p>
                
</p>
<p> Since dropped packets will cause the client to repeatedly retransmit the
                    original request, it is RECOMMENDED that proxies SHOULD instead return a
                    suitable DNS error response to the client (i.e. SERVFAIL) instead of dropping
                    the packet completely.
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>This document requests no IANA actions.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Change Log</h3>

<p>draft-ietf-dnsproxy-00 </p>
<blockquote class="text">
<p>Changed recommended DPI error to SERVFAIL (from Jelte)
</p>
<p>Changed example for invalid compression pointers (from Wouter).
</p>
<p>Note about TSIG implications of changing Query ID (from Wouter).
</p>
<p>Clarified TC-bit text (from Wouter)
</p>
<p>Extra text about proxy bypass (Nicholas W.)
</p>
</blockquote><p>
            
</p>
<p>draft-bellis-dnsproxy-00 </p>
<blockquote class="text">
<p>Initial draft
</p>
</blockquote><p>
            
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Acknowledgements</h3>

<p>The author would particularly like to acknowledge the assistance of Lisa Phifer of
                Core Competence. In addition the author is grateful for the feedback from the
                members of the DNSEXT Working Group.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-dnsext-forgery-resilience">[I-D.ietf-dnsext-forgery-resilience]</a></td>
<td class="author-text">Hubert, B. and R. Mook, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-dnsext-forgery-resilience-10.txt">Measures for making DNS more resilient against forged answers</a>,&rdquo; draft-ietf-dnsext-forgery-resilience-10 (work in progress), December&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-dnsext-forgery-resilience-10.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC0793">[RFC0793]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>,&rdquo; STD&nbsp;7, RFC&nbsp;793, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc793.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1035">[RFC1035]</a></td>
<td class="author-text">Mockapetris, P., &ldquo;<a href="http://tools.ietf.org/html/rfc1035">Domain names - implementation and specification</a>,&rdquo; STD&nbsp;13, RFC&nbsp;1035, November&nbsp;1987 (<a href="http://www.rfc-editor.org/rfc/rfc1035.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1123">[RFC1123]</a></td>
<td class="author-text"><a href="mailto:Braden@ISI.EDU">Braden, R.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1123">Requirements for Internet Hosts - Application and Support</a>,&rdquo; STD&nbsp;3, RFC&nbsp;1123, October&nbsp;1989 (<a href="http://www.rfc-editor.org/rfc/rfc1123.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2131">[RFC2131]</a></td>
<td class="author-text"><a href="mailto:droms@bucknell.edu">Droms, R.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2131">Dynamic Host Configuration Protocol</a>,&rdquo; RFC&nbsp;2131, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2131.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2131.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2131.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2132">[RFC2132]</a></td>
<td class="author-text"><a href="mailto:sca@engr.sgi.com">Alexander, S.</a> and <a href="mailto:droms@bucknell.edu">R. Droms</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2132">DHCP Options and BOOTP Vendor Extensions</a>,&rdquo; RFC&nbsp;2132, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2132.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2132.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2132.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2671">[RFC2671]</a></td>
<td class="author-text"><a href="mailto:vixie@isc.org">Vixie, P.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2671">Extension Mechanisms for DNS (EDNS0)</a>,&rdquo; RFC&nbsp;2671, August&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2671.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2845">[RFC2845]</a></td>
<td class="author-text">Vixie, P., Gudmundsson, O., Eastlake, D., and B. Wellington, &ldquo;<a href="http://tools.ietf.org/html/rfc2845">Secret Key Transaction Authentication for DNS (TSIG)</a>,&rdquo; RFC&nbsp;2845, May&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2845.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2930">[RFC2930]</a></td>
<td class="author-text">Eastlake, D., &ldquo;<a href="http://tools.ietf.org/html/rfc2930">Secret Key Establishment for DNS (TKEY RR)</a>,&rdquo; RFC&nbsp;2930, September&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2930.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3597">[RFC3597]</a></td>
<td class="author-text">Gustafsson, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3597">Handling of Unknown DNS Resource Record (RR) Types</a>,&rdquo; RFC&nbsp;3597, September&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3597.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4035">[RFC4035]</a></td>
<td class="author-text">Arends, R., Austein, R., Larson, M., Massey, D., and S. Rose, &ldquo;<a href="http://tools.ietf.org/html/rfc4035">Protocol Modifications for the DNS Security Extensions</a>,&rdquo; RFC&nbsp;4035, March&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4035.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5358">[RFC5358]</a></td>
<td class="author-text">Damas, J. and F. Neves, &ldquo;<a href="http://tools.ietf.org/html/rfc5358">Preventing Use of Recursive Nameservers in Reflector Attacks</a>,&rdquo; BCP&nbsp;140, RFC&nbsp;5358, October&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5358.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="DOTSE">[DOTSE]</a></td>
<td class="author-text">Ahlund and Wallstrom, &ldquo;<a href="http://www.iis.se/docs/Routertester_en.pdf">DNSSEC Tests of Consumer Broadband Routers</a>,&rdquo; February&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="SAC035">[SAC035]</a></td>
<td class="author-text">Bellis, R. and L. Phifer, &ldquo;<a href="http://www.icann.org/committees/security/sac035.pdf">Test Report: DNSSEC Impact on Broadband Routers and Firewalls</a>,&rdquo; September&nbsp;2008.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ray Bellis</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nominet UK</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Edmund Halley Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Oxford  OX4 4DQ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">United Kingdom</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+44 1865 332211</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ray.bellis@nominet.org.uk">ray.bellis@nominet.org.uk</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.nominet.org.uk/">http://www.nominet.org.uk/</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
