<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>OSCORE-capable Proxies</title>
<meta content="Marco Tiloca" name="author">
<meta content="Rikard Höglund" name="author">
<meta content="
       Object Security for Constrained RESTful Environments (OSCORE) can be used to protect CoAP messages end-to-end between two endpoints at the application layer, also in the presence of intermediaries such as proxies. This document defines how to use OSCORE for protecting CoAP messages also between an origin application endpoint and an intermediary, or between two intermediaries. Also, it defines how to secure a CoAP message by applying multiple, nested OSCORE protections, e.g., both end-to-end between origin application endpoints, as well as between an application endpoint and an intermediary or between two intermediaries. Thus, this document updates RFC 8613. The same approach can be seamlessly used with Group OSCORE, for protecting CoAP messages when group communication with intermediaries is used. 
    " name="description">
<meta content="xml2rfc 3.12.3" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-tiloca-core-oscore-capable-proxies-02" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.12.3
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.8.0
    MarkupSafe 2.0.1
    pycountry 22.1.10
    pyflakes 2.4.0
    PyYAML 6.0
    requests 2.27.1
    setuptools 59.6.0
    six 1.16.0
    WeasyPrint 52.5
-->
<link href="/tmp/draft-tiloca-core-oscore-capable-proxies-02-8w3147bt.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">OSCORE-capable Proxies</td>
<td class="right">March 2022</td>
</tr></thead>
<tfoot><tr>
<td class="left">Tiloca &amp; Höglund</td>
<td class="center">Expires 8 September 2022</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">CoRE Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-tiloca-core-oscore-capable-proxies-02</dd>
<dt class="label-updates">Updates:</dt>
<dd class="updates">
<a href="https://www.rfc-editor.org/rfc/rfc8613" class="eref">8613</a> (if approved)</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2022-03-07" class="published">7 March 2022</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2022-09-08">8 September 2022</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">M. Tiloca</div>
<div class="org">RISE AB</div>
</div>
<div class="author">
      <div class="author-name">R. Höglund</div>
<div class="org">RISE AB</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">OSCORE-capable Proxies</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">Object Security for Constrained RESTful Environments (OSCORE) can be used to protect CoAP messages end-to-end between two endpoints at the application layer, also in the presence of intermediaries such as proxies. This document defines how to use OSCORE for protecting CoAP messages also between an origin application endpoint and an intermediary, or between two intermediaries. Also, it defines how to secure a CoAP message by applying multiple, nested OSCORE protections, e.g., both end-to-end between origin application endpoints, as well as between an application endpoint and an intermediary or between two intermediaries. Thus, this document updates RFC 8613. The same approach can be seamlessly used with Group OSCORE, for protecting CoAP messages when group communication with intermediaries is used.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues-2">
<a href="#name-discussion-venues-2" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Discussion of this document takes place on the
  Constrained RESTful Environments Working Group mailing list (core@ietf.org),
  which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/core/">https://mailarchive.ietf.org/arch/browse/core/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">Source for this draft and an issue tracker can be found at
  <span><a href="https://gitlab.com/crimson84/draft-tiloca-core-oscore-to-proxies">https://gitlab.com/crimson84/draft-tiloca-core-oscore-to-proxies</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo-6">
<a href="#name-status-of-this-memo-6" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 8 September 2022.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice-6">
<a href="#name-copyright-notice-6" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2022 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents-6">
<a href="#name-table-of-contents-6" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction-6" class="xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-terminology-4" class="xref">Terminology</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-use-cases" class="xref">Use Cases</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1" class="keepWithNext"><a href="#section-2.1" class="xref">2.1</a>.  <a href="#name-coap-group-communication-wi" class="xref">CoAP Group Communication with Proxies</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="xref">2.2</a>.  <a href="#name-coap-observe-notifications-" class="xref">CoAP Observe Notifications over Multicast</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="xref">2.3</a>.  <a href="#name-lwm2m-client-and-external-a" class="xref">LwM2M Client and External Application Server</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4">
                <p id="section-toc.1-1.2.2.4.1"><a href="#section-2.4" class="xref">2.4</a>.  <a href="#name-further-use-cases" class="xref">Further Use Cases</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-message-processing" class="xref">Message Processing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-general-rules-on-protecting" class="xref">General Rules on Protecting Options</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-processing-an-outgoing-requ" class="xref">Processing an Outgoing Request</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="xref">3.3</a>.  <a href="#name-processing-an-incoming-requ" class="xref">Processing an Incoming Request</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="xref">3.4</a>.  <a href="#name-processing-an-outgoing-resp" class="xref">Processing an Outgoing Response</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="xref">3.5</a>.  <a href="#name-processing-an-incoming-resp" class="xref">Processing an Incoming Response</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-example-2" class="xref">Example</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-caching-of-oscore-protected" class="xref">Caching of OSCORE-Protected Responses</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-security-considerations-5" class="xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-iana-considerations-5" class="xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-references-5" class="xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-normative-references-5" class="xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-informative-references-6" class="xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#appendix-A" class="xref">Appendix A</a>.  <a href="#name-oscore-protected-onion-forw" class="xref">OSCORE-protected Onion Forwarding</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#appendix-B" class="xref"></a><a href="#name-acknowledgments-2" class="xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#appendix-C" class="xref"></a><a href="#name-authors-addresses-6" class="xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction-6">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction-6" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The Constrained Application Protocol (CoAP) <span>[<a href="#RFC7252" class="xref">RFC7252</a>]</span> supports the presence of intermediaries, such as forward-proxies and reverse-proxies, which assist origin clients by performing requests to origin servers on their behalf, and forwarding back the related responses.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">CoAP supports also group communication scenarios <span>[<a href="#I-D.ietf-core-groupcomm-bis" class="xref">I-D.ietf-core-groupcomm-bis</a>]</span>, where clients can send a one-to-many request targeting all the servers in the group, e.g., by using IP multicast. Like for one-to-one communication, group settings can also rely on intermediaries <span>[<a href="#I-D.tiloca-core-groupcomm-proxy" class="xref">I-D.tiloca-core-groupcomm-proxy</a>]</span>.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">The protocol Object Security for Constrained RESTful Environments (OSCORE) <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span> can be used to protect CoAP messages between two endpoints at the application layer, especially achieving end-to-end security in the presence of (non-trusted) intermediaries. When CoAP group communication is used, the same can be achieved by means of the protocol Group OSCORE <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span>.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">For a number of use cases (see <a href="#sec-use-cases" class="xref">Section 2</a>), it is required and/or beneficial that communications are secured also between an application endpoint (i.e., a CoAP origin client/server) and an intermediary, as well as between two adjacent intermediaries in a chain. This especially applies to the communication leg between the CoAP origin client and the adjacent intermediary acting as next hop towards the CoAP origin server.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">In such cases, and especially if the origin client already uses OSCORE to achieve end-to-end security with the origin server, it would be convenient that OSCORE is used also to secure communications between the origin client and its next hop. However, the original specification <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span> does not define how OSCORE can be used to protect CoAP messages in such communication leg, which would require to consider also the intermediary as an "OSCORE endpoint".<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">This document fills this gap, and updates <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span> as follows.<a href="#section-1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-7.1">It defines how to use OSCORE for protecting a CoAP message in the communication leg between: i) an origin client/server and an intermediary; or ii) two adjacent intermediaries in an intermediary chain. That is, besides origin clients/servers, it allows also intermediaries to be possible "OSCORE endpoints".<a href="#section-1-7.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-7.2">It admits a CoAP message to be secured by multiple, nested OSCORE protections applied in sequence, as an "OSCORE-in-OSCORE" process. For instance, this is the case when the message is OSCORE-protected end-to-end between the origin client and origin server, and the result is further OSCORE-protected over the leg between the current and next hop (e.g., the origin client and the adjacent intermediary acting as next hop towards the origin server).<a href="#section-1-7.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-1-8">This document does not specify any new signaling method to guide the message processing on the different endpoints. In particular, every endpoint is always able to understand what steps to take on an incoming message depending on the presence of the OSCORE Option, as exclusively included or instead combined together with CoAP options intended for an intermediary.<a href="#section-1-8" class="pilcrow">¶</a></p>
<p id="section-1-9">The approach defined in this document can be seamlessly adopted also when Group OSCORE is used, for protecting CoAP messages in group communication scenarios that rely on intermediaries.<a href="#section-1-9" class="pilcrow">¶</a></p>
<div id="terminology">
<section id="section-1.1">
        <h3 id="name-terminology-4">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-terminology-4" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.1-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they appear in all capitals, as shown here.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">Readers are expected to be familiar with the terms and concepts related to CoAP <span>[<a href="#RFC7252" class="xref">RFC7252</a>]</span>; OSCORE <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span> and Group OSCORE <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span>. This document especially builds on concepts and mechanics related to intermediaries such as CoAP forward-proxies.<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<p id="section-1.1-3">In addition, this document uses the following terms.<a href="#section-1.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-4.1">Source application endpoint: an origin client producing a request, or an origin server producing a response.<a href="#section-1.1-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.2">Destination application endpoint: an origin server intended to consume a request, or an origin client intended to consume a response.<a href="#section-1.1-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.3">Application endpoint: a source or destination application endpoint.<a href="#section-1.1-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.4">Source OSCORE endpoint: an endpoint protecting a message with OSCORE or Group OSCORE.<a href="#section-1.1-4.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.5">Destination OSCORE endpoint: an endpoint unprotecting a message with OSCORE or Group OSCORE.<a href="#section-1.1-4.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.6">OSCORE endpoint: a source/destination OSCORE endpoint. An OSCORE endpoint is not necessarily also an application endpoint with respect to a certain message.<a href="#section-1.1-4.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.7">Proxy-related option: the Proxy-URI Option, the Proxy-Scheme Option, or any of the Uri-* Options.<a href="#section-1.1-4.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-4.8">OSCORE-in-OSCORE: the process by which a message protected with (Group) OSCORE is further protected with (Group) OSCORE. This means that, if such a process is used, a successful decryption/verification of an OSCORE-protected message might yield an OSCORE-protected message.<a href="#section-1.1-4.8" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="sec-use-cases">
<section id="section-2">
      <h2 id="name-use-cases">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-use-cases" class="section-name selfRef">Use Cases</a>
      </h2>
<p id="section-2-1">The approach proposed in this document has been motivated by a number of use cases, which are summarized below.<a href="#section-2-1" class="pilcrow">¶</a></p>
<div id="ssec-uc1">
<section id="section-2.1">
        <h3 id="name-coap-group-communication-wi">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-coap-group-communication-wi" class="section-name selfRef">CoAP Group Communication with Proxies</a>
        </h3>
<p id="section-2.1-1">CoAP supports also one-to-many group communication, e.g., over IP multicast <span>[<a href="#I-D.ietf-core-groupcomm-bis" class="xref">I-D.ietf-core-groupcomm-bis</a>]</span>, which can be protected end-to-end between origin client and origin servers by using Group OSCORE <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span>.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<p id="section-2.1-2">This communication model can be assisted by intermediaries such as a CoAP forward-proxy or reverse-proxy, which relays a group request to the origin servers. If Group OSCORE is used, the proxy is intentionally not a member of the OSCORE group. Furthermore, <span>[<a href="#I-D.tiloca-core-groupcomm-proxy" class="xref">I-D.tiloca-core-groupcomm-proxy</a>]</span> defines a signaling protocol between origin client and proxy, to ensure that responses from the different origin servers are forwarded back to the origin client within a time interval set by the client, and that they can be distinguished from one another.<a href="#section-2.1-2" class="pilcrow">¶</a></p>
<p id="section-2.1-3">In particular, it is required that the proxy identifies the origin client as allowed-listed, before forwarding a group request to the servers (see <span><a href="https://datatracker.ietf.org/doc/html/draft-tiloca-core-groupcomm-proxy-06#section-4" class="relref">Section 4</a> of [<a href="#I-D.tiloca-core-groupcomm-proxy" class="xref">I-D.tiloca-core-groupcomm-proxy</a>]</span>). This requires a security association between the origin client and the proxy, which would be convenient to provide with a dedicated OSCORE Security Context between the two, since the client is possibly using also Group OSCORE with the origin servers.<a href="#section-2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ssec-uc2">
<section id="section-2.2">
        <h3 id="name-coap-observe-notifications-">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-coap-observe-notifications-" class="section-name selfRef">CoAP Observe Notifications over Multicast</a>
        </h3>
<p id="section-2.2-1">The Observe extension for CoAP <span>[<a href="#RFC7641" class="xref">RFC7641</a>]</span> allows a client to register its interest in "observing" a resource at a server. The server can then send back notification responses upon changes to the resource representation, all matching with the original observation request.<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<p id="section-2.2-2">In some applications, such as pub-sub <span>[<a href="#I-D.ietf-core-coap-pubsub" class="xref">I-D.ietf-core-coap-pubsub</a>]</span>, multiple clients are interested to observe the same resource at the same server. Hence, <span>[<a href="#I-D.ietf-core-observe-multicast-notifications" class="xref">I-D.ietf-core-observe-multicast-notifications</a>]</span> defines a method that allows the server to send a multicast notification to all the observer clients at once, e.g., over IP multicast. To this end, the server synchronizes the clients by providing them with a common "phantom observation request", against which the following multicast notifications will match.<a href="#section-2.2-2" class="pilcrow">¶</a></p>
<p id="section-2.2-3">In case the clients and the server use Group OSCORE for end-to-end security and a proxy is also involved, an additional step is required (see <span><a href="https://datatracker.ietf.org/doc/html/draft-ietf-core-observe-multicast-notifications-03#section-10" class="relref">Section 10</a> of [<a href="#I-D.ietf-core-observe-multicast-notifications" class="xref">I-D.ietf-core-observe-multicast-notifications</a>]</span>). That is, clients are in turn required to provide the proxy with the obtained "phantom observation request", thus enabling the proxy to receive the multicast notifications from the server.<a href="#section-2.2-3" class="pilcrow">¶</a></p>
<p id="section-2.2-4">Therefore, it is preferable to have a security associations also between each client and the proxy, to especially ensure the integrity of that information provided to the proxy (see <span><a href="https://datatracker.ietf.org/doc/html/draft-ietf-core-observe-multicast-notifications-03#section-13.3" class="relref">Section 13.3</a> of [<a href="#I-D.ietf-core-observe-multicast-notifications" class="xref">I-D.ietf-core-observe-multicast-notifications</a>]</span>). Like for the use case in <a href="#ssec-uc1" class="xref">Section 2.1</a>, this would be conveniently achieved with a dedicated OSCORE Security Context between a client and the proxy, since the client is also using Group OSCORE with the origin server.<a href="#section-2.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ssec-uc3">
<section id="section-2.3">
        <h3 id="name-lwm2m-client-and-external-a">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-lwm2m-client-and-external-a" class="section-name selfRef">LwM2M Client and External Application Server</a>
        </h3>
<p id="section-2.3-1">The Lightweight Machine-to-Machine (LwM2M) protocol <span>[<a href="#LwM2M-Core" class="xref">LwM2M-Core</a>]</span> enables a LwM2M Client device to securely bootstrap and then register at a LwM2M Server, with which it will perform most of its following communication exchanges. As per the transport bindings specification of LwM2M <span>[<a href="#LwM2M-Transport" class="xref">LwM2M-Transport</a>]</span>, the LwM2M Client and LwM2M Server can use CoAP and OSCORE to secure their communications at the application layer, including during the device registration process.<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<p id="section-2.3-2">Furthermore, Section 5.5.1 of <span>[<a href="#LwM2M-Transport" class="xref">LwM2M-Transport</a>]</span> specifies that: "OSCORE MAY also be used between LwM2M endpoint and non-LwM2M endpoint, e.g., between an Application Server and a LwM2M Client via a LwM2M server. Both the LwM2M endpoint and non-LwM2M endpoint MUST implement OSCORE and be provisioned with an OSCORE Security Context."<a href="#section-2.3-2" class="pilcrow">¶</a></p>
<p id="section-2.3-3">In such a case, the LwM2M Server can practically act as forward-proxy between the LwM2M Client and the external Application Server. At the same time, the LwM2M Client and LwM2M Server must continue protecting communications on their leg using their Security Context. Like for the use case in <a href="#ssec-uc1" class="xref">Section 2.1</a>, this also allows the LwM2M Server to identify the LwM2M Client, before forwarding its request outside the LwM2M domain and towards the external Application Server.<a href="#section-2.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="further-use-cases">
<section id="section-2.4">
        <h3 id="name-further-use-cases">
<a href="#section-2.4" class="section-number selfRef">2.4. </a><a href="#name-further-use-cases" class="section-name selfRef">Further Use Cases</a>
        </h3>
<p id="section-2.4-1">The approach proposed in this document can be useful also in the following use cases relying on a proxy.<a href="#section-2.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.4-2.1">
            <p id="section-2.4-2.1.1">A server aware of a suitable cross proxy can rely on it as a third-party service, in order to indicate transports for CoAP available to that server (see see <span><a href="https://datatracker.ietf.org/doc/html/draft-amsuess-core-transport-indication-03#section-4" class="relref">Section 4</a> of [<a href="#I-D.amsuess-core-transport-indication" class="xref">I-D.amsuess-core-transport-indication</a>]</span>).<a href="#section-2.4-2.1.1" class="pilcrow">¶</a></p>
<p id="section-2.4-2.1.2">
From a security point of view, it would be convenient if the proxy could provide suitable credentials to the client, as a general trusted proxy for the system. However, in order for OSCORE to be an applicable security mechanism for this, it has to be terminated at the proxy. That is, it would be required for the client and the proxy to share a dedicated OSCORE Security Context and to use it for protecting their communication leg.<a href="#section-2.4-2.1.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-2.4-2.2">A proxy may be deployed to act as an entry point to a firewalled network, which only authenticated clients can join. In particular, authentication can rely on the used secure communication association between a client and the proxy. If the proxy could share a dedicated OSCORE Security Context with each client, the proxy can rely on it to identify the client, before forwarding its messages to any other member of the firewalled network.<a href="#section-2.4-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.4-2.3">The approach proposed in this document does not pose a limit to the number of OSCORE protections applied to the same CoAP message. This enables more privacy-oriented scenarios based on proxy chains, where the origin endpoint protects a message using first the OSCORE Security Context shared with the origin server, and then the dedicated OSCORE Security Context shared with each of the different chain hops. Once received at a chain hop, a message would be stripped of the OSCORE protection associated with that hop before being forwarded to the next one.<a href="#section-2.4-2.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="sec-message-processing">
<section id="section-3">
      <h2 id="name-message-processing">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-message-processing" class="section-name selfRef">Message Processing</a>
      </h2>
<p id="section-3-1">As mentioned in <a href="#intro" class="xref">Section 1</a>, this document introduces the following two main deviations from the original OSCORE specification <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span>.<a href="#section-3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3-2">
<li id="section-3-2.1">
          <p id="section-3-2.1.1">An "OSCORE endpoint", i.e., a producer/consumer of an OSCORE Option can be not only an application endpoint (i.e., an origin client or server), but also an intermediary such as a proxy.<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
<p id="section-3-2.1.2">
Hence, OSCORE can also be used between an origin client/server and a proxy, as well as between two proxies in an intermediary chain.<a href="#section-3-2.1.2" class="pilcrow">¶</a></p>
</li>
        <li id="section-3-2.2">
          <p id="section-3-2.2.1">A CoAP message can be secured by multiple OSCORE protections applied in sequence. Therefore, the final result is a message with nested OSCORE protections, as the output of an "OSCORE-in-OSCORE" process. Hence, following a decryption, the resulting message might legitimately include an OSCORE Option, and thus have in turn to be decrypted.<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
<p id="section-3-2.2.2">
The most common case is expected to consider a message protected with up to two OSCORE layers, i.e.: i) an inner layer, protecting the message end-to-end between the origin client and the origin server acting as application endpoints; and ii) an outer layer, protecting the message between a certain OSCORE endpoint and the other OSCORE endpoint adjacent in the intermediary chain.<a href="#section-3-2.2.2" class="pilcrow">¶</a></p>
<p id="section-3-2.2.3">
However, a message can also be protected with a higher arbitrary number of nested OSCORE layers, e.g., in scenarios relying on a longer chain of intermediaries. For instance, the origin client can sequentially apply multiple OSCORE layers to a request, each of which to be consumed and removed by one of the intermediaries in the chain, until the origin server is reached and it consumes the innermost OSCORE layer.<a href="#section-3-2.2.3" class="pilcrow">¶</a></p>
</li>
      </ol>
<div id="general-rules">
<section id="section-3.1">
        <h3 id="name-general-rules-on-protecting">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-general-rules-on-protecting" class="section-name selfRef">General Rules on Protecting Options</a>
        </h3>
<p id="section-3.1-1">When a sender endpoint protects an outgoing message by applying the i-th OSCORE layer in sequence, the following CoAP options are also protected, in addition to those already specified as class I or class E in the document defining them.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-2.1">An OSCORE Option which is present as the result of the j-th OSCORE layer immediately previously applied, i.e., j = (i-1). Such an OSCORE Option is protected like an option of class E.<a href="#section-3.1-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-2.2">
            <p id="section-3.1-2.2.1">Any option such that both the following conditions hold.<a href="#section-3.1-2.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.1-2.2.2">
<li id="section-3.1-2.2.2.1">The option is intended to be consumed by the other OSCORE endpoint X sharing the OSCORE Security Context used for applying the i-th OSCORE layer.<a href="#section-3.1-2.2.2.1" class="pilcrow">¶</a>
</li>
              <li id="section-3.1-2.2.2.2">The option does not play a role at the other OSCORE endpoint X for correctly processing the message before having removed the i-th OSCORE layer.<a href="#section-3.1-2.2.2.2" class="pilcrow">¶</a>
</li>
            </ol>
<p id="section-3.1-2.2.3">
Examples of such options are:<a href="#section-3.1-2.2.3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-2.2.4.1">The proxy-related options Proxy-Uri, Proxy-Scheme and Uri-* defined in <span>[<a href="#RFC7252" class="xref">RFC7252</a>]</span>.<a href="#section-3.1-2.2.4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-3.1-2.2.4.2">Listen-To-Multicast-Notifications defined in <span>[<a href="#I-D.ietf-core-observe-multicast-notifications" class="xref">I-D.ietf-core-observe-multicast-notifications</a>]</span>.<a href="#section-3.1-2.2.4.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-3.1-2.2.4.3">Multicast-Timeout, Response-Forwarding and Group-ETag defined in <span>[<a href="#I-D.tiloca-core-groupcomm-proxy" class="xref">I-D.tiloca-core-groupcomm-proxy</a>]</span>.<a href="#section-3.1-2.2.4.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
        </ul>
<p id="section-3.1-3">One the other hand, when applying the i-th OSCORE layer, an option intended to the endpoint X is not protected if it plays a role for removing the i-th OSCORE layer at that endpoint. Examples of such options are:<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-4.1">Clearly, and consistently with <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span>, the OSCORE option added to the outgoing message as a result of applying the i-th OSCORE layer.<a href="#section-3.1-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-4.2">The EDHOC option defined in <span>[<a href="#I-D.ietf-core-oscore-edhoc" class="xref">I-D.ietf-core-oscore-edhoc</a>]</span>, to signal to the endpoint X that part of the message payload has to be extracted and used to complete an ongoing execution of the EDHOC key establishment protocol <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>, before the i-th OSCORE layer can be removed.<a href="#section-3.1-4.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="outgoing-requests">
<section id="section-3.2">
        <h3 id="name-processing-an-outgoing-requ">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-processing-an-outgoing-requ" class="section-name selfRef">Processing an Outgoing Request</a>
        </h3>
<p id="section-3.2-1">The rules from <a href="#general-rules" class="xref">Section 3.1</a> apply when processing an outgoing request message, with the following addition.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">When an application endpoint applies multiple OSCORE layers in sequence to protect an outgoing request, and it uses an OSCORE Security Context shared with the other application endpoint, then the first OSCORE layer MUST be applied by using that Security Context.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="incoming-requests">
<section id="section-3.3">
        <h3 id="name-processing-an-incoming-requ">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-processing-an-incoming-requ" class="section-name selfRef">Processing an Incoming Request</a>
        </h3>
<p id="section-3.3-1">The recipient endpoint performs the following actions on the received request REQ, depending on which of the following three conditions apply.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3-2.1">
            <p id="section-3.3-2.1.1">A - REQ includes visible proxy-related options.<a href="#section-3.3-2.1.1" class="pilcrow">¶</a></p>
<p id="section-3.3-2.1.2">
If the endpoint is not configured to be a proxy, it MUST stop processing the request and MUST respond with a 5.05 (Proxying Not Supported) error response to (the previous hop towards) the origin client, as per <span><a href="https://rfc-editor.org/rfc/rfc7252#section-5.10.2" class="relref">Section 5.10.2</a> of [<a href="#RFC7252" class="xref">RFC7252</a>]</span>. This may result in protecting the error response over that communication leg, as per <a href="#outgoing-responses" class="xref">Section 3.4</a>.<a href="#section-3.3-2.1.2" class="pilcrow">¶</a></p>
<p id="section-3.3-2.1.3">
Otherwise, the endpoint consumes the proxy-related options and forwards REQ to (the next hop towards) the origin server. This may result in (further) protecting REQ over that communication leg, as per <a href="#outgoing-requests" class="xref">Section 3.2</a>.<a href="#section-3.3-2.1.3" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-2.2">
            <p id="section-3.3-2.2.1">B - REQ does not include proxy-related options and does not include an OSCORE Option.<a href="#section-3.3-2.2.1" class="pilcrow">¶</a></p>
<p id="section-3.3-2.2.2">
If the endpoint does not have an application to handle REQ, it MUST stop processing the request and MAY respond with a 4.00 (Bad Request) error response to (the previous hop towards) the origin client. This may result in protecting the error response over that communication leg, as per <a href="#outgoing-responses" class="xref">Section 3.4</a>.<a href="#section-3.3-2.2.2" class="pilcrow">¶</a></p>
<p id="section-3.3-2.2.3">
Otherwise, the endpoint delivers REQ to the application.<a href="#section-3.3-2.2.3" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-2.3">
            <p id="section-3.3-2.3.1">C - REQ does not include proxy-related options and includes an OSCORE Option.<a href="#section-3.3-2.3.1" class="pilcrow">¶</a></p>
<p id="section-3.3-2.3.2">
The endpoint decrypts REQ using the OSCORE Security Context indicated by the OSCORE Option, i.e., REQ* = dec(REQ). After that, the possible presence of an OSCORE Option in the decrypted request REQ* is not treated as an error situation.<a href="#section-3.3-2.3.2" class="pilcrow">¶</a></p>
<p id="section-3.3-2.3.3">
If the OSCORE processing results in an error, the endpoint MUST stop processing the request and performs error handling as per <span><a href="https://rfc-editor.org/rfc/rfc8613#section-8.2" class="relref">Section 8.2</a> of [<a href="#RFC8613" class="xref">RFC8613</a>]</span> or Sections <a href="https://datatracker.ietf.org/doc/html/draft-ietf-core-oscore-groupcomm-14#section-8.2" class="relref">8.2</a> and <a href="https://datatracker.ietf.org/doc/html/draft-ietf-core-oscore-groupcomm-14#section-9.4" class="relref">9.4</a> of <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span>, in case OSCORE or Group OSCORE is used, respectively. In case the endpoint sends an error response to (the previous hop towards) the origin client, this may result in protecting the error response over that communication leg, as per <a href="#outgoing-responses" class="xref">Section 3.4</a>.<a href="#section-3.3-2.3.3" class="pilcrow">¶</a></p>
<p id="section-3.3-2.3.4">
Otherwise, REQ takes REQ*, and the endpoint evaluates which of the three conditions (A, B, C) applies to REQ, thus performing again the algorithm defined in this section.<a href="#section-3.3-2.3.4" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="outgoing-responses">
<section id="section-3.4">
        <h3 id="name-processing-an-outgoing-resp">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-processing-an-outgoing-resp" class="section-name selfRef">Processing an Outgoing Response</a>
        </h3>
<p id="section-3.4-1">The rules from <a href="#general-rules" class="xref">Section 3.1</a> apply when processing an outgoing response message, with the following additions.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<p id="section-3.4-2">When an application endpoint applies multiple OSCORE layers in sequence to protect an outgoing response, and it uses an OSCORE Security Context shared with the other application endpoint, then the first OSCORE layer MUST be applied by using that Security Context.<a href="#section-3.4-2" class="pilcrow">¶</a></p>
<p id="section-3.4-3">The sender endpoint protects the response by applying the same OSCORE layers that it removed from the corresponding incoming request, but in the reverse order than the one they were removed.<a href="#section-3.4-3" class="pilcrow">¶</a></p>
<p id="section-3.4-4">In case the response is an error response, the sender endpoint protects it by applying the same OSCORE layers that it successfully removed from the corresponding incoming request, but in the reverse order than the one they were removed.<a href="#section-3.4-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="incoming-responses">
<section id="section-3.5">
        <h3 id="name-processing-an-incoming-resp">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-processing-an-incoming-resp" class="section-name selfRef">Processing an Incoming Response</a>
        </h3>
<p id="section-3.5-1">The recipient endpoint removes the same OSCORE layers that it added when protecting the corresponding outgoing request, but in the reverse order than the one they were removed.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">When doing so, the possible presence of an OSCORE Option in the decrypted response following the removal of an OSCORE layer is not treated as an error situation, unless it occurs after having removed as many OSCORE layers as were added in the outgoing request. In such a case, the endpoint MUST stop processing the response.<a href="#section-3.5-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="sec-example">
<section id="section-4">
      <h2 id="name-example-2">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-example-2" class="section-name selfRef">Example</a>
      </h2>
<p id="section-4-1">TODO: add example with message exchange.<a href="#section-4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sec-response-caching">
<section id="section-5">
      <h2 id="name-caching-of-oscore-protected">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-caching-of-oscore-protected" class="section-name selfRef">Caching of OSCORE-Protected Responses</a>
      </h2>
<p id="section-5-1">Although not possible as per the original OSCORE specification <span>[<a href="#RFC8613" class="xref">RFC8613</a>]</span>, cacheability of OSCORE-protected responses at proxies can be achieved. To this end, the approach defined in <span>[<a href="#I-D.amsuess-core-cachable-oscore" class="xref">I-D.amsuess-core-cachable-oscore</a>]</span> can be used, as based on Deterministic Requests protected with the pairwise mode of Group OSCORE <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span> used end-to-end between an origin client and an origin server. The applicability of this approach is limited to requests that are safe (in the RESTful sense) to process and do not yield side effects at the origin server.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">In particular, both the origin client and the origin server are required to have already joined the correct OSCORE group. Then, starting from the same plain CoAP request, different clients in the OSCORE group are able to deterministically generate a same request protected with Group OSCORE, which is sent to a proxy for being forwarded to the origin server. The proxy can now effectively cache the resulting OSCORE-protected response from the server, since the same plain CoAP request will result again in the same Deterministic Request and thus will produce a cache hit.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">If the approach defined in <span>[<a href="#I-D.amsuess-core-cachable-oscore" class="xref">I-D.amsuess-core-cachable-oscore</a>]</span> is used, the following also applies in addition to what is defined in <a href="#sec-message-processing" class="xref">Section 3</a>, when processing incoming messages at a proxy that implements caching of responses.<a href="#section-5-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-4.1">
          <p id="section-5-4.1.1">Upon receiving a request from (the previous hop towards) the origin client, the proxy checks if specifically the message available during the execution of alternative A in <a href="#incoming-requests" class="xref">Section 3.3</a> produces a cache hit.<a href="#section-5-4.1.1" class="pilcrow">¶</a></p>
<p id="section-5-4.1.2">
That is, such a message: i) is exactly the one to be forwarded to (the next hop towards) the origin server if no cache hit is made; and ii) is the result of an OSCORE decryption at the proxy, if OSCORE is used on the communication leg between the proxy and (the previous hop towards) the origin client.<a href="#section-5-4.1.2" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-4.2">
          <p id="section-5-4.2.1">Upon receiving a response from (the next hop towards) the origin server, the proxy first removes the same OSCORE layers that it added when protecting the corresponding outgoing request, as defined in <a href="#incoming-responses" class="xref">Section 3.5</a>.<a href="#section-5-4.2.1" class="pilcrow">¶</a></p>
<p id="section-5-4.2.2">
Then, the proxy stores specifically that resulting response message in its cache. That is, such a message is exactly the one to be forwarded to (the previous hop towards) the origin client.<a href="#section-5-4.2.2" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-5-5">The specific rules about serving a request with a cached response are defined in <span><a href="https://rfc-editor.org/rfc/rfc7252#section-5.6" class="relref">Section 5.6</a> of [<a href="#RFC7252" class="xref">RFC7252</a>]</span>, as well as in <span><a href="https://datatracker.ietf.org/doc/html/draft-tiloca-core-groupcomm-proxy-06#section-7" class="relref">Section 7</a> of [<a href="#I-D.tiloca-core-groupcomm-proxy" class="xref">I-D.tiloca-core-groupcomm-proxy</a>]</span> for group communication scenarios.<a href="#section-5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-6">
      <h2 id="name-security-considerations-5">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations-5" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-6-1">TODO<a href="#section-6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-7">
      <h2 id="name-iana-considerations-5">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-iana-considerations-5" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-7-1">This document has no actions for IANA.<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-8">
      <h2 id="name-references-5">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-references-5" class="section-name selfRef">References</a>
      </h2>
<section id="section-8.1">
        <h3 id="name-normative-references-5">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-normative-references-5" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-core-oscore-groupcomm">[I-D.ietf-core-oscore-groupcomm]</dt>
        <dd>
<span class="refAuthor">Tiloca, M.</span>, <span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Palombini, F.</span>, <span class="refAuthor">Mattsson, J. P.</span>, and <span class="refAuthor">J. Park</span>, <span class="refTitle">"Group OSCORE - Secure Group Communication for CoAP"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-oscore-groupcomm-14</span>, <time datetime="2022-03-07" class="refDate">7 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-core-oscore-groupcomm-14.txt">https://www.ietf.org/archive/id/draft-ietf-core-oscore-groupcomm-14.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7252">[RFC7252]</dt>
        <dd>
<span class="refAuthor">Shelby, Z.</span>, <span class="refAuthor">Hartke, K.</span>, and <span class="refAuthor">C. Bormann</span>, <span class="refTitle">"The Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7252</span>, <span class="seriesInfo">DOI 10.17487/RFC7252</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7252">https://www.rfc-editor.org/info/rfc7252</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8613">[RFC8613]</dt>
      <dd>
<span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Mattsson, J.</span>, <span class="refAuthor">Palombini, F.</span>, and <span class="refAuthor">L. Seitz</span>, <span class="refTitle">"Object Security for Constrained RESTful Environments (OSCORE)"</span>, <span class="seriesInfo">RFC 8613</span>, <span class="seriesInfo">DOI 10.17487/RFC8613</span>, <time datetime="2019-07" class="refDate">July 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8613">https://www.rfc-editor.org/info/rfc8613</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-8.2">
        <h3 id="name-informative-references-6">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-informative-references-6" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.amsuess-core-cachable-oscore">[I-D.amsuess-core-cachable-oscore]</dt>
        <dd>
<span class="refAuthor">Amsüss, C.</span> and <span class="refAuthor">M. Tiloca</span>, <span class="refTitle">"Cacheable OSCORE"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-amsuess-core-cachable-oscore-04</span>, <time datetime="2022-03-06" class="refDate">6 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-amsuess-core-cachable-oscore-04.txt">https://www.ietf.org/archive/id/draft-amsuess-core-cachable-oscore-04.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.amsuess-core-transport-indication">[I-D.amsuess-core-transport-indication]</dt>
        <dd>
<span class="refAuthor">Amsüss, C.</span>, <span class="refTitle">"CoAP Protocol Indication"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-amsuess-core-transport-indication-03</span>, <time datetime="2022-03-03" class="refDate">3 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-amsuess-core-transport-indication-03.txt">https://www.ietf.org/archive/id/draft-amsuess-core-transport-indication-03.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-coap-pubsub">[I-D.ietf-core-coap-pubsub]</dt>
        <dd>
<span class="refAuthor">Koster, M.</span>, <span class="refAuthor">Keranen, A.</span>, and <span class="refAuthor">J. Jimenez</span>, <span class="refTitle">"Publish-Subscribe Broker for the Constrained Application Protocol (CoAP)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-coap-pubsub-09</span>, <time datetime="2019-09-30" class="refDate">30 September 2019</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-core-coap-pubsub-09.txt">https://www.ietf.org/archive/id/draft-ietf-core-coap-pubsub-09.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-groupcomm-bis">[I-D.ietf-core-groupcomm-bis]</dt>
        <dd>
<span class="refAuthor">Dijk, E.</span>, <span class="refAuthor">Wang, C.</span>, and <span class="refAuthor">M. Tiloca</span>, <span class="refTitle">"Group Communication for the Constrained Application Protocol (CoAP)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-groupcomm-bis-06</span>, <time datetime="2022-03-07" class="refDate">7 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-core-groupcomm-bis-06.txt">https://www.ietf.org/archive/id/draft-ietf-core-groupcomm-bis-06.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-observe-multicast-notifications">[I-D.ietf-core-observe-multicast-notifications]</dt>
        <dd>
<span class="refAuthor">Tiloca, M.</span>, <span class="refAuthor">Höglund, R.</span>, <span class="refAuthor">Amsüss, C.</span>, and <span class="refAuthor">F. Palombini</span>, <span class="refTitle">"Observe Notifications as CoAP Multicast Responses"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-observe-multicast-notifications-03</span>, <time datetime="2022-03-07" class="refDate">7 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-core-observe-multicast-notifications-03.txt">https://www.ietf.org/archive/id/draft-ietf-core-observe-multicast-notifications-03.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-oscore-edhoc">[I-D.ietf-core-oscore-edhoc]</dt>
        <dd>
<span class="refAuthor">Palombini, F.</span>, <span class="refAuthor">Tiloca, M.</span>, <span class="refAuthor">Hoeglund, R.</span>, <span class="refAuthor">Hristozov, S.</span>, and <span class="refAuthor">G. Selander</span>, <span class="refTitle">"Profiling EDHOC for CoAP and OSCORE"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-oscore-edhoc-03</span>, <time datetime="2022-03-07" class="refDate">7 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-core-oscore-edhoc-03.txt">https://www.ietf.org/archive/id/draft-ietf-core-oscore-edhoc-03.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-lake-edhoc">[I-D.ietf-lake-edhoc]</dt>
        <dd>
<span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Mattsson, J. P.</span>, and <span class="refAuthor">F. Palombini</span>, <span class="refTitle">"Ephemeral Diffie-Hellman Over COSE (EDHOC)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-lake-edhoc-12</span>, <time datetime="2021-10-20" class="refDate">20 October 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-lake-edhoc-12.txt">https://www.ietf.org/archive/id/draft-ietf-lake-edhoc-12.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.tiloca-core-groupcomm-proxy">[I-D.tiloca-core-groupcomm-proxy]</dt>
        <dd>
<span class="refAuthor">Tiloca, M.</span> and <span class="refAuthor">E. Dijk</span>, <span class="refTitle">"Proxy Operations for CoAP Group Communication"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-tiloca-core-groupcomm-proxy-06</span>, <time datetime="2022-03-07" class="refDate">7 March 2022</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-tiloca-core-groupcomm-proxy-06.txt">https://www.ietf.org/archive/id/draft-tiloca-core-groupcomm-proxy-06.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="LwM2M-Core">[LwM2M-Core]</dt>
        <dd>
<span class="refAuthor">Open Mobile Alliance</span>, <span class="refTitle">"Lightweight Machine to Machine Technical Specification - Core, Approved Version 1.2, OMA-TS-LightweightM2M_Core-V1_2-20201110-A"</span>, <time datetime="2020-11" class="refDate">November 2020</time>, <span>&lt;<a href="http://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/OMA-TS-LightweightM2M_Core-V1_2-20201110-A.pdf">http://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/OMA-TS-LightweightM2M_Core-V1_2-20201110-A.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="LwM2M-Transport">[LwM2M-Transport]</dt>
        <dd>
<span class="refAuthor">Open Mobile Alliance</span>, <span class="refTitle">"Lightweight Machine to Machine Technical Specification - Transport Bindings, Approved Version 1.2, OMA-TS-LightweightM2M_Transport-V1_2-20201110-A"</span>, <time datetime="2020-11" class="refDate">November 2020</time>, <span>&lt;<a href="http://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/OMA-TS-LightweightM2M_Transport-V1_2-20201110-A.pdf">http://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/OMA-TS-LightweightM2M_Transport-V1_2-20201110-A.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7641">[RFC7641]</dt>
      <dd>
<span class="refAuthor">Hartke, K.</span>, <span class="refTitle">"Observing Resources in the Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7641</span>, <span class="seriesInfo">DOI 10.17487/RFC7641</span>, <time datetime="2015-09" class="refDate">September 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7641">https://www.rfc-editor.org/info/rfc7641</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="onion-forwarding">
<section id="appendix-A">
      <h2 id="name-oscore-protected-onion-forw">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-oscore-protected-onion-forw" class="section-name selfRef">OSCORE-protected Onion Forwarding</a>
      </h2>
<p id="appendix-A-1">TODO: better elaborate on the listed points below.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.1">The client can hide its position in the network from the origin server, while still possibly protecting communications end-to-end with OSCORE.<a href="#appendix-A-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-2.2">Use the method defined in <a href="#sec-message-processing" class="xref">Section 3</a> to achieve OSCORE-protected onion forwarding, through a chain of proxies (at least three are expected). Every message generated by or intended to the origin client must traverse the whole chain of proxies until the intended other endpoint (typically, the origin server). The chain of proxies has to be known in advance by the client, i.e., the exact proxies and their order in the chain.<a href="#appendix-A-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-2.3">
          <p id="appendix-A-2.3.1">The typical case addressed in this document considers an origin client that, at most, shares one OSCORE Security Context with the origin server and one OSCORE Security Context with the first proxy in the chain.<a href="#appendix-A-2.3.1" class="pilcrow">¶</a></p>
<p id="appendix-A-2.3.2">
If onion forwarding is used, the origin client shares an OSCORE Security Context with the origin server, and a dedicated OSCORE Security Context with each of the proxies in the chain.<a href="#appendix-A-2.3.2" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.4">
          <p id="appendix-A-2.4.1">The origin client protects a request by applying first the OSCORE layer intended to the origin server, then the OSCORE layer intended to the last proxy in the chain, then the OSCORE layer intended to the second from last proxy in the chain and so on, until it applies the OSCORE layer intended to the first proxy in the chain.<a href="#appendix-A-2.4.1" class="pilcrow">¶</a></p>
<p id="appendix-A-2.4.2">
Before protecting a request with the OSCORE layer to be consumed by a certain proxy in the chain, the origin client also adds proxy-related options intended to that proxy, as indications to forward the request to (the next hop towards) the origin server.<a href="#appendix-A-2.4.2" class="pilcrow">¶</a></p>
<p id="appendix-A-2.4.3">
Other than the actions above from the client, there should be no difference from the basic approach defined in <a href="#sec-message-processing" class="xref">Section 3</a>. Each proxy in the chain would process and remove one OSCORE layer from the received request and then forward it to (the next hop towards) the origin server.<a href="#appendix-A-2.4.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.5">
          <p id="appendix-A-2.5.1">The exact way used by the client to establish OSCORE Security Contexts with the proxies and the origin server is out of scope.<a href="#appendix-A-2.5.1" class="pilcrow">¶</a></p>
<p id="appendix-A-2.5.2">
However, if EDHOC is used, it is most convenient for the client to run it with the first proxy in the chain, then with the second proxy in the chain through the first one and so on, and finally with the origin server by traversing the whole chain of proxies.<a href="#appendix-A-2.5.2" class="pilcrow">¶</a></p>
<p id="appendix-A-2.5.3">
Then, it is especially convenient to use the optimized workflow defined in <span>[<a href="#I-D.ietf-core-oscore-edhoc" class="xref">I-D.ietf-core-oscore-edhoc</a>]</span> and based on the EDHOC + OSCORE request. This would basically allow the client to complete the EDHOC execution with an endpoint and start the EDHOC execution with the next endpoint in the chain, by means of a single message sent on the wire.<a href="#appendix-A-2.5.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.6">
          <p id="appendix-A-2.6.1">Hop-by-hop security has to also be achieved between each pair of proxies in the chain. To this end, two adjacent proxies would better use TLS over TCP than OSCORE between one another (this should be acceptable for non-constrained proxies). This takes advantage of the TCP packet aggregation policies, and thus:<a href="#appendix-A-2.6.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.6.2.1">As request forwarding occurs in MTU-size bundles, the length of the origin request can be hidden as well.<a href="#appendix-A-2.6.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="appendix-A-2.6.2.2">Requests and responses traversing the proxy chain cannot be correlated, e.g., by externally monitoring the timing of message forwarding (which would jeopardize the client's wish to hide itself from anything but the first proxy in the chain).<a href="#appendix-A-2.6.2.2" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="appendix-A-2.7">
          <p id="appendix-A-2.7.1">Cacheability of responses can still happen, as per <a href="#sec-response-caching" class="xref">Section 5</a> and using the approach defined in <span>[<a href="#I-D.amsuess-core-cachable-oscore" class="xref">I-D.amsuess-core-cachable-oscore</a>]</span>.<a href="#appendix-A-2.7.1" class="pilcrow">¶</a></p>
<p id="appendix-A-2.7.2">
The last proxy in the chain would be the only proxy actually seeing the Deterministic Request originated by the client and then caching the corresponding responses from the origin server. It is good that other proxies are not able to do the same, thus preventing what might lead to request-response correlation, again opening for localization of the origin client.<a href="#appendix-A-2.7.2" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.8">
          <p id="appendix-A-2.8.1">Possible optimizations along the proxy chains<a href="#appendix-A-2.8.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.8.2.1">In particular settings involving additional configuration on the client, some proxy in the chain might be a reverse-proxy. Then, such a proxy can be configured to map on one hand the OSCORE Security Context shared with the origin client (and used to remove a corresponding OSCORE layer from a received request to forward) and, on the other hand, the addressing information of the next hop in the chain where to forward the received request to. This would spare the origin client to add a set of proxy-related options for every single proxy in the chain.<a href="#appendix-A-2.8.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="appendix-A-2.8.2.2">
              <p id="appendix-A-2.8.2.2.1">It is mentioned above to additionally use TLS over TCP hop-by-hop between every two adjacent proxies in the chain. That said:<a href="#appendix-A-2.8.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.8.2.2.2.1">The OSCORE protection of the request has certainly to rely on authenticated encryption algorithms (as usual), when applying the OSCORE layer intended to the origin server (the first one applied by the origin client) and the OSCORE layer intended to the first proxy in the chain (the last one applied by the origin client).<a href="#appendix-A-2.8.2.2.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="appendix-A-2.8.2.2.2.2">For any other OSCORE layer applied by the origin client (i.e., intended for any proxy in the chain but the first one), the OSCORE protection can better rely on an encryption-only algorithm not providing an authentication tag (as admitted in the group mode of Group OSCORE <span>[<a href="#I-D.ietf-core-oscore-groupcomm" class="xref">I-D.ietf-core-oscore-groupcomm</a>]</span> and assuming the registration of such algorithms in COSE).<a href="#appendix-A-2.8.2.2.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="appendix-A-2.8.2.2.2.3">This would be secure to do, since every pair of adjacent proxies in the chain relies on its TLS connection for the respective hop-by-hop communication anyway. The benefit is that it avoids transmitting several unneeded authentication tags from OSCORE.<a href="#appendix-A-2.8.2.2.2.3" class="pilcrow">¶</a>
</li>
              </ul>
</li>
          </ul>
</li>
      </ul>
</section>
</div>
<div id="acknowledgments">
<section id="appendix-B">
      <h2 id="name-acknowledgments-2">
<a href="#name-acknowledgments-2" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-B-1">The authors sincerely thank Christian Amsuess, Peter Blomqvist and Goeran Selander for their comments and feedback.<a href="#appendix-B-1" class="pilcrow">¶</a></p>
<p id="appendix-B-2">The work on this document has been partly supported by VINNOVA and the Celtic-Next project CRITISEC; and by the H2020 project SIFIS-Home (Grant agreement 952652).<a href="#appendix-B-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-C">
      <h2 id="name-authors-addresses-6">
<a href="#name-authors-addresses-6" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Marco Tiloca</span></div>
<div dir="auto" class="left"><span class="org">RISE AB</span></div>
<div dir="auto" class="left"><span class="street-address">Isafjordsgatan 22</span></div>
<div dir="auto" class="left">SE-<span class="postal-code">16440</span> <span class="locality">Kista</span>
</div>
<div dir="auto" class="left"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:marco.tiloca@ri.se" class="email">marco.tiloca@ri.se</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Rikard Höglund</span></div>
<div dir="auto" class="left"><span class="org">RISE AB</span></div>
<div dir="auto" class="left"><span class="street-address">Isafjordsgatan 22</span></div>
<div dir="auto" class="left">SE-<span class="postal-code">16440</span> <span class="locality">Kista</span>
</div>
<div dir="auto" class="left"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rikard.hoglund@ri.se" class="email">rikard.hoglund@ri.se</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
