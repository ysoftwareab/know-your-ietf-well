<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>DHCPv6 Bulk Leasequery</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="DHCPv6 Bulk Leasequery">
<meta name="keywords" content="I-D, Internet-Draft, DHCP, IPv6, LEASEQUERY, DHCPv6">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">DHC</td><td class="header">M. Stapp</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco Systems, Inc.</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">January 13, 2009</td></tr>
<tr><td class="header">Expires: July 17, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />DHCPv6 Bulk Leasequery<br />draft-ietf-dhc-dhcpv6-bulk-leasequery-06.txt</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on July 17, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>
The Dynamic Host Configuration Protocol for IPv6 (DHCPv6) has been
extended with a Leasequery capability that allows a client to request
information about DHCPv6 bindings. That mechanism is limited to
queries for individual bindings. In some situations individual binding
queries may not be efficient, or even possible. This document expands
on the Leasequery protocol, adding new query types and allowing for
bulk transfer of DHCPv6 binding data via TCP.

</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#anchor3">3.</a>&nbsp;
Protocol Overview<br />
<a href="#section.interaction">4.</a>&nbsp;
Interaction Between UDP Leasequery and Bulk
Leasequery<br />
<a href="#anchor4">5.</a>&nbsp;
Message and Option Definitions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.framing">5.1.</a>&nbsp;
Message Framing for TCP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.messages">5.2.</a>&nbsp;
Messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">5.2.1.</a>&nbsp;
LEASEQUERY-DATA<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.2.2.</a>&nbsp;
LEASEQUERY-DONE<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.3.</a>&nbsp;
Query Types<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.relayquery">5.3.1.</a>&nbsp;
QUERY_BY_RELAY_ID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.linkquery">5.3.2.</a>&nbsp;
QUERY_BY_LINK_ADDRESS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.remotequery">5.3.3.</a>&nbsp;
QUERY_BY_REMOTE_ID<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.4.</a>&nbsp;
Options<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.relayid">5.4.1.</a>&nbsp;
Relay-ID Option<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.statuscodes">5.5.</a>&nbsp;
Status Codes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.params">5.6.</a>&nbsp;
Connection and Transmission Parameters<br />
<a href="#section.client">6.</a>&nbsp;
Requestor Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">6.1.</a>&nbsp;
Connecting<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">6.2.</a>&nbsp;
Forming Queries<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">6.3.</a>&nbsp;
Processing Replies<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">6.3.1.</a>&nbsp;
Reply Completion<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">6.4.</a>&nbsp;
Querying Multiple Servers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.client.multi.query">6.5.</a>&nbsp;
Multiple Queries to a Single Server<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">6.5.1.</a>&nbsp;
Example<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">6.6.</a>&nbsp;
Closing Connections<br />
<a href="#section.server">7.</a>&nbsp;
Server Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">7.1.</a>&nbsp;
Accepting Connections<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">7.2.</a>&nbsp;
Forming Replies<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">7.3.</a>&nbsp;
Multiple or Parallel Queries<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">7.4.</a>&nbsp;
Closing Connections<br />
<a href="#section.security">8.</a>&nbsp;
Security Considerations<br />
<a href="#section.IANA">9.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor20">10.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
The DHCPv6 <a class='info' href='#RFC3315'>[RFC3315]<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a> protocol specifies a mechanism for
the assignment of IPv6 address and configuration information to IPv6
nodes. IPv6 Prefix Delegation for DHCPv6 (PD) <a class='info' href='#RFC3633'>[RFC3633]<span> (</span><span class='info'>Troan, O. and R. Droms, &ldquo;IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6,&rdquo; December&nbsp;2003.</span><span>)</span></a>
specifies a mechanism for DHCPv6 delegation of IPv6 prefixes and
related data. DHCPv6 servers maintain authoritative information
including binding information for delegated IPv6 prefixes.

</p>
<p>
The client of a PD binding is typically a router, which then
advertises the delegated prefix to locally-connected hosts. The
delegated IPv6 prefix must be routeable in order to be useful. The
actual DHCPv6 PD client may not be permitted to inject routes into the
delegating network. In service-provider (SP) networks, for example, an
edge router typically acts as a DHCPv6 relay agent, and this edge
router often has the responsibility to maintain routes within the
service-provider network for clients' PD bindings.

</p>
<p>
A DHCPv6 relay with this responsibility requires a means to recover
binding information from the authoritative DHCPv6 server(s) in the
event of replacement or reboot, in order to restore routeability to
delegated prefixes. The relay may be a network device without adequate
local storage to maintain the necessary binding-to-route data. A
DHCPv6 Leasequery protocol <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> has been developed
that allows queries for individual bindings from the authoritative
DHCPv6 Server(s). The individual query mechanism is only useable when
the target binding is known to the requestor, such as upon receipt
of traffic. In the case of DHCPv6 Prefix Delegation, the PD binding
data may need to be known before any traffic arrives from the client
router. The DHCPv6 relay router may not be able to form individual
queries in such cases.

</p>
<p>
This document extends the DHCPv6 Leasequery protocol to add support
for queries that address these requirements. At the SP edge there may
be many thousands of delegated prefixes per relay, so we specify the
use of TCP <a class='info' href='#RFC4614'>[RFC4614]<span> (</span><span class='info'>Duke, M., Braden, R., Eddy, W., and E. Blanton, &ldquo;A Roadmap for Transmission Control Protocol (TCP) Specification Documents,&rdquo; September&nbsp;2006.</span><span>)</span></a> for efficiency of data
transfer. We specify a new DHCPv6 option, the Relay Identifier option,
to support efficient recovery of all data associated with a specific
relay agent; we also add a query-type for this purpose. We add
query-types by network segment and by Remote-ID option value, to
assist a relay that needs to recover a subset of its clients'
bindings.

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.

</p>
<p>
DHCPv6 terminology is defined in <a class='info' href='#RFC3315'>[RFC3315]<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a>. DHCPv6
Leasequery terminology is defined in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>.

</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Protocol Overview</h3>

<p>
The Bulk Leasequery mechanism is modeled on the existing individual
Leasequery protocol in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>; most differences
arise from the use of TCP. A Bulk Leasequery client opens a TCP
connection to a DHCPv6 Server, using the DHCPv6 port 547. Note that
this implies that the Leasequery client has server IP address(es)
available via configuration or some other means, and that it has
unicast IP reachability to the server. No relaying for bulk leasequery
is specified.

</p>
<p>
After establishing a connection, the client sends a LEASEQUERY
message containing a query-type and data about bindings it is
interested in. The server uses the query-type and the data to identify
any relevant bindings. In order to support some query-types, servers
may have to maintain additional data structures or be able to locate
bindings based on specific option data. The server replies with a
LEASEQUERY-REPLY message, indicating the success or failure of the
query. If the query was successful, the server includes the first
client's binding data in the LEASEQUERY-REPLY message also. If more
than one client's bindings are being returned, the server then
transmits the additional client bindings in a series of
LEASEQUERY-DATA messages. If the server has sent at least one client's
bindings, it sends a LEASEQUERY-DONE message when it has finished
sending its replies. The client may reuse the connection to send
additional queries. Each end of the TCP connection can be closed
after all data has been sent.

</p>
<p>
This specification includes a new DHCPv6 option, the Relay-ID
option. The option contains a DUID (DHCP Unique Identifier)
identifying a DHCPv6 relay agent. Relay agents can include this option
in Relay-Forward messages they send. Servers can retain the Relay-ID
and associate it with bindings made on behalf of the relay's
clients. A relay can then recover binding information about downstream
clients by using the Relay-ID in a LEASEQUERY message. The Relay-ID
option is defined in <a class='info' href='#section.relayid'>Section&nbsp;5.4.1<span> (</span><span class='info'>Relay-ID Option</span><span>)</span></a>.

</p>
<p>
Bulk Leasequery supports the queries by IPv6 address and by Client
DUID as specified in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. The Bulk
Leasequery protocol also adds several new queries. The new queries
introduced here cannot be used effectively with the UDP Leasequery
protocol. Requestors MUST NOT send these new query-types in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> query messages.

</p>
<p>
</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>

</dd>
<dt>Query by Relay Identifier -</dt>
<dd>
This query asks a server for the bindings associated with a specific
relay; the relay is identified by a DUID carried in a Relay-ID option.

</dd>
<dt></dt>
<dd>

</dd>
<dt>Query by Link Address -</dt>
<dd>
This query asks a server for the bindings on a particular network
segment; the link is specified in the query's link-address field.

</dd>
<dt></dt>
<dd>

</dd>
<dt>Query by Remote ID -</dt>
<dd>
This query asks a server for the bindings associated with a Relay
Agent Remote-ID option <a class='info' href='#RFC4649'>[RFC4649]<span> (</span><span class='info'>Volz, B., &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6) Relay Agent Remote-ID Option,&rdquo; August&nbsp;2006.</span><span>)</span></a> value.

</dd>
<dt></dt>
<dd>

</dd>
</dl></blockquote><p>

</p>
<a name="section.interaction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Interaction Between UDP Leasequery and Bulk
Leasequery</h3>

<p>
Bulk Leasequery can be seen as an extension of the existing UDP
Leasequery protocol <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. This section tries to
clarify the relationship between the two protocols.

</p>
<p>
The query-types introduced in the UDP Leasequery protocol can be used
in the Bulk Leasequery protocol. One change in behavior is introduced
when Bulk Leasequery is used. <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>,
in sections 4.1.2.5 and 4.3.3, specifies the use of a Client Link
option in LEASEQUERY-REPLY messages in cases where multiple bindings
were found. When Bulk Leasequery is used, this mechanism is not
necessary: a server returning multiple bindings simply does so
directly as specified in this document. The Client Link option MUST
NOT appear in Bulk Leasequery replies.

</p>
<p>
Only LEASEQUERY, LEASEQUERY-REPLY, LEASEQUERY-DATA, and
LEASEQUERY-DONE messages are allowed over the Bulk Leasequery
connection. No other DHCPv6 messages are supported. The Bulk
Leasequery connection is not an alternative DHCPv6 communication
option for clients seeking DHCPv6 service.

</p>
<p>
The new queries introduced in this specification cannot be used with
the UDP Leasequery protocol. Servers that implement this specification
and also permit UDP queries MUST NOT accept Bulk Leasequery
query-types in UDP Leasequery messages. Such servers MUST respond with
an error status code of <a class='info' href='#RFC5007'>NotAllowed<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> [RFC5007].

</p>
<p>
Implementors should note that the TCP message framing defined in <a class='info' href='#section.framing'>Section&nbsp;5.1<span> (</span><span class='info'>Message Framing for TCP</span><span>)</span></a> is not compatible with the UDP message
format. If a TCP-framed request is sent as a UDP message, it may not
be valid, because protocol fields will be offset by the message-size
prefix.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Message and Option Definitions</h3>

<a name="section.framing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Message Framing for TCP</h3>

<p>
The use of TCP for the Bulk Leasequery protocol permits one or more
DHCPv6 messages to be sent at a time. The receiver needs to be able to
determine how large each message is. Two octets containing the message
size in network byte order are prepended to each DHCPv6 message sent
on a Bulk Leasequery TCP connection. The two message-size octets
'frame' each DHCPv6 message.

</p>
<p>DHCPv6 message framed for TCP:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         message-size          |    msg-type   |               :
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   :   transaction-id              |                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
   |                                                               .
   .                            options                            .
   .                           (variable)                          .
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


    message-size    the number of octets in the message that
                    follows, as a 16-bit integer in network
                    byte order.

</pre></div>
<p>
All other fields are as specified in DHCPv6 <a class='info' href='#RFC3315'>[RFC3315]<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a>.

</p>
<a name="section.messages"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Messages</h3>

<p>
The LEASEQUERY and LEASEQUERY-REPLY messages are defined in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. In a Bulk Leasequery exchange, a
single LEASEQUERY-REPLY message is used to indicate the success or
failure of a query, and to carry data that do not change in the
context of a single query and answer, such as the Server-ID and
Client-ID options. If a query is successful, only a single
LEASEQUERY-REPLY message MUST appear. If the server is returning
binding data, the LEASEQUERY-REPLY also contains the first client's
binding data in an OPTION_CLIENT_DATA option.

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2.1"></a><h3>5.2.1.&nbsp;
LEASEQUERY-DATA</h3>

<p>
The LEASEQUERY-DATA message carries data about a single DHCPv6
client's leases and/or PD bindings on a single link. The purpose of
the message is to reduce redundant data when there are multiple
bindings to be sent.  The LEASEQUERY-DATA message MUST be preceded by
a LEASEQUERY-REPLY message. The LEASEQUERY-REPLY conveys the query's
status, carries the Leasequery's Client-ID and Server-ID options, and
carries the first client's binding data if the query was successful.

</p>
<p>
LEASEQUERY-DATA MUST ONLY be sent in response to a successful
LEASEQUERY, and only if more than one client's data is to be sent. The
LEASEQUERY-DATA message's transaction-id field MUST match the
transaction-id of the LEASEQUERY request message. The Server-ID,
Client-ID, and OPTION_STATUS_CODE options SHOULD NOT be included: that
data should be constant for any one Bulk Leasequery reply, and should
have been conveyed in the LEASEQUERY-REPLY message.

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2.2"></a><h3>5.2.2.&nbsp;
LEASEQUERY-DONE</h3>

<p>
The LEASEQUERY-DONE message indicates the end of a group of related
Leasequery replies. The LEASEQUERY-DONE message's transaction-id field
MUST match the transaction-id of the LEASEQUERY request message. The
presence of the message itself signals the end of a stream of reply
messages. A single LEASEQUERY-DONE MUST BE sent after all replies (a
successful LEASEQUERY-REPLY and zero or more LEASEQUERY-DATA messages)
to a successful Bulk Leasequery request that returned at least one
binding.

</p>
<p>
A server may encounter an error condition after it has sent the
initial LEASEQUERY-REPLY. In that case, it SHOULD attempt to send a
LEASEQUERY-DONE with an OPTION_STATUS_CODE option indicating the error
condition to the requestor. Other DHCPv6 options SHOULD NOT be
included in the LEASEQUERY-DONE message.

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Query Types</h3>

<p>
The OPTION_LQ_QUERY option is defined in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. We
introduce the following new query-types: QUERY_BY_RELAY_ID,
QUERY_BY_LINK_ADDRESS, QUERY_BY_REMOTE_ID. These queries are designed
to assist relay agents in recovering binding data in circumstances
where some or all of the relay's binding data has been lost.

</p>
<a name="section.relayquery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.1"></a><h3>5.3.1.&nbsp;
QUERY_BY_RELAY_ID</h3>

<p>
This query asks the server to return bindings associated with the
specified relay DUID.

</p>
<p>
</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
</dd>
<dt>QUERY_BY_RELAY_ID - </dt>
<dd>
The query-options MUST contain an OPTION_RELAY_ID option. If the
link-address field is 0::0, the query asks for all bindings associated
with the specified relay DUID. If the link-address is specified, the
query asks for bindings on that link.

</dd>
</dl></blockquote><p>

</p>
<a name="section.linkquery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.2"></a><h3>5.3.2.&nbsp;
QUERY_BY_LINK_ADDRESS</h3>

<p>
The QUERY_BY_LINK_ADDRESS asks the server to return bindings on a
network segment identified by an link-address value from a relay's
Relay-Forward message.

</p>
<p>
</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
</dd>
<dt>QUERY_BY_LINK_ADDRESS - </dt>
<dd>
The query's link-address contains an address a relay may have used in
the link-address of a Relay-Forward message. The Server attempts to
locate bindings on the same network segment as the link-address.

</dd>
</dl></blockquote><p>

</p>
<a name="section.remotequery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.3"></a><h3>5.3.3.&nbsp;
QUERY_BY_REMOTE_ID</h3>

<p>
The QUERY_BY_REMOTE_ID asks the server to return bindings associated
with a Remote-ID option value from a relay's Relay-Forward
message. The query-options MUST include a <a class='info' href='#RFC4649'>Relay Agent Remote-ID option<span> (</span><span class='info'>Volz, B., &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6) Relay Agent Remote-ID Option,&rdquo; August&nbsp;2006.</span><span>)</span></a> [RFC4649].

</p>
<p>
In order to support this query, a server needs to record the
most-recent Remote-ID option value seen in a Relay-Forward message
along with its other binding data.

</p>
<p>
</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
</dd>
<dt>QUERY_BY_REMOTE_ID - </dt>
<dd>
The query-options MUST include a <a class='info' href='#RFC4649'>Relay Agent
Remote-ID option<span> (</span><span class='info'>Volz, B., &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6) Relay Agent Remote-ID Option,&rdquo; August&nbsp;2006.</span><span>)</span></a> [RFC4649]. If the Server has recorded Remote-ID values
with its bindings, it uses the option's value to identify bindings to
return.

</dd>
</dl></blockquote><p>

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Options</h3>

<a name="section.relayid"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4.1"></a><h3>5.4.1.&nbsp;
Relay-ID Option</h3>

<p>
The Relay-ID option carries a <a class='info' href='#RFC3315'>DUID<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a> [RFC3315]. A
relay agent MAY include the option in Relay-Forward messages it
sends. Obviously, it will not be possible for a server to respond to
QUERY_BY_RELAY_ID queries unless the relay agent has included this
option. A relay SHOULD be able to generate a DUID for this purpose,
and capture the result in stable storage. A relay SHOULD also allow
the DUID value to be configurable: doing so allows an administrator to
replace a relay agent while retaining the association between the
relay and existing DHCPv6 bindings.

</p>
<p>
A DHCPv6 Server MAY associate Relay-ID options from Relay-Forward
messages it processes with prefix delegations and/or lease bindings
that result. Doing so allows it to respond to QUERY_BY_RELAY_ID
Leasequeries.

</p>
<p>The format of the Relay-ID option is shown below:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |       OPTION_RELAY_ID         |          option-len           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   .                                                               .
   .                              DUID                             .
   .                        (variable length)                      .
   .                                                               .
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   option-code   OPTION_RELAY_ID.

   option-len    Length of DUID in octets.

   DUID          The DUID for the relay agent.

</pre></div>
<a name="section.statuscodes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
Status Codes</h3>

<p>
QueryTerminated - Indicates that the server is unable to perform a
query or has prematurely terminated the query for some reason (which
should be communicated in the text message). This may be because the
server is short of resources or is being shut down. The requestor may
retry the query at a later time. The requestor should wait at least a
short interval before retrying. Note that while a server may simply
prematurely close its end of the connection, it is preferable for the
server to send a LEASEQUERY-REPLY or LEASEQUERY-DONE with this
status-code to notify the requestor of the condition.

</p>
<a name="section.params"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.6"></a><h3>5.6.&nbsp;
Connection and Transmission Parameters</h3>

<p>
DHCPv6 Servers that support Bulk Leasequery SHOULD listen for incoming
TCP connections on the DHCPv6 server port 547. Implementations MAY
offer to make the incoming port configurable, but port 547 MUST be the
default. Client implementations SHOULD make TCP connections to port
547, and MAY offer to make the destination server port configurable.

</p>
<p>
This section presents a table of values used to control Bulk
Leasequery behavior, including recommended defaults. Implementations
MAY make these values configurable. However, configuring too-small
timeout values may lead to harmful behavior both to this application
as well as to other traffic in the network. As a result, timeout
values smaller than the default values are NOT RECOMMENDED.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Parameter             Default   Description
-------------------------------------------
BULK_LQ_DATA_TIMEOUT  300 secs  Bulk Leasequery data timeout
BULK_LQ_MAX_CONNS     10        Max Bulk Leasequery TCP connections
</pre></div>
<a name="section.client"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Requestor Behavior</h3>

<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Connecting</h3>

<p>
A Requestor attempts to establish a TCP connection to a DHCPv6 Server
in order to initiate a Leasequery exchange. If the attempt fails, the
Requestor MAY retry.

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Forming Queries</h3>

<p>
After a connection is established, the Requestor constructs a
Leasequery message, as specified in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. The
query may have any of the defined query-types, and includes the
options and data required by the query-type chosen. The Requestor
sends the message size then sends the actual DHCPv6 message, as
described in <a class='info' href='#section.framing'>Section&nbsp;5.1<span> (</span><span class='info'>Message Framing for TCP</span><span>)</span></a>.

</p>
<p>
If the TCP connection becomes blocked or stops being writeable while
the Requestor is sending its query, the Requestor SHOULD be prepared
to terminate the connection after BULK_LQ_DATA_TIMEOUT. We make this
recommendation to allow Requestors to control the period of time they
are willing to wait before abandoning a connection, independent of
notifications from the TCP implementations they may be using.

</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Processing Replies</h3>

<p>
The Requestor attempts to read a LEASEQUERY-REPLY message from the TCP
connection. If the TCP connection stops delivering reply data (if the
connection stops being readable), the Requestor SHOULD be prepared to
terminate the connection after BULK_LQ_DATA_TIMEOUT, and MAY begin
retry processing if configured to do so.

</p>
<p>
The Requestor examines the LEASEQUERY-REPLY message, and determines
how to proceed. Message validation rules are specified in DHCPv6
Leasequery <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. If the reply contains an error
status code (carried in an OPTION_STATUS_CODE option), the Requestor
follows the recommendations in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>. A successful
reply that does not include an OPTION_CLIENT_DATA option indicates
that the target server had no bindings matching the query.

</p>
<p>
Note: The Leasequery protocol uses the OPTION_CLIENT_LINK option as an
indicator that multiple bindings were present in response to a single
query. For Bulk Leasequery, the OPTION_CLIENT_LINK option is not used,
and MUST NOT be present in replies.

</p>
<p>
A successful LEASEQUERY-REPLY that is returning binding data includes
an OPTION_CLIENT_DATA option and possibly additional options. If there
are additional bindings to be returned, they will be carried in
LEASEQUERY-DATA messages. Each LEASEQUERY-DATA message contains an
OPTION_CLIENT_DATA option, and possibly other options. A
LEASEQUERY-DATA message that does not contain an OPTION_CLIENT_DATA
MUST be discarded.

</p>
<p>
A single bulk query can result in a large number of replies. For
example, a single relay agent might be responsible for routes for
thousands of clients' delegated prefixes. The Requestor MUST be
prepared to receive more than one LEASEQUERY-DATA with transaction-ids
matching a single LEASEQUERY message.

</p>
<p>
The LEASEQUERY-DONE message ends a successful Bulk Leasequery request
that returned at least one binding. A LEASEQUERY-REPLY without any
bindings MUST NOT be followed by a LEASEQUERY-DONE message for the
same transaction-id. After receiving LEASEQUERY-DONE from a server,
the Requestor MAY close the TCP connection to that server. If the
transaction-id in the LEASEQUERY-DONE does not match an outstanding
LEASEQUERY message, the client MUST close the TCP connection.

</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3.1"></a><h3>6.3.1.&nbsp;
Reply Completion</h3>

<p>
The reply to a Bulk Leasequery request is complete (i.e., no further
messages for that request transaction-id will be received) when one of
these conditions is met:

<br />
<br />


</p>
<ol class="text">
<li>
if the LEASEQUERY-REPLY message had no OPTION_CLIENT_DATA option, when
the LEASEQUERY-REPLY is received,
<br />
<br />


</li>
<li>
else if the LEASEQUERY-REPLY did have an OPTION_CLIENT_DATA, when the
corresponding LEASEQUERY-DONE message is received,
<br />
<br />


</li>
<li>
else when the connection is closed.

</li>
</ol><p>

</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Querying Multiple Servers</h3>

<p>
A Bulk Leasequery client MAY be configured to attempt to connect to
and query from multiple DHCPv6 servers in parallel. The DHCPv6
Leasequery specification <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> includes a
discussion about reconciling binding data received from multiple
DHCPv6 servers.

</p>
<a name="section.client.multi.query"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
Multiple Queries to a Single Server</h3>

<p>
Bulk Leasequery clients may need to make multiple queries in order to
recover binding information. A Requestor MAY use a single connection
to issue multiple queries. Each query MUST have a unique transaction
id. A server MAY process more than one query at a time. A server that
is willing to do so MAY interleave replies to the multiple queries
within the stream of reply messages it sends. Clients need to be aware
that replies for multiple queries may be interleaved within the stream
of reply messages. Clients that are not able to process interleaved
replies (based on transaction-id) MUST NOT send more than one query at
a time. Requestors should be aware that servers are not required to
process queries in parallel, and that servers are likely to limit the
rate at which they process queries from any one Requestor.

</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5.1"></a><h3>6.5.1.&nbsp;
Example</h3>

<p>
This example illustrates what a series of queries and responses might
look like. This is only an example - there is no requirement that this
sequence must be followed, or that clients or servers must support
parallel queries.

</p>
<p>
In the example session, the client sends four queries after
establishing a connection; "xid" denotes a transaction-id in the
diagram. Query 1 results in a failure; query 2 succeeds and the stream
of replies concludes before the client issues any new query. Query 3
and query 4 overlap, and the server interleaves its replies to those
two queries.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     Client                        Server
     ------                        ------
     LEASEQUERY xid 1 -----&gt;
                      &lt;-----       LEASEQUERY-REPLY xid 1 (w/error)
     LEASEQUERY xid 2 -----&gt;
                      &lt;-----       LEASEQUERY-REPLY xid 2
                      &lt;-----       LEASEQUERY-DATA xid 2
                      &lt;-----       LEASEQUERY-DATA xid 2
                      &lt;-----       LEASEQUERY-DONE xid 2
     LEASEQUERY xid 3 -----&gt;
     LEASEQUERY xid 4 -----&gt;
                      &lt;-----       LEASEQUERY-REPLY xid 4
                      &lt;-----       LEASEQUERY-DATA xid 4
                      &lt;-----       LEASEQUERY-REPLY xid 3
                      &lt;-----       LEASEQUERY-DATA xid 4
                      &lt;-----       LEASEQUERY-DATA xid 3
                      &lt;-----       LEASEQUERY-DONE xid 3
                      &lt;-----       LEASEQUERY-DATA xid 4
                      &lt;-----       LEASEQUERY-DONE xid 4
</pre></div>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.6"></a><h3>6.6.&nbsp;
Closing Connections</h3>

<p>
The Requestor MAY close its end of the TCP connection after sending a
LEASEQUERY message to the server. The Requestor MAY choose to retain
the connection if it intends to issue additional queries. Note that
this client behavior does not guarantee that the connection will be
available for additional queries: the server might decide to close the
connection based on its own configuration.

</p>
<a name="section.server"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Server Behavior</h3>

<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Accepting Connections</h3>

<p>
Servers that implement DHCPv6 Bulk Leasequery listen for incoming TCP
connections. Port numbers are discussed in <a class='info' href='#section.params'>Section&nbsp;5.6<span> (</span><span class='info'>Connection and Transmission Parameters</span><span>)</span></a>. Servers MUST be able to limit the number of
currently accepted and active connections. The value BULK_LQ_MAX_CONNS
MUST be the default; implementations MAY permit the value to be
configurable.

</p>
<p>
Servers MAY restrict Bulk Leasequery connections and LEASEQUERY
messages to certain clients. Connections not from permitted clients
SHOULD BE closed immediately, to avoid server connection resource
exhaustion. Servers MAY restrict some clients to certain query
types. Servers MAY reply to queries that are not permitted with the
NotAllowed status code <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a>, and/or close the
connection.

</p>
<p>
If the TCP connection becomes blocked while the server is accepting a
connection or reading a query, it SHOULD be prepared to terminate the
connection after BULK_LQ_DATA_TIMEOUT. We make this recommendation to
allow Servers to control the period of time they are willing to wait
before abandoning an inactive connection, independent of the TCP
implementations they may be using.

</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Forming Replies</h3>

<p>
The DHCPv6 Leasequery <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> specification describes
the initial construction of LEASEQUERY-REPLY messages and the
processing of QUERY_BY_ADDRESS and QUERY_BY_CLIENTID. Use of the
LEASEQUERY-REPLY and LEASEQUERY-DATA messages to carry multiple
bindings are described in <a class='info' href='#section.messages'>Section&nbsp;5.2<span> (</span><span class='info'>Messages</span><span>)</span></a>. Message
transmission and framing for TCP is described in <a class='info' href='#section.framing'>Section&nbsp;5.1<span> (</span><span class='info'>Message Framing for TCP</span><span>)</span></a>. If the connection becomes blocked while
the server is attempting to send reply messages, the server SHOULD be
prepared to terminate the TCP connection after BULK_LQ_DATA_TIMEOUT.

</p>
<p>
If the server encounters an error during initial query processing,
before any reply has been sent, it SHOULD send a LEASEQUERY-REPLY
containing an error code in an OPTION_STATUS_CODE option. This signals
to the requestor that no data will be returned. If the server
encounters an error while processing a query that has already resulted
in one or more reply messages, the server SHOULD send a
LEASEQUERY-DONE message with an error status. The server SHOULD close
its end of the connection as an indication that it was not able to
complete query processing.

</p>
<p>
If the server does not find any bindings satisfying a query, it SHOULD
send a LEASEQUERY-REPLY without an OPTION_STATUS_CODE option and
without any OPTION_CLIENT_DATA option. Otherwise, the server sends
each binding's data in a reply message. The first reply message is a
LEASEQUERY-REPLY. The binding data is carried in an OPTION_CLIENT_DATA
option, as specified in <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> and extended
below. The server returns subsequent bindings in LEASEQUERY-DATA
messages, which can avoid redundant data (such as the requestor's
Client-ID).

</p>
<p>
For QUERY_BY_RELAY_ID, the server locates each binding associated with
the query's Relay-ID option value. In order to give a meaningful reply
to a QUERY_BY_RELAY_ID, the server has to be able to maintain this
association in its DHCPv6 binding data. If the query's link-address is
not set to 0::0, the server only returns bindings on links that could
contain that address. If the link-address is not 0::0 and the server
cannot find any matching links, the server SHOULD return the
NotConfigured status in a LEASEQUERY-REPLY.

</p>
<p>
For QUERY_BY_LINK_ADDRESS, the server locates each binding associated
with the link identified by the query's link-address value.

</p>
<p>
For QUERY_BY_REMOTE_ID, the server locates each binding associated
with the query's Relay Remote-ID option value. In order to be able to
give meaningful replies to this query, the server has to be able to
maintain this association in its binding database. If the query
message's link-address is not set to 0::0, the server only returns
bindings on links that could contain that address. If the link-address
is not 0::0 and the server cannot find any matching links, the server
SHOULD return the NotConfigured status in a LEASEQUERY-REPLY.

</p>
<p>
The server sends the LEASEQUERY-DONE message as specified in <a class='info' href='#section.messages'>Section&nbsp;5.2<span> (</span><span class='info'>Messages</span><span>)</span></a>.

</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Multiple or Parallel Queries</h3>

<p>
As discussed in <a class='info' href='#section.client.multi.query'>Section&nbsp;6.5<span> (</span><span class='info'>Multiple Queries to a Single Server</span><span>)</span></a>,
Requestors may want to leverage an existing connection if they need to
make multiple queries. Servers MAY support reading and processing
multiple queries from a single connection. A server MUST NOT read more
query messages from a connection than it is prepared to process
simultaneously.

</p>
<p>
This MAY be a feature that is administratively controlled. Servers
that are able to process queries in parallel SHOULD offer
configuration that limits the number of simultaneous queries permitted
from any one Requestor, in order to control resource use if there are
multiple Requestors seeking service.

</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.4"></a><h3>7.4.&nbsp;
Closing Connections</h3>

<p>
The server MAY close its end of the TCP connection after sending its
last message (a LEASEQUERY-REPLY or a LEASEQUERY-DONE) in response to
a query. Alternatively, the server MAY retain the connection and wait
for additional queries from the client. The server SHOULD be prepared
to limit the number of connections it maintains, and SHOULD be
prepared to close idle connections to enforce the limit.

</p>
<p>
The server MUST close its end of the TCP connection if it encounters
an error sending data on the connection. The server MUST close its end
of the TCP connection if it finds that it has to abort an in-process
request. A server aborting an in-process request MAY attempt to signal
that to its clients by using the <a class='info' href='#section.statuscodes'>QueryTerminated<span> (</span><span class='info'>Status Codes</span><span>)</span></a> status code. If the server detects that the
client end has been closed, the server MUST close its end of the
connection after it has finished processing any outstanding requests
from the client.

</p>
<a name="section.security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>
The "Security Considerations" section of <a class='info' href='#RFC3315'>[RFC3315]<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a>
details the general threats to DHCPv6. The DHCPv6 Leasequery
specification <a class='info' href='#RFC5007'>[RFC5007]<span> (</span><span class='info'>Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;DHCPv6 Leasequery,&rdquo; September&nbsp;2007.</span><span>)</span></a> describes recommendations for
the Leasequery protocol, especially with regard to relayed LEASEQUERY
messages, mitigation of packet-flooding DOS attacks, restriction to
trusted clients, and use of IPsec <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.

</p>
<p>
The use of TCP introduces some additional concerns. Attacks that
attempt to exhaust the DHCPv6 server's available TCP connection
resources, such as SYN flooding attacks, can compromise the ability of
legitimate clients to receive service. Malicious clients who succeed
in establishing connections, but who then send invalid queries,
partial queries, or no queries at all also can exhaust a server's
pool of available connections. We recommend that servers offer
configuration to limit the sources of incoming connections, that they
limit the number of accepted connections and the number of in-process
queries from any one connection, and that they limit the period of
time during which an idle connection will be left open.

</p>
<a name="section.IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>
IANA is requested to assign a new DHCPv6 Option Code in the registry
maintained in http://www.iana.org/assignments/dhcpv6-parameters:

</p>
<p>
</p>
<blockquote class="text">
<p>OPTION_RELAY_ID
</p>
<p>
</p>
</blockquote><p>

</p>
<p>
IANA is requested to assign a new value in the registry of DHCPv6
Status Codes maintained in
http://www.iana.org/assignments/dhcpv6-parameters:

</p>
<p></p>
<blockquote class="text">
<p>QueryTerminated
</p>
<p>
</p>
</blockquote>

<p>
IANA is requested to assign values for the following new DHCPv6
Message types in the registry maintained in
http://www.iana.org/assignments/dhcpv6-parameters:

</p>
<p></p>
<blockquote class="text">
<p>LEASEQUERY-DONE
</p>
<p>LEASEQUERY-DATA
</p>
<p>
</p>
</blockquote>

<p>
IANA is requested to assign the following new values in the registry
of query-types for the DHCPv6 OPTION_LQ_QUERY option:

</p>
<p></p>
<blockquote class="text">
<p>QUERY_BY_RELAY_ID
</p>
<p>QUERY_BY_LINK_ADDRESS
</p>
<p>QUERY_BY_REMOTE_ID
</p>
</blockquote>

<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgements</h3>

<p>
Many of the ideas in this document were originally proposed by Kim
Kinnear, Richard Johnson, Hemant Singh, Ole Troan, and Bernie
Volz. Further suggestions and improvements were made by participants
in the DHC working group, including John Brzozowski, Marcus Goller,
Alfred Hoenes, Ted Lemon, Bud Millwood, and Thomas Narten.

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3315">[RFC3315]</a></td>
<td class="author-text">Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;<a href="http://tools.ietf.org/html/rfc3315">Dynamic Host Configuration Protocol for IPv6 (DHCPv6)</a>,&rdquo; RFC&nbsp;3315, July&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3315.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3633">[RFC3633]</a></td>
<td class="author-text">Troan, O. and R. Droms, &ldquo;<a href="http://tools.ietf.org/html/rfc3633">IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6</a>,&rdquo; RFC&nbsp;3633, December&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3633.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4649">[RFC4649]</a></td>
<td class="author-text">Volz, B., &ldquo;<a href="http://tools.ietf.org/html/rfc4649">Dynamic Host Configuration Protocol for IPv6 (DHCPv6) Relay Agent Remote-ID Option</a>,&rdquo; RFC&nbsp;4649, August&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4649.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5007">[RFC5007]</a></td>
<td class="author-text">Brzozowski, J., Kinnear, K., Volz, B., and S. Zeng, &ldquo;<a href="http://tools.ietf.org/html/rfc5007">DHCPv6 Leasequery</a>,&rdquo; RFC&nbsp;5007, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5007.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4614">[RFC4614]</a></td>
<td class="author-text">Duke, M., Braden, R., Eddy, W., and E. Blanton, &ldquo;<a href="http://tools.ietf.org/html/rfc4614">A Roadmap for Transmission Control Protocol (TCP) Specification Documents</a>,&rdquo; RFC&nbsp;4614, September&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4614.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Mark Stapp</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1414 Massachusetts Ave.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Boxborough, MA  01719</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 978 936 0000</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:mjs@cisco.com">mjs@cisco.com</a></td></tr>
</table>
</body></html>
