<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Streaming Internet
    Messaging Attachments</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Streaming Internet
    Messaging Attachments">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Lemonade</td><td class="header">N. Cook</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cloudmark</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">June 03, 2009</td></tr>
<tr><td class="header">Expires: December 5, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Streaming Internet
    Messaging Attachments<br />draft-ietf-lemonade-streaming-13</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008. The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on December 5, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>This document describes a method for streaming multimedia attachments
      received by a resource constrained and/or mobile device from an IMAP
      server. It allows such clients, which often have limits in storage space
      and bandwidth, to play video and audio e-mail content.
</p>
<p>The document describes a profile for making use of the
      URLAUTH authorized IMAP URLs (RFC 5092), the Network
      Announcement SIP Media Service (RFC 4240), and the Media Server
      Control Markup Language (RFC 5022).
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#anchor1">2.</a>&nbsp;
Conventions Used in this Document<br />
<a href="#mechanism">3.</a>&nbsp;
Mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#overview">3.1.</a>&nbsp;
Overview of Mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#discovery">3.2.</a>&nbsp;
Media Server Discovery<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#genurlauth">3.3.</a>&nbsp;
Client use of GENURLAUTH Command<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#clientdecision">3.4.</a>&nbsp;
Client Determination of Media Server Capabilities<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#netanninvite">3.5.</a>&nbsp;
Client Use of the Media Server Announcement Service<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#transcoding">3.6.</a>&nbsp;
Media Negotiation and Transcoding<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#mscmlinvite">3.7.</a>&nbsp;
Client Use of the Media Server MSCML IVR Service<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#urlfetch">3.8.</a>&nbsp;
Media Server Use of IMAP Server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">3.9.</a>&nbsp;
Protocol Diagrams<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#netann_protocol">3.9.1.</a>&nbsp;
Announcement Service Protocol Diagram<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#mscml_protocol">3.9.2.</a>&nbsp;
IVR Service Protocol Diagram<br />
<a href="#security">4.</a>&nbsp;
Security Considerations<br />
<a href="#IANA">5.</a>&nbsp;
IANA Considerations<br />
<a href="#drm">6.</a>&nbsp;
Digital Rights Management (DRM) Issues<br />
<a href="#deployment">7.</a>&nbsp;
Deployment Considerations<br />
<a href="#formalsyntax">8.</a>&nbsp;
Formal Syntax<br />
<a href="#contrib">9.</a>&nbsp;
Contributors<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>Email clients on resource and/or network constrained devices, such as
      mobile phones, may have difficulties in retrieving and/or storing large
      attachments received in a message. For example, on a poor network link,
      the latency required to download the entire attachment before
      displaying any of it may not be acceptable to the
      user. Conversely, even on a high-speed network, the device may
      not have enough storage space to secure the attachment once
      retrieved.
</p>
<p>For certain media, such as audio and video, there is a solution: the
      media can be streamed to the device, using protocols such as <a class='info' href='#RTP'>RTP<span> (</span><span class='info'>Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, &ldquo;RTP: A Transport Protocol for Real-Time Applications,&rdquo; July&nbsp;2003.</span><span>)</span></a> [RTP]. Streaming can be initiated and controlled using protocols such as
      <a class='info' href='#SIP'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [SIP] and particularly the media server profiles as
      specified in <a class='info' href='#NETANN'>RFC 4240<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN] or <a class='info' href='#MSCML'>MSCML<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML]. Streaming the media to the device
      addresses both the latency issue, since the client can start playing the
      media relatively quickly, and the storage issue, since the client does not need
      to store the media locally. A tradeoff is that the media cannot be
      viewed/played when the device is offline.
</p>
<p>Examples of the types of media that would benefit from the ability to
      stream such media to the device include: </p>
<ul class="text">
<li>Voice or Video mail messages received as an attachment
</li>
<li>Audio clips such as ring tones received as an attachment
</li>
<li>Video clips, such as movie trailers, received as an
          attachment
</li>
</ul>

<p>The client may wish to present the user with the ability to use
      simple "VCR"-style controls such as pause, fast-forward and rewind. In
      consideration of this, the document presents two alternatives for
      streaming media - a simple mechanism which makes use of the announcement
      service of RFC 4240, and a more complex mechanism which allows VCR
      controls, based on <a class='info' href='#MSCML'>MSCML (RFC 5022)<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML]. The
      choice of which mechanism to use is up to the client, for
      example it may be
      based on limitations of the client or the configured media server. This
      document presents suggestions for determining which of these
      streaming services are available.
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Conventions Used in this Document</h3>

<p>
	The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
	NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and
	"OPTIONAL" in this document are to be interpreted as described in
      <a class='info' href='#KEYWORDS'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement           Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [KEYWORDS].
      
</p>
<p>
	In examples, "C:" and "S:" indicate lines sent by the client and
	server respectively. If a single "C:" or "S:" label applies to multiple
	lines, then some of the line breaks between those lines are for editorial
      clarity only and may not be part of the actual protocol exchange.
</p>
<a name="mechanism"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Mechanism</h3>

<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Overview of Mechanism</h3>

<p>The proposed mechanism for streaming media to messaging clients is
        a profile for making use of several existing mechanisms,
	namely: 
	</p>
<ol class="text">
<li>IMAP URLAUTH Extension <a class='info' href='#URLAUTH'>URLAUTH<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - URLAUTH Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [URLAUTH]
	    - Providing the ability to generate an IMAP URL that
	    allows access by external entities to 
            specific message parts, e.g. an audio clip.
</li>
<li>URLFETCH Binary Extension <a class='info' href='#URLFETCH_BINARY'>[URLFETCH_BINARY]<span> (</span><span class='info'>Cridland, D., &ldquo;Extended URLFETCH for Binary and Converted Parts,&rdquo; May&nbsp;2009.</span><span>)</span></a> 
	    - Providing the ability to specify BINARY and 
            BODYPARTSTRUCTURE arguments to the URLFETCH command. 
</li>
<li>Media Server Announcement Service <a class='info' href='#NETANN'>(RFC
            4240)<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN] - Providing the ability for a media server to stream
            media using a reference provided by the media server client in a
            URL.
</li>
<li>Media Server Interactive Voice Response (IVR) Service <a class='info' href='#MSCML'>(RFC 5022)<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML] - Providing the ability to stream
            media as above, but with VCR-style controls.
</li>
</ol>
<br /><hr class="insert" />
<a name="overview_mechanism"></a>

<p>The approach is shown in the following figure:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

+--------------+
|              |
| Email Client |^
|              | \
+--------------+  \
    ^           ^  \
    |            \  \ (5)
    | (1),        \  \
    | (2)          \  \
    |           (3),\  \
    |           (6)  \  \
    |                 \  \
    v                  v  v
+--------------+       +----------------+
|              |  (4)  |                |
| IMAP Server  |&lt;-----&gt;|  Media Server  |
|              |       |                |
+--------------+       +----------------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The proposed mechanism has the following steps: </p>
<ol class="text">
<li>Client determines from MIME headers of a particular message that a
            particular message part (attachment) should be streamed to the
            user. Note that no assumptions are made about how/when/if the
            client contacts the user of the client about this decision. User
            input may be required in order to initiate the proposed
            mechanism.
</li>
<li>Client constructs an IMAP URL referencing the message part, and
            uses the <a class='info' href='#URLAUTH'>GENURLAUTH<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - URLAUTH Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [URLAUTH] command to
            generate a URLAUTH authorized IMAP URL.
</li>
<li>Client connects to a SIP Media Server using the Announcement
            Service as specified in <a class='info' href='#NETANN'>RFC 4240<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN], or
            the IVR Service as specified in <a class='info' href='#MSCML'>RFC
            5022<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML], and passes the URLAUTH authorized URL to the media
            server.
</li>
<li>Media Server connects to the IMAP Server specified in the
            referenced URL, and uses the IMAP <a class='info' href='#URLAUTH'>URLFETCH<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - URLAUTH Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [URLAUTH] command to retrieve the message
            part.
</li>
<li>Media server streams the retrieved message part to the client
            using <a class='info' href='#RTP'>RTP<span> (</span><span class='info'>Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, &ldquo;RTP: A Transport Protocol for Real-Time Applications,&rdquo; July&nbsp;2003.</span><span>)</span></a> [RTP].
</li>
<li>The media server or the client terminate the media streaming, or the streaming ends
              naturally. The SIP session is terminated by either client or server.
</li>
</ol>

<p>It should be noted that the proposed mechanism makes several
        assumptions about the mobile device, as well as available network services,
        namely: </p>
<ul class="text">
<li>Mobile device is provisioned with, or obtains via some
	    dynamic mechanism (see Section <a class='info' href='#discovery'>3.2<span> (</span><span class='info'>Media Server Discovery</span><span>)</span></a>), the location of a media
	    server which supports either <a class='info' href='#NETANN'>RFC
	    4240<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN] and/or <a class='info' href='#MSCML'>RFC 5022<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML].
</li>
<li>Media Server(s) used by the mobile device support the <a class='info' href='#IMAPURL'>IMAP URL<span> (</span><span class='info'>Newman, C. and A. Melnikov, &ldquo;IMAP URL Scheme,&rdquo; Oct&nbsp;2007.</span><span>)</span></a> [IMAPURL] scheme for the announcement
            and/or IVR services
</li>
<li>IMAP Server used by the mobile device supports generating
            anonymous IMAP URLs using the URLAUTH mechanism as well as
	    the IMAP <a class='info' href='#URLFETCH_BINARY'>URLFETCH BINARY<span> (</span><span class='info'>Cridland, D., &ldquo;Extended URLFETCH for Binary and Converted Parts,&rdquo; May&nbsp;2009.</span><span>)</span></a> [URLFETCH_BINARY] extension
</li>
</ul>

<a name="discovery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Media Server Discovery</h3>

<p>This section discusses possibilities for the automatic
	discovery of suitable media servers to perform streaming
	operations, and provides for such a mechanism using the IMAP
	<a class='info' href='#METADATA'>METADATA<span> (</span><span class='info'>Daboo, C., &ldquo;IMAP METADATA Extension,&rdquo; July&nbsp;2008.</span><span>)</span></a> [METADATA] extension.
</p>
<p>
        There are two possibilities for clients with regard to determining
        the hostname and port number information of a suitable media server:
        </p>
<ol class="text">
<li>No discovery of media servers is required: clients are
            configured with suitable media server information in an
            out-of-band manner.
</li>
<li>Discovery of media servers is required: clients use a
            discovery mechanism to determine a
            suitable media server that will be used for streaming multimedia 
	    message parts.
</li>
</ol>

<p>There are several scenarios where media server discovery would be a
        requirement for streaming to be successful: </p>
<ul class="text">
<li>Client is not configured with the address of any media
            servers.
</li>
<li>Client is configured with the address of one or more media
            servers, but the IMAP server is configured to only accept URLFETCH
            requests from specific media servers (for security or site policy
            reasons), and thus streaming would fail due to the media server
            not being able to retrieve the media from the IMAP server.
</li>
</ul>

<p>There is also a scenario where media server discovery would improve
        the security of the streaming mechanism, by avoiding the use of
        completely anonymous URLs. For example, the client could
        discover a media server address that was an authorised user of the IMAP
	server for streaming purposes, which would allow the client to generate a URL,
	which was secure in that it could *only* be accessed by an
	entity that is trusted by the IMAP Server to retrieve
	content. The issue of trust in media servers is discussed more
	fully in <a class='info' href='#security'>Section&nbsp;4<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>.
</p>
<p>This document describes using the IMAP <a class='info' href='#METADATA'>METADATA<span> (</span><span class='info'>Daboo, C., &ldquo;IMAP METADATA Extension,&rdquo; July&nbsp;2008.</span><span>)</span></a> [METADATA] extension, via the use of a server entry
        that provides the contact information for suitable media servers for
        use with the IMAP server. Media Server discovery is optional: clients
        are free to use pre-configured information about media servers, or to
        fall back to pre-configured information if they encounter IMAP servers
        that do not support either the METADATA extension or the proposed
        entry, or that do not provide a value for the entry.
</p>
<p>A METADATA entry with the name of "/shared/mediaServers" is
	used to store the locations of suitable media servers known to
	the IMAP server. The entry is formatted
        according to the formalSyntax specified in <a class='info' href='#formalsyntax'>Section&nbsp;8<span> (</span><span class='info'>Formal Syntax</span><span>)</span></a>. This consists of a tuple of a URI
        and optional "stream" string, where the URI is surrounded by &lt;&gt; symbols,
        the URI and "stream" are separated using a colon ":", and
	tuples are separated using a ";".
</p>
<p>The "stream" string (c.f. the "stream" access 
	identifier from <a class='info' href='#ACCESSID'>[ACCESSID]<span> (</span><span class='info'>Cook, N., &ldquo;Internet Message Access Protocol (IMAP) - URL Access Identifier Extension,&rdquo; March&nbsp;2009.</span><span>)</span></a>) is
	used to identify media servers capable of connecting to the
	IMAP server as users authorized to retrieve URLs constructed
	using the "stream" access identifier. It indicates that the client MUST 
	create the content URI using the "stream" access identifier. See <a class='info' href='#genurlauth'>Section&nbsp;3.3<span> (</span><span class='info'>Client use of GENURLAUTH Command</span><span>)</span></a> for a description of how the
	client should make use of the access identifier when generating IMAP
	URLs.)
</p>
<p>Example values of the /shared/mediaServers METADATA entry
	(N.B. Any line wrapping below is for the purpose of clarity):<br />
<br />

        "&lt;sip:ivr@ms.example.net:5060&gt;:stream;&lt;sip:annc@ms1.example.net:5060&gt;;&lt;sips:ivr@ms2.example.net:5061&gt;"
        <br />
<br />

        "&lt;sip:ivr@192.0.2.40:5060&gt;;&lt;sip:192.0.2.41:5060&gt;;&lt;sips:annc@192.0.2.42:5060&gt;:stream"
</p>
<p>
          It should be noted that the URI specified in the ABNF is
	  generic, i.e. not restricted to SIP URIs; however
	  this document only specifies how to make use of SIP
	  URIs. Additionally, the "userinfo" (known as the "service
	  indicator" in RFC 4240 and RFC 4722) component of the URI is
          optional; if specified it gives the client additional
	  information about the media server capabilities. For
	  example, a userinfo component of "annc" indicates that the
	  media server supports RFC 4240, and "ivr" indicates support
	  for RFC 4722. <a class='info' href='#clientdecision'>Section&nbsp;3.4<span> (</span><span class='info'>Client Determination of Media Server Capabilities</span><span>)</span></a>
	  further describes how clients should behave if the
	  "userinfo" component is not present.
        
</p>
<p>Clients SHOULD parse the value of the /shared/mediaServers
	entry, and contact a media server using one of the returned 
        URIs. The servers are returned in order of preference as suggested 
        by the server, however it is left to the client to decide if a
        different order is more appropriate when selecting the media server(s) 
        to contact, as well as the selection of alternates under
	failure conditions.
</p>
<p>Administrators configuring the values of the /shared/mediaServers
	entry, who do not know the capabilities of the media servers
	being configured, SHOULD NOT include a userinfo component as part of 
	of the URI, in which case the client will determine which
	service to use as specified in Section <a class='info' href='#clientdecision'>3.4<span> (</span><span class='info'>Client Determination of Media Server Capabilities</span><span>)</span></a>. Note that
	if a media server supports multiple services, a URI with the
	appropriate userinfo component SHOULD be configured for each
	service. 
</p>
<p>
	  Note that even though the media server address can be discovered
	  dynamically, it is assumed that the necessary security arrangements 
	  between the client and the media server already exist. For example,
	  the media server could use SIP digest authentication to provide
	  access only to authenticated clients; in this case, it is assumed
	  the username and password have already been set up.  Likewise, if
	  the client wants to authenticate the media server using e.g. TLS
	  and certificates, it is assumed the necessary arrangements (trust
	  anchors and so on) already exist.  In some deployments, the clients
	  and media servers may even be willing to rely on the security of
	  the underlying network, and omit authentication between the client
	  and the media server entirely. See Section <a class='info' href='#security'>4<span> (</span><span class='info'>Security Considerations</span><span>)</span></a> for more details.
	
</p>
<a name="genurlauth"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Client use of GENURLAUTH Command</h3>

<p>The decision to make use of streaming services for a message part
        will usually be predicated on the content type of the message part.
        Using the capabilities of the IMAP FETCH command, clients determine
        the <a class='info' href='#MIME'>MIME<span> (</span><span class='info'>Freed, N., Borenstein, N., Moore, K., Klensin, J., and J. Postel, &ldquo;Multipurpose Internet Mail Extensions (MIME),&rdquo; November&nbsp;1996.</span><span>)</span></a> [MIME] Content-Type of particular message
        parts and based on local policies or heuristics, decide that streaming
        for that message part will be attempted.
</p>
<p>Once the client has determined that a particular message part
        requires streaming, the client generates an IMAP URL that refers to
        the message part according to the method described in <a class='info' href='#IMAPURL'>RFC 5092<span> (</span><span class='info'>Newman, C. and A. Melnikov, &ldquo;IMAP URL Scheme,&rdquo; Oct&nbsp;2007.</span><span>)</span></a> [IMAPURL]. The client then begins the process
        of generating an URLAUTH URL, by appending ";EXPIRE=&lt;datetime&gt;"
        and ";URLAUTH=&lt;access&gt;" to the initial URL.
</p>
<p>The ";EXPIRE=&lt;datetime&gt;" parameter is optional, however it
        SHOULD be used, since the use of anonymous URLAUTH authorized URLs is
        a security risk (see <a class='info' href='#security'>Section&nbsp;4<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>, and
	doing so ensures that at some point in the 
        future, permission to access that URL will cease. IMAP server
	implementors may choose to reject anonymous URLs that are
	considered insecure (for example with an EXPIRE date too far
	in the future), as a matter of local security policy. To
	prevent this causing interoperability problems, IMAP servers
	that implement this profile MUST NOT reject GENURLAUTH commands
	for anonymous URLs on the basis of the EXPIRE time, if that
	time is equal to, or less than 1 hour in the future.
</p>
<p>The &lt;access&gt; portion of the URLAUTH URL MUST be
        'stream' (see <a class='info' href='#ACCESSID'>[ACCESSID]<span> (</span><span class='info'>Cook, N., &ldquo;Internet Message Access Protocol (IMAP) - URL Access Identifier Extension,&rdquo; March&nbsp;2009.</span><span>)</span></a>) if an out of
	band mechanism or the media server discovery mechanism
	discussed in <a class='info' href='#discovery'>Section&nbsp;3.2<span> (</span><span class='info'>Media Server Discovery</span><span>)</span></a> specifies that the
	media server is an authorized user of the IMAP server for the purposes of
	retrieving content via URLFETCH. Without specific prior knowledge 
        of such a configuration (either through the discovery
	mechanism described in this document, or by an out of band
	mechanism), the client SHOULD 
	use the 'stream' access identifier, which will cause
	streaming to fail if the media server is not an authorized
	user of the IMAP server for the purposes of streaming. 
	
</p>
<p>However, if the client wishes to take
	the risk associated with generating a URL that can be used by
	any media server (see <a class='info' href='#security'>Section&nbsp;4<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>), it MAY
	use 'anonymous' as the  &lt;access&gt; portion of the URLAUTH
	URL passed to the GENURLAUTH command. For example, the client
	may have been preconfigured with the address of media servers
	in the local administrative domain, (thus implying a level of
	trust in those media servers), without knowing whether those
	media servers have a pre-existing trust relationship with the
	IMAP server to be used (which may well be in a different
	administrative domain). See <a class='info' href='#security'>Section&nbsp;4<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>
	for a full discussion of the security issues.
</p>
<p>The client uses the URL generated as a parameter to the GENAUTHURL
        command, using the INTERNAL authorization mechanism. The URL returned
        by a successful response to this command will then be passed to the
        media server. If no successful response to the GENURLAUTH command is
        received, then no further action will be possible with respect to
        streaming media to the client.
</p>
<p>Examples:
</p>
<p>C: a122 UID FETCH 24356 (BODYSTRUCTURE) <br />
 S:
        * 26 FETCH (BODYSTRUCTURE (("TEXT" "PLAIN" <br />
 S:
        ("CHARSET" "US-ASCII") NIL<br />
 S:
          NIL "7BIT" 1152 23)("VIDEO" "MPEG" <br />

        NIL NIL "BASE64" 655350)) UID 24356)<br />

        S: a122 OK FETCH completed. <br />
 C: a123 GENURLAUTH
        "imap://joe@example.com/INBOX/;uid=24356/;<br />

        section=1.2;expire=2006-12-19T16:39:57-08:00;<br />

        urlauth=anonymous" INTERNAL <br />
 S: * GENURLAUTH
        "imap://joe@example.com/INBOX/;uid=24356/;<br />

        section=1.2;expire=2006-12-19T16:39:57-08:00;<br />

        urlauth=anonymous:<br />

        internal:238234982398239898a9898998798b987s87920" <br />
 S: a123 OK GENURLAUTH completed <br />
<br />

</p>
<p>C: a122 UID FETCH 24359 (BODYSTRUCTURE) <br />
 S:
          * 27 FETCH (BODYSTRUCTURE (("TEXT" "PLAIN" <br />
 S:
          ("CHARSET" "US-ASCII") NIL<br />
 S:
          NIL "7BIT" 1152 23)("AUDIO" "G729"<br />

          NIL NIL "BASE64" 87256)) UID 24359)<br />

          S: a122 OK FETCH completed. <br />
 C: a123 GENURLAUTH
        "imap://joe@example.com/INBOX/;uid=24359/;<br />

        section=1.3;expire=2006-12-19T16:39:57-08:00;<br />

        urlauth=stream" INTERNAL <br />
 S: * GENURLAUTH
        "imap://joe@example.com/INBOX/;uid=24359/;<br />

        section=1.3;expire=2006-12-20T18:31:45-08:00;<br />

        urlauth=stream:<br />

        internal:098230923409284092384092840293480239482" <br />
 S: a123 OK GENURLAUTH completed
</p>
<a name="clientdecision"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Client Determination of Media Server Capabilities</h3>

<p>Once an authorized IMAP URL has been generated, it is up to the
        client to pass that URL to a suitable media server that is capable of
        retrieving the URL via IMAP, and streaming the content to the client
        using the <a class='info' href='#RTP'>RTP<span> (</span><span class='info'>Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, &ldquo;RTP: A Transport Protocol for Real-Time Applications,&rdquo; July&nbsp;2003.</span><span>)</span></a> [RTP] protocol.
</p>
<p>
          This section specifies the behaviour of clients that have not determined,
          (either statically through configuration, or dynamically
	  through a discovery process as discussed in Section <a class='info' href='#discovery'>3.2<span> (</span><span class='info'>Media Server Discovery</span><span>)</span></a>), the
	  capabilities of the media server with respect to the
	  services (i.e. RFC 4240 or 5022) supported by that media
	  server. Clients that have determined those capabilities
	  should use the mechanisms described in Section <a class='info' href='#netanninvite'>3.5<span> (</span><span class='info'>Client Use of the Media Server Announcement Service</span><span>)</span></a> 
          or Section <a class='info' href='#mscmlinvite'>3.7<span> (</span><span class='info'>Client Use of the Media Server MSCML IVR Service</span><span>)</span></a>, as appropriate. 
        
</p>
<p>
	  If the client supports the MSCML IVR service, then it SHOULD attempt
	  to contact the media server using the MSCML protocol by sending a SIP
	  INVITE which has the service indicator "ivr".
	
</p>
<p>
	  Assuming the media server responds to the INVITE without error, the
	  client can carry on using the MSCML IVR service as specified in <a class='info' href='#mscmlinvite'>Section&nbsp;3.7<span> (</span><span class='info'>Client Use of the Media Server MSCML IVR Service</span><span>)</span></a>. If the media server responds with an
	  error indicating that the "ivr" service is not supported, then if the
	  client supports it, the client SHOULD attempt to contact the media
	  server using the Announcement Service, as described in <a class='info' href='#netanninvite'>Section&nbsp;3.5<span> (</span><span class='info'>Client Use of the Media Server Announcement Service</span><span>)</span></a>. 
	
</p>
<p>
	  The following example shows an example SIP INVITE using the "ivr"
	  service indicator: <br />
<br />
 
	  C: INVITE sip:ivr@ms2.example.com SIP/2.0 <br />

	&lt; SIP Header fields omitted for reasons of brevity &gt;
	
</p>
<a name="netanninvite"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
Client Use of the Media Server Announcement Service</h3>

<p>
	  Assuming the client or media server does not support use of the
	  MSCML protocol, the media server announcement service is used, as
	  described in <a class='info' href='#NETANN'>RFC 4240<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN]. This service
	  allows the client to send a SIP INVITE to a special username ('annc')
	  at the media server (the "announcement" user), supplying the URL
	  obtained as per <a class='info' href='#genurlauth'>Section&nbsp;3.3<span> (</span><span class='info'>Client use of GENURLAUTH Command</span><span>)</span></a>.
	
</p>
<p>
	  The SIP INVITE is constructed as shown in the examples below; note
	  that as per RFC 4240, the play parameter is mandatory, and specifies
	the authorized IMAP URL to be played.
	
</p>
<p>
	  Examples of valid SIP INVITE URIs sent to the media server
	  announcement service:
	
</p>
<p>
	  C: sip:annc@ms2.example.net;<br />

	  play=imap:%2F%2Fjoe@example.com%2FINBOX%2F%3Buid%3D24356%2F%3Bsection<br />

	  %3D1.2%3Bexpire%3D2006-12-19T16:39:57-08:00%3Burlauth%3Danonymous:<br />

	  internal:238234982398239898a9898998798b987s87920<br />

	  <br />
<br />

	  C: sip:annc@ms1.example.net;<br />

	  play=imap:%2F%2Ffred@example.com%2FINBOX%2F%3Buid%3D24359%2F%3Bsection<br />

	  %3D1.3%3Bexpire%3D2006-12-20T18:31:45-08:00%3Burlauth%3Dstream:<br />

	  internal:098230923409284092384092840293480239482<br />

	
</p>
<p>
	  Notice that many of the characters that are used as parameters of
	  the IMAP URI are escaped, as otherwise they would change the
	  meaning of the enclosing SIP URI, by being regarded as SIP
	  URI parameters instead of IMAP URL parameters. 
	
</p>
<p>
	  If the client receives a 200 (OK) response, the media server has
	  successfully retrieved the content from the IMAP server and the
	  negotiated RTP stream will shortly begin.
	
</p>
<p>
	  There are many possible response codes, however a response code of 404
	  received from the media server 
	  indicates that the content could not be found or could not be
	  retrieved for some reason. For example, the media server may not
	  support the use of IMAP URLs. At this point, there are several options
	  to the client, such as using alternate media servers, or giving up in
	  attempting to stream the required message part.
	
</p>
<a name="transcoding"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6"></a><h3>3.6.&nbsp;
Media Negotiation and Transcoding</h3>

<p>
	  This document uses standards and protocols from two traditionally
	  separate application areas: Mobile Email (primarily IMAP) and Internet
	  Telephony/Streaming (e.g. SIP/RTP). Since the document primarily
	  addresses enhancing the capabilities of mobile email, it is felt
	  worthwhile to give some examples of simple SIP/SDP exchanges, and
	  discussing capabilities such as media negotiation (using SDP) and
	  media transcoding.
	
</p>
<p>
	  In the below example, the client contacts the media server using
	  the SIP INVITE command to contact the Announcement service (see <a class='info' href='#netanninvite'>Section&nbsp;3.5<span> (</span><span class='info'>Client Use of the Media Server Announcement Service</span><span>)</span></a>), advertising support for a range of
	  audio and video codecs (using <a class='info' href='#SDP'>SDP<span> (</span><span class='info'>Handley, M., Jacobson, V., and C. Perkins, &ldquo;SDP: Session Description Protocol,&rdquo; July&nbsp;2006.</span><span>)</span></a> [SDP]), and in
	  response the media server advertises only a set of audio codecs. This
	  process is identical for the IVR service, except that the IVR service
	  does not use the SIP Request-URI to indicate the content to be played;
	  instead this is carried in a subsequent SIP INFO request.
	
</p>
<p>
	  The client and server now know from the SDP advertised by both
	  client and server that communication must be using the subset of audio
	  codecs supported by both client and server (in the example SDP, it is
	  clear that the server does not support any video codecs). The media
	  server may perform transcoding (i.e. converting between codecs) on the
	  media received from the IMAP server in order to satisfy the codecs
	  supported by the client: for example the media server may downgrade
	  the video retrieved from the IMAP server to the audio component
	  only.
	
</p>
<p>
	  For clients using the Announcement service, the media server MUST
	  return an error to the INVITE if it cannot find a common codec between
	  the client, server and media, or it cannot transcode to a suitable
	  codec. Similarly, for clients using the MSCML IVR service, the media
	  server MUST return a suitable error response to the
	  &lt;playcollect&gt; request.
	
</p>
<p>
	  Example SIP INVITE and SDP Media Negotiation
	
</p>
<p>
	  C: INVITE sip:annc@ms2.example.com;  <br />

	  play=imap:%2F%2Fjoe@example.com%2FINBOX%2F%3Buid%3D24356%2F%3B <br />

	  section%3D1.2%3Bexpire%3D2006-12-19T16:39:57-08:00%3Burlauth%3D <br />

	  anonymous:internal:238234982398239898a9898998798b987s87920 SIP/2.0 <br />

	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  C: To: NetAnn &lt;sip:annc@ms2.example.com&gt;<br />

	  C: Call-ID: 8204589102@example.com<br />

	  C: CSeq: 1 INVITE <br />

	  C: Contact: &lt;sip:UAA@192.0.2.40&gt; <br />

	  C: Content-Type: application/sdp <br />

	  C: Content-Length: 481 <br />

	  C: <br />

	  C: v=0 <br />

	  C: o=UserA 2890844526 2890844526 IN IP4 192.0.2.40 <br />

	  C: s=Session SDP <br />

	  C: c=IN IP4 192.0.2.40 <br />

	  C: t=3034423619 0 <br />

	  C: m=audio 9224 RTP/AVP 0 8 3 98 101 <br />

	  C: a=alt:1 1 : 01BB7F04 6CBC7A28 192.0.2.40 9224 <br />

	  C: a=fmtp:101 0-15<br />

	  C: a=rtpmap:98 ilbc/8000<br />

	  C: a=rtpmap:101 telephone-event/8000<br />

	  C: a=recvonly<br />

	  C: m=video 9226 RTP/AVP 105 34 120<br />

	  C: a=alt:1 1 : 01BCADB3 95DFFD80 192.0.2.40 9226<br />

	  C: a=fmtp:105 profile=3;level=20<br />

	  C: a=fmtp:34 CIF=2 QCIF=2 MAXBR=5120<br />

	  C: a=rtpmap:105 h263-2000/90000<br />

	  C: a=rtpmap:120 h263/90000<br />

	  C: a=recvonly<br />
 
	  <br />
<br />
 
	  S: SIP/2.0 200 OK<br />

	  S: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  S: To: NetAnn &lt;sip:annc@ms2.example.com&gt;<br />

	  S: Call-ID: 8204589102@example.com<br />

	  S: CSeq: 1 INVITE<br />

	  S: Contact: &lt;sip:netann@192.0.2.41&gt;<br />

	  S: Content-Type: application/sdp<br />

	  S: Content-Length: 317<br />

	  S: <br />

	  S: v=0<br />

	  S: o=NetAnn 2890844527 2890844527 IN IP4 192.0.2.41<br />

	  S: s=Session SDP<br />

	  S: c=IN IP4 192.0.2.41<br />

	  S: t=3034423619 0<br />

	  S: m=audio 17684 RTP/AVP 0 8 3 18 98 101<br />

	  S: a=rtpmap:0 PCMU/8000<br />

	  S: a=rtpmap:8 PCMA/8000<br />

	  S: a=rtpmap:3 GSM/8000<br />

	  S: a=rtpmap:18 G729/8000<br />

	  S: a=fmtp:18 annexb=no<br />

	  S: a=rtpmap:98 iLBC/8000<br />

	  S: a=rtpmap:101 telephone-event/8000<br />

	  S: a=fmtp:101 0-16<br />

	  <br />
<br />

	  C: ACK sip:netann@192.0.2.41 SIP/2.0<br />

	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  C: To: NetAnn &lt;sip:annc@ms2.example.com&gt;<br />

	  C: Call-ID: 8204589102@example.com<br />
 
	  C: CSeq: 1 ACK<br />

	  C: Content-Length: 0<br />

	
</p>
<a name="mscmlinvite"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.7"></a><h3>3.7.&nbsp;
Client Use of the Media Server MSCML IVR Service</h3>

<p>
	  Once the client has determined that the media server supports the
	  IVR service, it is up to the client to generate a suitable MSCML
	  request to initiate streaming of the required media.
	
</p>
<p>
	  When using the IVR service, the initial SIP invite is used only to
	  establish that the media server supports the MSCML IVR service, and to
	  negotiate suitable media codecs. Once the initial SIP INVITE and
	  response to that INVITE have been completed successfully, the client
	  must generate a SIP INFO request with MSCML in the body of the request
	  to initiate streaming.
	
</p>
<p>
	  The &lt;playcollect&gt; request is used, as this allows the use of
	  DTMF digits to control playback of the media, such as fast-forward or
	  rewind.
	
</p>
<p>
	  Since the playcollect request is used purely for its VCR
	  capabilities, there is no need for the media server to perform DTMF
	  collection, therefore the playcollect attributes "firstdigittimer",
	  "interdigittimer" and "extradigittimer" SHOULD all be set to "0ms",
	  which will have the effect of causing digit collection to cease
	  immediately after the media has finished playing.
	
</p>
<p>
	  The "ffkey" and "rwkey" attributes of &lt;playcollect&gt; are used
	  to control fast forward and rewind behaviour, with the "skipinterval"
	  attribute being used to control the 'speed' of these actions.
	
</p>
<p>
	  The &lt;prompt&gt; tag is used to specify the media to be played,
	  and SHOULD have a single &lt;audio&gt; tag that gives the URL of the
	  media, as per the <a class='info' href='#genurlauth'>Section&nbsp;3.3<span> (</span><span class='info'>Client use of GENURLAUTH Command</span><span>)</span></a>. The
	  audio-specific name of the tag is historical, as the tag can be used
	  for video as well as audio content. The "stoponerror" attribute SHOULD
	  be set to "yes", as then meaningful error messages will be returned by
	  the media server in the event of problems such as retrieving the media
	  from the IMAP server.
	
</p>
<p>
	  An example SIP INFO request using the &lt;playcollect&gt; request
	  is shown at the end of this section.
	
</p>
<p>
	  It should be noted that under normal (i.e. non-error) conditions,
	  the response to the &lt;playcollect&gt; request is a SIP 200 (OK)
	  response. The media server then streams the media, and only when the
	  media has finished playing (naturally or due to a user request), does
	  the media server send a &lt;playcollect&gt; response, which includes
	  details of the media played, such as length, and any digits
	  collected.
	
</p>
<p>
	  The client may suspend playback of the media at any time by either
	  sending the DTMF escape key (specified as an attribute to the
	  &lt;playcollect&gt; request) or by sending a &lt;stop&gt; request to
	  the media server in a SIP INFO request. Upon receipt of the request,
	  the media server will acknowledge it, and then cease streaming of the
	  media, followed by a SIP INFO request containing the
	  &lt;playcollect&gt; response.
	
</p>
<p>
	  If the media server cannot play the media for any reason, for
	  example if it cannot retrieve the media from the IMAP server,
	  streaming will not take place, and the &lt;playcollect&gt; response
	  will be sent, usually with meaningful values in the &lt;error_info&gt;
	  element.
	
</p>
<p>
	  The following gives an example dialog between a client and media
	  server, including a rewind request, and termination of the playback by
	  use of the escape key. Some elements of the SIP dialog such as full
	  SIP header fields and SDP are omitted for reasons of brevity. (The protocol
	  diagram in <a class='info' href='#mscml_protocol'>Section&nbsp;3.9.2<span> (</span><span class='info'>IVR Service Protocol Diagram</span><span>)</span></a> shows the high-level
	  message flow between all the components, including the IMAP
	  server.)
	
</p>
<p>
	  C: INVITE sip:ivr@ms.example.com SIP/2.0<br />

	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />
 
	  C: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />
 
	  C: Call-ID: 3298420296@example.com<br />

	  C: CSeq: 1 INVITE <br />

	  C: Contact: &lt;sip:UAA@192.0.2.40&gt; <br />

	  C: Content-Type: application/sdp <br />

	  C: Content-Length: XXX <br />

	  C: <br />

	  C: &lt;SDP Here&gt; <br />

	  <br />
<br />
 
	  S: SIP/2.0 200 OK<br />

	  S: From: UserA &lt;sip:UAA@example.com&gt;<br />
 
	  S: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />
 
	  S: Call-ID: 3298420296@example.com<br />
 
	  S: CSeq: 1 INVITE<br />
 
	  S: Contact: &lt;sip:ivr@192.0.2.41&gt;<br />
 
	  S: Content-Type: application/sdp<br />
 
	  S: Content-Length: XXX<br />

	  S: <br />

	  S: &lt;SDP Here&gt; <br />
 
	  <br />
<br />

	  C: ACK sip:ivr@ms.example.com SIP/2.0<br />
 
	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  C: To: IVR &lt;sip:ivr@ms2.example.com&gt;<br />
 
	  C: Call-ID: 3298420296@example.com<br />
 
	  C: CSeq: 1 ACK<br />
 
	  C: Content-Length: 0<br />

	  <br />
<br />

	  C: INFO sip:ivr@192.0.2.41 SIP/2.0<br />

	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  C: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />

	  C: Call-ID: 3298420296@example.com<br />
 
	  C: CSeq: 2 INFO<br />
 
	  C: Content-Type: application/mediaservercontrol+xml<br />
 
	  C: Content-Length: 423 <br />

	  C: <br />

	  C: &lt;?xml version="1.0"?&gt;<br />

	  C: &lt;MediaServerControl version="1.0"&gt;<br />

	  C: &lt;request&gt;<br />

	  C: &lt;playcollect id="332985001"<br />

	  C: firstdigittimer="0ms" interdigittimer="0ms" extradigittimer="0ms"<br />

	  C: skipinterval="6s" ffkey="6" rwkey="4" escape="*"&gt;<br />
 
	  C: &lt;prompt stoponerror="yes" <br />

	  C: locale="en_US" offset="0" gain="0" rate="0"<br />

	  C: delay="0" duration="infinite" repeat="0"&gt;<br />

	  C: &lt;audio url="imap://joe@example.com/INBOX/;uid=24356/;section=1.2; <br />

	  expire=2006-12-19T16:39:57-08:00;urlauth=anonymous:<br />

	  internal:238234982398239898a9898998798b987s87920"/&gt;<br />

	  C: &lt;/prompt&gt;<br />
 
	  C: &lt;/playcollect&gt;<br />

	  C: &lt;/request&gt;<br />

	  C: &lt;/MediaServerControl&gt;<br />
<br />
 
	  S: SIP/2.0 200 OK<br />
 
	  S: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  S: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />
 
	  S: Call-ID: 3298420296@example.com<br />

	  S: CSeq: 2 INFO<br />
 
	  S: Contact: &lt;sip:ivr@192.0.2.41&gt;<br />

	  S: Content-Length: 0<br />
<br />

	  S: &lt;Media Server retrieves media from IMAP Server and streams to client&gt; <br />
<br />
 
	  C: &lt;Client streams 6 key&gt;<br />
<br />
 
	  S: &lt;Media Server fast forwards media by 6 seconds&gt; <br />
<br />

	  C: &lt;Client streams * key&gt;<br />
<br />

	  S: &lt;Media Server stops streaming&gt; <br />
<br />
 
	  S: INFO sip:UAA@192.0.2.40 SIP/2.0<br />
 
	  S: From: IVR &lt;sip:ivr@ms.example.com&gt;<br />

	  S: To: UserA &lt;sip:UAA@example.com&gt;<br />
 
	  S: Call-ID: 3298420296@example.com<br />

	  S: CSeq: 5 INFO<br />
 
	  S: Contact: &lt;sip:ivr@192.0.2.41&gt;<br />
 
	  S: Content-Type: application/mediaservercontrol+xml<br />

	  S: Content-Length: XXX<br />

	  S: <br />

	  S: &lt;?xml version="1.0"?&gt;<br />

	  S: &lt;MediaServerControl version="1.0"&gt;<br />
 
	  S: &lt;response id="332985001" request="playcollect" code="200" <br />

	  S: reason="escapekey" playduration="34s"<br />
 
	  S: playoffset="34s" digits="" /&gt; <br />

	  S: &lt;/MediaServerControl&gt;<br />
<br />
 
	  C: SIP/2.0 200 OK <br />
 
	  C: From: IVR &lt;sip:ivr@ms.example.com&gt;<br />

	  C: To: UserA &lt;sip:UAA@example.com&gt;<br />
 
	  C: Call-ID: 3298420296@example.com<br />
 
	  C: CSeq: 5 INFO<br />

	  C: Content-Length: 0<br />
 
	  <br />
<br />

	  C: BYE sip:ivr@192.0.2.41 SIP/2.0 <br />
 
	  C: From: UserA &lt;sip:UAA@example.com&gt;<br />
 
	  C: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />
 
	  C: Call-ID: 3298420296@example.com<br />
 
	  C: CSeq: 6 BYE<br />
 
	  C: Content-Length: 0<br />
<br />

	  S: SIP/2.0 200 OK<br />

	  S: From: UserA &lt;sip:UAA@example.com&gt;<br />

	  S: To: IVR &lt;sip:ivr@ms.example.com&gt;<br />
 
	  S: Call-ID: 3298420296@example.com<br />
 
	  S: CSeq: 6 BYE<br />
 
	  S: Contact: &lt;sip:ivr@192.0.2.41&gt;<br />
 
	  S: Content-Length: 0
	
</p>
<a name="urlfetch"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.8"></a><h3>3.8.&nbsp;
Media Server Use of IMAP Server</h3>

<p>
	  This section describes how the media server converts the IMAP URL
	  received via the announcement or IVR service into suitable IMAP
	  commands for retrieving the content.
	
</p>
<p>
	  The media server first connects to the IMAP server specified in the
	  URL. Once connected, the media server SHOULD use <a class='info' href='#TLS'>TLS<span> (</span><span class='info'>Dierks, T. and E. Rescorla, &ldquo;The TLS Protocol,&rdquo; August&nbsp;2008.</span><span>)</span></a> [TLS] to encrypt the communication path.
	
</p>
<p>
	  If the media server has a user identity on the IMAP server, the media
	  server SHOULD authenticate itself to the IMAP server using the media
	  server's user identity.
	
</p>
<p>
	  If the media server is not configured as an authorized user of the
	  IMAP server, then the behaviour specified in <a class='info' href='#IMAPURL'>IMAP URL bis4<span> (</span><span class='info'>Newman, C. and A. Melnikov, &ldquo;IMAP URL Scheme,&rdquo; Oct&nbsp;2007.</span><span>)</span></a> [IMAPURL] MUST be followed. That is, if the
	  server advertises AUTH=ANONYMOUS IMAP capability, the media
	  server MUST use the AUTHENTICATE command with <a class='info' href='#ANONYMOUS'>ANONYMOUS<span> (</span><span class='info'>Zeilenga, K., &ldquo;Anonymous SASL Mechanism,&rdquo; June&nbsp;2006.</span><span>)</span></a> [ANONYMOUS] SASL mechanism.  If SASL
	  ANONYMOUS is not available, the user name "anonymous" is
	  used with the "LOGIN" command and the password is supplied
	  as the Internet e-mail address of the administrative contact
	  for the media server.
	
</p>
<p>
	  Once authenticated, the media server issues the URLFETCH command,
	  using the URL supplied in the 'play' parameter of the SIP INVITE (or
	  audio tag of the MSCML). If the IMAP server does not advertise URLAUTH=BINARY in its
	  post-authentication capability string, then the media server returns a
	  suitable error code to the client.
	
</p>
<p>
	  The additional parameters to the URLFETCH command
	  specified in <a class='info' href='#URLFETCH_BINARY'>(URLFETCH
	  BINARY)<span> (</span><span class='info'>Cridland, D., &ldquo;Extended URLFETCH for Binary and Converted Parts,&rdquo; May&nbsp;2009.</span><span>)</span></a> [URLFETCH_BINARY] are used by the media server to tell the IMAP
	  server to remove any transfer encoding and return the content
	  type of the media (as content type information is not
	  contained in the IMAP URL).
	
</p>
<p> 
	  A successful URLFETCH command will return the message part
	  containing the media to be streamed.
	  If the URLFETCH was unsuccessful, then the media server MUST return an
	  appropriate error response to the client.
	
</p>
<p>
	  Assuming the content is retrieved successfully, the
	  media server returns a 200 (OK) response code to the client. After an
	  ACK is received, an RTP stream is delivered to the client using the
	  parameters negotiated in the SDP.
	
</p>
<p>
	  If appropriate, the media server MAY choose to implement connection
	  caching, in which case connection and disconnection from the IMAP
	  server are handled according to whatever algorithm the media server
	  chooses. For example, the media server may know, a priori, that it
	  will always access the same IMAP server using the same login
	  credentials with an access pattern that would benefit from connection
	  caching, without unduly impacting server resources.
	
</p>
<p>Examples:
</p>
<p>
	  C: a001 LOGIN anonymous null <br />
 
	  S: a001 OK LOGIN completed. <br />
 
	  C: a002 URLFETCH
	  ("imap://joe@example.com/INBOX/;uid=24356/;section=1.2;<br />

	  expire=2006-12-19T16:39:57-08:00;urlauth=anonymous:<br />

	  internal:238234982398239898a9898998798b987s87920" BODYPARTSTRUCTURE BINARY) <br />
 
	  S: * URLFETCH "imap://joe@example.com/INBOX/;uid=24356/;<br />

	  section=1.2;expire=2006-12-19T16:39:57-08:00;urlauth=anonymous:<br />

	  internal:238234982398239898a9898998798b987s87920" <br />

	  (BODYPARTSTRUCTURE ("VIDEO" "MPEG" () NIL NIL "BINARY" 655350)) 
	  (BINARY ~{655350} <br />
 
	  S: [ ~655350 octets of binary data, containing NUL octets ]) <br />

	  S: a002 OK URLFETCH completed. <br />

	  C: a003 LOGOUT <br />

	  S: a003 OK LOGOUT completed.
	
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.9"></a><h3>3.9.&nbsp;
Protocol Diagrams</h3>

<p>
	  This section gives examples of using the mechanism described in the
	  document to stream media from a media server to a client, fetching the
	  content from an IMAP server. In all of the examples, the IMAP, SIP and
	  RTP protocols use the line styles "-", "=", and "+",
	  respectively. 
	
</p>
<a name="netann_protocol"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.9.1"></a><h3>3.9.1.&nbsp;
Announcement Service Protocol Diagram</h3>

<p>
	      The following diagram shows the protocol interactions
	      between the email client, the IMAP server and the media
	      server when the client uses the Announcement Service.
	    
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Client                     IMAP Server                   Media Server
  |   FETCH (BODYSTRUCTURE)     |                              |
  |----------------------------&gt;|                              |
  |           OK                |                              |
  |&lt;----------------------------|                              |
  |   GENURLAUTH                |                              |
  |----------------------------&gt;|                              |
  |           OK                |                              |
  |&lt;----------------------------|                              |
  |                             |                              |
  |                          SIP INVITE                        |
  |===========================================================&gt;|
  |                             |                              |
  |                             |          URLFETCH            |
  |                             |&lt;-----------------------------|
  |                             |             OK               |
  |                             |-----------------------------&gt;|
  |                             |                              |
  |                          200 OK                            |
  |&lt;===========================================================|
  |                          ACK                               |
  |===========================================================&gt;|
  |                             |                              |
  |                    Stream Message Part (RTP)               |
  |&lt;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|
  |                             |                              |
  |                            BYE                             |
  |&lt;===========================================================|
  |                          200 OK                            |
  |===========================================================&gt;|

</pre></div>
<a name="mscml_protocol"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.9.2"></a><h3>3.9.2.&nbsp;
IVR Service Protocol Diagram</h3>

<p>
	      The following diagram shows a simplified view of the
	      protocol interactions between the email client, the IMAP server
	      and the media server when the client uses the MSCML IVR
	      Service.
	    
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Client                     IMAP Server                   Media Server
  |   FETCH (BODYSTRUCTURE)     |                              |
  |----------------------------&gt;|                              |
  |           OK                |                              |
  |&lt;----------------------------|                              |
  |   GENURLAUTH                |                              |
  |----------------------------&gt;|                              |
  |           OK                |                              |
  |&lt;----------------------------|                              |
  |                             |                              |
  |                          SIP INVITE                        |
  |===========================================================&gt;|
  |                             |                              |
  |                          200 OK                            |
  |&lt;===========================================================|
  |                          ACK                               |
  |===========================================================&gt;|
  |                             |                              |
  |                          SIP INFO (playcollect)            |
  |===========================================================&gt;|
  |                             |                              |
  |                          200 OK                            |
  |&lt;===========================================================|
  |                             |                              |
  |                             |          URLFETCH            |
  |                             |&lt;-----------------------------|
  |                             |             OK               |
  |                             |-----------------------------&gt;|
  |                             |                              |
  |                    Stream Message Part (RTP)               |
  |&lt;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|
  |                             |                              |
  |                          SIP INFO (e.g., DTMF ff)          |
  |===========================================================&gt;|
  |                          200 OK                            |
  |&lt;===========================================================|
  |                             |                              |
  |                    Continue streaming (RTP)                |
  |&lt;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|
  |                             |                              |
  |                (Streaming Ends or is terminated)           |
  |                             |                              |
  |                     SIP INFO (playcollect response)        |
  |&lt;===========================================================|
  |                            BYE                             |
  |===========================================================&gt;|
  |                           200 OK                           |
  |&lt;===========================================================|

</pre></div>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Security Considerations</h3>

<p>
	This document proposes the use of <a class='info' href='#URLAUTH'>URLAUTH<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - URLAUTH Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [URLAUTH]
	"pawn tickets", received over <a class='info' href='#IMAP'>IMAP<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol - Version 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a> [IMAP], and transmitted 
	over <a class='info' href='#SIP'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [SIP], possibly within the MSCML payload of 
	<a class='info' href='#MSCML'>RFC 5022<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML], in order to stream media received in messages.
	As such, the security considerations in all these documents apply to this specification.
      
</p>
<p>
	In summary, as the authorized URLs may grant access to data, implementors of this 
	specification need to consider the following with respect to
	the security implications of using IMAP URLs:
        </p>
<ul class="text">
<li>
	    Use of an anonymous pawn ticket grants
            access to any client of the IMAP server without requiring any
            authentication credentials. The security mechanisms 
            referenced above (with the caveats specified below) SHOULD
	    be used to prevent unauthorized access to the pawn ticket. 
          
</li>
<li>
	    Use of pawn tickets that contain the "stream" access identifier
	    restricts access to the content to those entities that are
	    authorized users of the IMAP server for the purposes of
	    streaming retrieved content. Use of such pawn tickets is thus
	    desirable and so implementors should consult <a class='info' href='#genurlauth'>Section&nbsp;3.3<span> (</span><span class='info'>Client use of GENURLAUTH Command</span><span>)</span></a>, which
	    describes when such pawn tickets should be used.
	  
</li>
<li>
	    If the announcement service is used to set up streaming, then 
	    <a class='info' href='#NETANN'>RFC 4240<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> [NETANN] specifies that the
	    pawn ticket is passed in the Request-URI, and so untrusted
	    third-parties may be able to intercept the pawn
	    ticket. The SIP communication channel MAY be
	    secured by using sips: URIs <a class='info' href='#SIP'>[SIP]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, which
	    would provide hop-by-hop TLS encryption.
          
</li>
<li>
            If the IVR service (<a class='info' href='#MSCML'>RFC 5022<span> (</span><span class='info'>Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;Media Server Control Markup Language,&rdquo; Sep&nbsp;2007.</span><span>)</span></a> [MSCML])
	    is used to setup and control streaming, then MSCML is used
	    to carry the pawn ticket in the body of the request, and
	    so untrusted third-parties may be able to intercept the
	    pawn ticket. This MAY be secured by using sips: URIs <a class='info' href='#SIP'>[SIP]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, which would provide hop-by-hop TLS
	    encryption.
          
</li>
<li>
	    Using sips: in the above situations protects the pawn
	    ticket from third-parties, however, it still allows
	    proxies access to the pawn ticket, which could result in
	    misuse by malicious proxies, see note below.
	  
</li>
</ul><p>
      
</p>
<p>
	This document describes a mechanism that makes use of two
	separate servers to achieve the goal of streaming the content
	desired by the client. A major security implication of this is
	that the media server and IMAP server may well be located in
	separate administrative domains. This leads us to consider the
	security implications of a three-way protocol exchange, and
	the potential trust model implicit in that tripartate
	relationship. The security implications of the individual
	protocols have already been referenced, therefore this section
	describes the security considerations specific to the
	three-way data exchange, specifically:
	</p>
<ul class="text">
<li>
	    The client grants the media server full access to the
	    potentially-private media content specified by the IMAP URL.  As a
	    result, the client is responsible for verifying the authenticity of
	    the media server to a degree it finds acceptable for the
	    content (we can refer to this process as determining the
	    "trust" that the client has in a particular media server).
	    The security mechanisms provided by SIP <a class='info' href='#SIP'>[SIP]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and RTP <a class='info' href='#RTP'>[RTP]<span> (</span><span class='info'>Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, &ldquo;RTP: A Transport Protocol for Real-Time Applications,&rdquo; July&nbsp;2003.</span><span>)</span></a> may be
	    used for this purpose, as well as out of band
	    mechanisms such as pre-configuration.
	  
</li>
<li>
	    However, since the media server will retrieve content
	    from an IMAP server on the user's behalf, the issue of
	    security between the IMAP server and the media server 
	    also needs to be considered. A client has no way of
	    determining (programatically at least) the security of the
	    exchanges between the media server and the IMAP
	    server. However, it can determine, using the "stream" token
	    that is part of the media server
	    discovery mechanism described in <a class='info' href='#discovery'>Section&nbsp;3.2<span> (</span><span class='info'>Media Server Discovery</span><span>)</span></a>, that the media server has a
	    pre-existing authentication relationship with the IMAP
	    server for the purposes of retrieving content using IMAP
	    URLs. The IMAP server administrator may put pre-requisites
	    on media server administrator before this
	    relationship can be established, for example to guarantee
	    the security of the communication between the media server
	    and the IMAP server.
	  
</li>
<li>
	    The above two security considerations will influence the decision
	    the client makes with regards to generation of the pawn ticket
	    that is subsequently passed to the media server. This
	    document mandates the use of URLs protected with the
	    "stream" access identifier where the client knows in advance
	    that the "stream" authentication relationship 
	    between media server and IMAP server exists. However, it
	    does allow the use of anonymous pawn tickets where the
	    possibility exists that use of "stream" would cause
	    streaming to fail.
	  
</li>
<li> 
	    There exists the possibility of several types of attack by
	    a malicious media server, SIP proxy or other network
	    elements even against pawn tickets 
	    protected with the "stream" access identifier. All of
	    these attacks allow access to the RTP stream, if not the
	    original content. These attacks include:
	    
<ul class="text">
<li>
		The client contacts a malicious media server, MS1 ,
		and that media server MS1 then proxies the streaming
		request to a second media server, MS2, that it has
		determined or guessed to have "stream" authorization
		credentials with the IMAP server specified in the pawn
		ticket. The media server can then redirect the
		streamed RTP traffic elsewhere.
	      
</li>
<li>
		Any proxy on the path between the client and the media
		server has  access to the client's message in
		cleartext. In this case a malicious proxy
		could perform a man-in-the-middle attack and could
		change the message to redirect RTP traffic
		elsewhere. 
	      
</li>
<li>
		Any network element that is able to "see" the traffic
		between the client and the media server (or between
		any two proxies) can capture the pawn ticket, and then
		reissue a request using that pawn ticket to the same
		media server. Again the streamed traffic can be
		redirected to any desired location.
	      
</li>
</ul>
          
</li>
</ul><p>
      
</p>
<p>
	Media servers handling streaming requests will be making use
	of pawn ticket URLs for the period of time required to process
	the streaming request, after which the URL will be
	forgotten. However, media servers may log the URLs received from
	clients, in which case the private data contained in
	the IMAP server could be accessed by a malicious or curious
	media server administrator. Even URLs protected with EXPIRE
	may be accessed within the period of expiry. Therefore, media
	servers SHOULD remove or anonymize the internal portion of the
	IMAP URL when logging that URL.
      
</p>
<p>
	Additionally, many of the security considerations in the
	Message Submission BURL Extension apply to this document,
	particularly around the use of pawn tickets and prearranged trust
	relationships such as those described above.
      
</p>
<p>
	Message parts that are encrypted using mechanisms
	such as <a class='info' href='#SMIME'>S/MIME<span> (</span><span class='info'>Ramsdell, B., &ldquo;S/MIME Version 3.1 Message Specification&quot;,&rdquo; July&nbsp;2004.</span><span>)</span></a> [SMIME], are designed to
	prevent third-parties from accessing the data, thus media
	servers will not be able to fulfil streaming requests for
	messages parts that are encrypted.
      
</p>
<a name="IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IANA Considerations</h3>

<p>
	IANA is requested to register the following [METADATA]
	server entry to be used for media server discovery, using the
	[METADATA] registry.<br />
<br />
 
	To: iana@iana.org <br />
<br />
 
	Subject: IMAP METADATA Entry Registration <br />
<br />
 
	Type: Server<br />
<br />

	Name: /shared/mediaServers <br />
<br />

        Description: Defines a set of URIs containing the locations of
	suitable media servers for streaming multimedia content 
	<br />
<br />
 
	Content-type: text/plain;charset=utf-8
        <br />
<br />

	Contact: neil.cook@noware.co.uk 
      
</p>
<a name="drm"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Digital Rights Management (DRM) Issues</h3>

<p>
	This document does not specify any Digital Rights Management (DRM)
	mechanisms for controlling access to and copying of the media to be
	streamed. This is intentional. A reference to a piece of media content
	is created using the <a class='info' href='#URLAUTH'>URLAUTH<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - URLAUTH Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [URLAUTH] command; 
	any DRM required thus should be implemented within the media itself, 
	as implementing checks within URLAUTH could affect any use of the URLAUTH
	command, such as the <a class='info' href='#BURL'>BURL<span> (</span><span class='info'>Newman, C., &ldquo;Message Submission BURL Extension,&rdquo; May&nbsp;2006.</span><span>)</span></a> [BURL] command for message
	submission.
      
</p>
<p>
	The use of URLAUTH in this specification is believed to be pursuant with,
	and used only for, the execution of those rights to be expected when media
	is sent via traditional internet messaging, and causes no duplication of 
	media content which is not essentially provided by the action of sending the 
	message; that is, the use of the content for downloading and viewing, which 
	*is* implicitly granted by the sender of the message, in as much as the sender
	has the right to grant such rights.
      
</p>
<p>
	The document author believes that if DRM is a requirement for Internet
	messaging, then a suitable DRM mechanism should be created. How such a
	mechanism would work is outside the scope of this document.
      
</p>
<a name="deployment"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Deployment Considerations</h3>

<p>
	  This document assumes an Internet deployment where there are no
	  network restrictions between the different components. Specifically,
	  it does not address issues that can occur when network policies
	  restrict the communication between different components, especially
	  between the media server and the IMAP server, and between the client
	  the media server. In particular, RFC 5022 states that "It is unlikely, 
	  but not prohibited, for end-user SIP UACs to have a direct signaling 
	  relationship with a media server." This caveat makes it likely
	  that firewalls and other network security mechanisms will be configured
	  to block direct end-user access to media servers.
        
</p>
<p>
	  In order for either of the streaming mechanisms described in this document
	  to work, local administrators MUST relax firewalls policies such that appropriate
	  SIP UACs running on mobile devices are permitted to access the media servers
	  directly using the SIP protocol. The detail of how the restrictions are
	  relaxed, (for example, only allowing clients connecting from
	  the network space owned/maintained by the operator of the
	  media server) is a matter of local policy, and so is outside
	  the scope of this document.
	
</p>
<a name="formalsyntax"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Formal Syntax</h3>

<p>
	The following syntax specification for the mediaServer METADATA entry
	value uses the Augmented Backus-Naur Form (ABNF) notation as specified
	in <a class='info' href='#ABNF'>RFC 5234<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; Jan&nbsp;2008.</span><span>)</span></a> [ABNF] and the "absolute-URI" definition from
	<a class='info' href='#RFC3986'>RFC 3986<span> (</span><span class='info'>Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;Generic URI Syntax,&rdquo; Jan&nbsp;2005.</span><span>)</span></a> [RFC3986].
      
</p>
<p>
	Except as noted otherwise, all alphabetic characters are case-
	insensitive. The use of upper or lower case characters to define token
	strings is for editorial clarity only. Implementations MUST accept these
	strings in a case-insensitive fashion.
      
</p>
<p>
	media-servers = ms-tuple *(";" ms-tuple) <br />
<br />

        ms-tuple = "&lt;" absolute-URI "&gt;" [":" "stream"] <br />
<br />

      
</p>
<a name="contrib"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Contributors</h3>

<p>Eric Burger, eburger@standardstrack.com
</p>
<p>
	Eric Burger provided the initial inspiration for this document, along
	with advice and support on aspects of the media server IVR and
	Announcement services, as well as help with the IETF process.
      
</p>
<p>
	Many people made helpful comments on the document, including
	Alexey Melnikov, Dave Cridland, Martijn Koster, and a variety
	of folks in the Lemonade and Sipping WGs. 
      
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="NETANN">[NETANN]</a></td>
<td class="author-text">Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;<a href="http://tools.ietf.org/html/rfc4240">Basic Network Media Services with SIP</a>,&rdquo; RFC&nbsp;4240, December&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAP">[IMAP]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3501">Internet Message Access Protocol - Version 4rev1</a>,&rdquo; RFC&nbsp;3501, March&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="URLAUTH">[URLAUTH]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc4467">Internet Message Access Protocol (IMAP) - URLAUTH Extension</a>,&rdquo; RFC&nbsp;4467, May&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAPURL">[IMAPURL]</a></td>
<td class="author-text">Newman, C. and A. Melnikov, &ldquo;<a href="http://tools.ietf.org/html/rfc5092">IMAP URL Scheme</a>,&rdquo; RFC&nbsp;5092, Oct&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="SIP">[SIP]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002.</td></tr>
<tr><td class="author-text" valign="top"><a name="RTP">[RTP]</a></td>
<td class="author-text">Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, &ldquo;<a href="http://tools.ietf.org/html/rfc3550">RTP: A Transport Protocol for Real-Time Applications</a>,&rdquo; RFC&nbsp;3550, July&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="KEYWORDS">[KEYWORDS]</a></td>
<td class="author-text">Bradner, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement
          Levels</a>,&rdquo; RFC&nbsp;2119, BCP&nbsp;14, March&nbsp;1997.</td></tr>
<tr><td class="author-text" valign="top"><a name="MIME">[MIME]</a></td>
<td class="author-text">Freed, N., Borenstein, N., Moore, K., Klensin, J., and J. Postel, &ldquo;<a href="http://tools.ietf.org/html/rfc2045">Multipurpose Internet Mail Extensions (MIME)</a>,&rdquo; RFC&nbsp;2045, RFC&nbsp;2046, RFC&nbsp;2047, RFC&nbsp;2048, RFC&nbsp;2049, November&nbsp;1996.</td></tr>
<tr><td class="author-text" valign="top"><a name="TLS">[TLS]</a></td>
<td class="author-text">Dierks, T. and E. Rescorla, &ldquo;<a href="http://tools.ietf.org/html/rfc5246">The TLS Protocol</a>,&rdquo; RFC&nbsp;5246, August&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="SDP">[SDP]</a></td>
<td class="author-text">Handley, M., Jacobson, V., and C. Perkins, &ldquo;<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>,&rdquo; RFC&nbsp;4566, July&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="MSCML">[MSCML]</a></td>
<td class="author-text">Van Dyke, J., Burger, E., and A. Spitzer, &ldquo;<a href="http://tools.ietf.org/html/rfc5022">Media Server Control Markup Language</a>,&rdquo; RFC&nbsp;5022, Sep&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="URLFETCH_BINARY">[URLFETCH_BINARY]</a></td>
<td class="author-text">Cridland, D., &ldquo;<a href="http://tools.ietf.org/html/rfc5524">Extended URLFETCH for Binary and Converted Parts</a>,&rdquo; RFC&nbsp;5524, May&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="ACCESSID">[ACCESSID]</a></td>
<td class="author-text">Cook, N., &ldquo;Internet Message Access Protocol (IMAP) - URL Access Identifier Extension,&rdquo; draft-ncook-urlauth-accessid-02.txt (Work in Progress)&nbsp;, March&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="METADATA">[METADATA]</a></td>
<td class="author-text">Daboo, C., &ldquo;<a href="http://tools.ietf.org/html/rfc5464">IMAP METADATA Extension</a>,&rdquo; RFC&nbsp;5464, July&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="ABNF">[ABNF]</a></td>
<td class="author-text">Crocker, D. and P. Overell, &ldquo;<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; RFC&nbsp;5234, Jan&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3986">[RFC3986]</a></td>
<td class="author-text">Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;<a href="http://tools.ietf.org/html/rfc3986">Generic URI Syntax</a>,&rdquo; RFC&nbsp;3986, Jan&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="ANONYMOUS">[ANONYMOUS]</a></td>
<td class="author-text">Zeilenga, K., &ldquo;<a href="http://tools.ietf.org/html/rfc4505">Anonymous SASL Mechanism</a>,&rdquo; RFC&nbsp;4505, June&nbsp;2006.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="BURL">[BURL]</a></td>
<td class="author-text">Newman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4468">Message Submission BURL Extension</a>,&rdquo; RFC&nbsp;4468, May&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="SMIME">[SMIME]</a></td>
<td class="author-text">Ramsdell, B., &ldquo;<a href="http://tools.ietf.org/html/rfc3851">S/MIME Version 3.1 Message Specification"</a>,&rdquo; RFC&nbsp;3851, July&nbsp;2004.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Neil L Cook</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cloudmark</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:neil.cook@noware.co.uk">neil.cook@noware.co.uk</a></td></tr>
</table>
</body></html>
