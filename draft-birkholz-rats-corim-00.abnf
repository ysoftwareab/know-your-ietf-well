start = corim

signed-corim = #6.18(COSE-Sign1-corim)

protected-signed-corim-header-map = {
     corim.alg-id => int
     corim.content-type => "application/rim+cbor"
     corim.issuer-key-id => bstr
     corim.meta => corim-meta-map
     * cose-label => cose-values
unprotected-signed-corim-header-map = {
     * cose-label => cose-values
COSE-Sign1-corim = [
     protected: bstr .cbor protected-signed-corim-header-map
     unprotected: unprotected-signed-corim-header-map
     payload: bstr .cbor unsigned-corim-map
     signature: bstr
corim-meta-map = {
     corim.signer => one-or-more<corim-entity-map>
     ? corim.validity => validity-map
corim-entity-map = {
     corim.entity-name => $entity-name-type-choice
     ? corim.reg-id => uri
     corim.role => $corim-role-type-choice
     * $$corim-entity-map-extension
validity-map = {
     ? corim.not-before => time
     corim.not-after => time
unsigned-corim-map = {
     corim.id => $corim-id-type-choice
     corim.tags => one-or-more<$concise-tag-type-choice>
     ? corim.dependent-rims => one-or-more<corim-locator-map>
     * $$unsigned-corim-map-extension
corim-locator-map = {
     corim.href => uri
     ? corim.thumbprint => hash-entry
concise-mid-tag = {
     ? comid.language => language-type
     comid.tag-identity => tag-identity-map
     ? comid.entity => one-or-more<entity-map>
     ? comid.linked-tags => one-or-more<linked-tag-map>
     comid.triples => triples-map
     * $$concise-mid-tag-extension
tag-identity-map = {
     comid.tag-id => $tag-id-type-choice
     comid.tag-version => tag-version-type
     * $$tag-identity-map-extension
tag-version-type = uint .default 0

entity-map = {
     comid.entity-name => $entity-name-type-choice
     ? comid.reg-id => uri
     comid.role => one-or-more<$comid-role-type-choice>
     * $$entity-map-extension
linked-tag-map = {
     comid.linked-tag-id => $tag-id-type-choice
     comid.tag-rel => $tag-rel-type-choice
triples-map = non-empty<{
     ? comid.reference-triples => one-or-more<reference-triple-record>
     ? comid.endorsed-triples => one-or-more<endorsed-triple-record>
     ? comid.attest-key-triples => one-or-more<attest-key-triple-record>
     ? comid.identity-triples => one-or-more<identity-triple-record>
     * $$triples-map-extension
environment-map = non-empty<{
     ? comid.class => class-map
     ? comid.instance => $instance-id-type-choice
     ? comid.group => $group-id-type-choice
class-map = non-empty<{
     ? comid.class-id => $class-id-type-choice
     ? comid.vendor => tstr
     ? comid.model => tstr
     ? comid.layer => uint
     ? comid.index => uint
measurement-map = {
     ? comid.mkey => $measured-element-type-choice
     comid.mval => measurement-values-map
measurement-values-map = non-empty<{
     ? comid.ver => version-map
     ? comid.svn => svn-type-choice
     ? comid.digests => digests-type
     ? comid.flags => flags-type
     ? raw-value-group
     ? comid.mac-addr => mac-addr-type-choice
     ? comid.ip-addr =>  ip-addr-type-choice
     ? comid.serial-number => serial-number-type
     ? comid.ueid => ueid-type
     ? comid.uuid => uuid-type
     * $$measurement-values-map-extension
flags-type = bytes .bits operational-flags

operational-flags = &(
     not-configured: 0
     not-secure: 1
     recovery: 2
     debug: 3
serial-number-type = text

digests-type = one-or-more<hash-entry>

version-map = {
     comid.version => version-type
     ? comid.version-scheme => $version-scheme
version-type = text .default '0.0.0'

svn = int
min-svn = int
tagged-svn = #6.TBD-SVN(svn)
tagged-min-svn = #6.TBD-minSVN(min-svn)
svn-type-choice = tagged-svn / tagged-min-svn

raw-value-group = (
     comid.raw-value => raw-value-type
     ? comid.raw-value-mask => raw-value-mask-type
raw-value-type = bytes
raw-value-mask-type = bytes

ip-addr-type-choice = ip4-addr-type / ip6-addr-type
ip4-addr-type = bytes .size 4
ip6-addr-type = bytes .size 16

mac-addr-type-choice = eui48-addr-type / eui64-addr-type
eui48-addr-type = bytes .size 6
eui64-addr-type = bytes .size 8

verification-key-map = {
     comid.key => pkix-base64-key-type
     ? comid.keychain => [ + pkix-base64-cert-type ]
pkix-base64-key-type = tstr
pkix-base64-cert-type = tstr

corim = #6.500($concise-reference-integrity-manifest-type-choice)

signed-corim = #6.18(COSE-Sign1-corim)

protected-signed-corim-header-map = {
     corim.alg-id => int
     corim.content-type => "application/rim+cbor"
     corim.issuer-key-id => bstr
     corim.meta => corim-meta-map
     * cose-label => cose-values
corim-meta-map = {
     corim.signer => one-or-more<corim-entity-map>
     ? corim.validity => validity-map
corim-entity-map = {
     corim.entity-name => $entity-name-type-choice
     ? corim.reg-id => uri
     corim.role => $corim-role-type-choice
     * $$corim-entity-map-extension
validity-map = {
     ? corim.not-before => time
     corim.not-after => time
unprotected-signed-corim-header-map = {
     * cose-label => cose-values
COSE-Sign1-corim = [
     protected: bstr .cbor protected-signed-corim-header-map
     unprotected: unprotected-signed-corim-header-map
     payload: bstr .cbor unsigned-corim-map
     signature: bstr
unsigned-corim-map = {
     corim.id => $corim-id-type-choice
     corim.tags => one-or-more<$concise-tag-type-choice>
     ? corim.dependent-rims => one-or-more<corim-locator-map>
     * $$unsigned-corim-map-extension
corim-locator-map = {
     corim.href => uri
     ? corim.thumbprint => hash-entry
concise-mid-tag = {
     ? comid.language => language-type
     comid.tag-identity => tag-identity-map
     ? comid.entity => one-or-more<entity-map>
     ? comid.linked-tags => one-or-more<linked-tag-map>
     comid.triples => triples-map
     * $$concise-mid-tag-extension
language-type = text

tag-identity-map = {
     comid.tag-id => $tag-id-type-choice
     ? comid.tag-version => tag-version-type
tag-version-type = uint .default 0

entity-map = {
     comid.entity-name => $entity-name-type-choice
     ? comid.reg-id => uri
     comid.role => one-or-more<$comid-role-type-choice>
     * $$entity-map-extension
linked-tag-map = {
     comid.linked-tag-id => $tag-id-type-choice
     comid.tag-rel => $tag-rel-type-choice
triples-map = non-empty<{
     ? comid.reference-triples => one-or-more<reference-triple-record>
     ? comid.endorsed-triples => one-or-more<endorsed-triple-record>
     ? comid.attest-key-triples => one-or-more<attest-key-triple-record>
     ? comid.identity-triples => one-or-more<identity-triple-record>
     * $$triples-map-extension
reference-triple-record = [
     environment-map ; target environment
     one-or-more<measurement-map> ; reference measurements
endorsed-triple-record = [
     environment-map ; (target or attesting) environment
     one-or-more<measurement-map> ; endorsed measurements
attest-key-triple-record = [
     environment-map ; attesting environment
     one-or-more<verification-key-map> ; attestation verification key(s)
identity-triple-record = [
     environment-map ; device identifier (instance or class)
     one-or-more<verification-key-map> ; DevID, or semantically equivalent
pkix-base64-key-type = tstr
pkix-base64-cert-type = tstr

verification-key-map = {
     ; Verification key in DER format base64-encoded.
     ; Typically, but not necessarily a public key.
     comid.key => pkix-base64-key-type
     ; Optional X.509 certificate chain corresponding to the public key
     ; in comid.key, encoded as an array of one or more base64-encoded
     ; DER PKIX certificates.  The certificate containing the public key
     ; in comid.key MUST be the first certificate.  This MAY be followed
     ; by additional certificates, with each subsequent certificate
     ; being the one used to certify the previous one.
     ? comid.keychain => [ + pkix-base64-cert-type ]
environment-map = non-empty<{
     ? comid.class => class-map
     ? comid.instance => $instance-id-type-choice
     ? comid.group => $group-id-type-choice
class-map = non-empty<{
     ; TODO(tho) add text "class-map SHOULD include class-id"
     ? comid.class-id => $class-id-type-choice
     ? comid.vendor => tstr
     ? comid.model => tstr
     ? comid.layer => uint
     ? comid.index => uint
oid-type = bytes
tagged-oid-type = #6.111(oid-type)

tagged-uuid-type = #6.37(uuid-type)

ueid-type = bytes .size 33
tagged-ueid-type = #6.550(ueid-type)

impl-id-type = bytes .size 32
tagged-impl-id-type = #6.551(impl-id-type)

measurement-map = {
     ? comid.mkey => $measured-element-type-choice
     comid.mval => measurement-values-map
measurement-values-map = non-empty<{
     ? comid.ver => version-map
     ? comid.svn => svn-type-choice
     ? comid.digests => digests-type
     ? comid.flags => flags-type
     ? raw-value-group
     ? comid.mac-addr => mac-addr-type-choice
     ? comid.ip-addr =>  ip-addr-type-choice
     ? comid.serial-number => serial-number-type
     ? comid.ueid => ueid-type
     ? comid.uuid => uuid-type
     * $$measurement-values-map-extension
version-map = {
     comid.version => version-type
     ? comid.version-scheme => $version-scheme
version-type = text .default '0.0.0'

svn = int
min-svn = int
tagged-svn = #6.552(svn)
tagged-min-svn = #6.553(min-svn)
svn-type-choice = tagged-svn / tagged-min-svn

flags-type = bytes .bits operational-flags

operational-flags = &(
     not-configured: 0
     not-secure: 1
     recovery: 2
     debug: 3
raw-value-group = (
     comid.raw-value => raw-value-type
     ? comid.raw-value-mask => raw-value-mask-type
raw-value-type = bytes
raw-value-mask-type = bytes

ip-addr-type-choice = ip4-addr-type / ip6-addr-type
ip4-addr-type = bytes .size 4
ip6-addr-type = bytes .size 16

mac-addr-type-choice = eui48-addr-type / eui64-addr-type
eui48-addr-type = bytes .size 6
eui64-addr-type = bytes .size 8

serial-number-type = text

digests-type = one-or-more<hash-entry>


concise-swid-tag = {
tag-id => text / bstr .size 16,
tag-version => integer,
software-name => text,
entity => one-or-more<entity-entry>,
any-uri = uri
label = text / int

any-attribute = (
label => one-or-more<text> / one-or-more<int>
global-attributes = (
     ? lang => text,
     * any-attribute,
hash-entry = [
     hash-alg-id: int,
     hash-value: bytes,
entity-entry = {
entity-name => text,
role => one-or-more<$role>,
link-entry = {
     ? artifact => text,
href => any-uri,
rel => $rel,
software-meta-entry = {
     ? activation-status => text,
     ? channel-type => text,
     ? colloquial-version => text,
     ? description => text,
     ? edition => text,
     ? entitlement-data-required => bool,
     ? entitlement-key => text,
     ? generator => text,
     ? persistent-id => text,
     ? product => text,
     ? product-family => text,
     ? revision => text,
     ? summary => text,
     ? unspsc-code => text,
     ? unspsc-version => text,
     * $$software-meta-extension,
     global-attributes,
path-elements-group = ( ? directory => one-or-more<directory-entry>,
                           ? file => one-or-more<file-entry>,
                         )

resource-collection = (
     path-elements-group,
     ? process => one-or-more<process-entry>,
     ? resource => one-or-more<resource-entry>,
     * $$resource-collection-extension,
file-entry = {
     filesystem-item,
     ? size => uint,
     ? file-version => text,
     ? hash => hash-entry,
     * $$file-extension,
     global-attributes,
directory-entry = {
     filesystem-item,
     ? path-elements => { path-elements-group },
     * $$directory-extension,
     global-attributes,
process-entry = {
process-name => text,
resource-entry = {
type => text,
filesystem-item = (
     ? key => bool,
     ? location => text,
fs-name => text,
payload-entry = {
     resource-collection,
     * $$payload-extension,
     global-attributes,
evidence-entry = {
     resource-collection,
     ? date => integer-time,
     ? device-id => text,
     * $$evidence-extension,
     global-attributes,
integer-time = #6.1(int)

tag-id = 0
software-name = 1
entity = 2
evidence = 3
link = 4
software-meta = 5
payload = 6
hash = 7
corpus = 8
patch = 9
media = 10
supplemental = 11
tag-version = 12
software-version = 13
version-scheme = 14
lang = 15
directory = 16
file = 17
process = 18
resource = 19
size = 20
file-version = 21
key = 22
location = 23
fs-name = 24
root = 25
path-elements = 26
process-name = 27
pid = 28
type = 29
entity-name = 31
reg-id = 32
role = 33
thumbprint = 34
date = 35
device-id = 36
artifact = 37
href = 38
ownership = 39
rel = 40
media-type = 41
use = 42
activation-status = 43
channel-type = 44
colloquial-version = 45
description = 46
edition = 47
entitlement-data-required = 48
entitlement-key = 49
generator = 50
persistent-id = 51
product = 52
product-family = 53
revision = 54
summary = 55
unspsc-code = 56
unspsc-version = 57

multipartnumeric = 1
multipartnumeric-suffix = 2
alphanumeric = 3
decimal = 4
semver = 16384

tag-creator=1
software-creator=2
aggregator=3
distributor=4
licensor=5
maintainer=6

shared=1
private=2
abandon=3

ancestor=1
component=2
feature=3
installationmedia=4
packageinstaller=5
parent=6
patches=7
requires=8
see-also=9
supersedes=10

optional=1
required=2
recommended=3

cose-label = int / tstr
cose-values = any

uuid-type = bytes .size 16


