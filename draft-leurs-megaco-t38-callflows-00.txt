

   IETF MEGACO Working Group
   Internet Draft                                              A. Leurs
                                                           C. Waitzmann
                                                             A. Schwarz
   Document: draft-leurs-megaco-t38-callflows-00.txt            Alcatel
   Expires: April 2003                                        Oct. 2002


      Procedures for Megaco/H.248 controlled Voice Media Gateways for
                Autonomous Switchover to Fax Relay Service

Status of this Memo

   This document is an Internet-Draft and is in full conformance with
   all provisions of Section 10 of RFC 2026 [1].

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.
   Internet-Drafts are draft documents valid for a maximum of six
   months and may be updated, replaced, or get obsolete by other
   documents at any time.  It is inappropriate to use Internet-Drafts
   as reference material or to cite them other than as "work in
   progress."
   The list of current Internet-Drafts can be accessed at
        http://www.ietf.org/ietf/1id-abstracts.txt
   The list of Internet-Draft Shadow Directories can be accessed at
        http://www.ietf.org/shadow.html.


Abstract

   This document describes the handling of realtime fax calls in
   Megaco/H.248 controlled MGs. The call setup and capability
   negotiation is done with support of the control domain with Megaco
   commands. The switch over to fax or modem, upon detection of the
   relevant tones, is done in an autonomous way, without intervention
   of the control domain.
   In the Appendix, the Megaco messages for a call setup scenario with
   capability negotiation are shown, to point out the structure of the
   SDP sessions in the local and remote descriptors.
   Call flow diagrams are given as example:
   In the first flow, a T.30 CNG tone is generated by the transmitting
   terminal, the transmitting MG signals the detection towards the
   receiving MG. Switching to T.38 is done by both MGs as soon as
   possible.
   In the second example, a T.30 CED tone is sent by the receiving
   terminal. As this tone is no clear indication that a FAX will be
   sent, the receiving MG will switch to VBD after signaling this event


Leurs                                                         [Page 1]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


   to the transmitting MG. Switching to T.38 is done after reception of
   V.21 flags.
   In the other flows, T.38 is not enabled, both MGs switch to the
   fallback case, fax pass-through mode.
   This document is based on the superior framework (reference [2]).
   The reader should be familiar with [2].


Conventions used in this document


   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in RFC-2119 [3].



Table of Contents

   1. Definitions....................................................3
      1.1 Gateway Types..............................................3
      1.2 Packet Network Transport Services..........................3
      1.3 States of MCUs and MGs.....................................3
   2. Abbreviations..................................................4
   3. Motivation and Problem Definition..............................5
      3.1 Architecture Overview......................................6
      3.2 Major States of a Media Gateway............................7
   4. Scope..........................................................7
   5. Description of Phases..........................................8
      5.1 Audit of the Capabilities by the MGC.......................9
      5.2 Megaco/H.248 Call Establishment Procedures.................9
      5.3 Autonomous Switchover from Voice to Fax Relay.............14
      5.4 Termination of the FR Phase...............................17
      5.5 Call Release..............................................17
   6. Summary.......................................................17
   Security Considerations..........................................17
   References.......................................................18
   Informative reference:...........................................18
   Appendix A Scenarios for FoIP....................................19
      A.1 MCU States................................................19
      A.2 Scenario for call set-up with T.38 enabled................21
      A.3 Scenario with for Autonomous Switchover to T.38...........22
      A.4 Scenario with for Autonomous Switchover to T.38, no CNG...23
      A.5 Scenario for Autonomous Switchback to Voice...............24
      A.6 Scenario for Call Release.................................24
      A.7 Scenario for call set-up with T.38 disabled...............25
      A.8 Scenario for Autonomous Switchover to/from VBD ...........26
   Acknowledgments..................................................27
   Author's Addresses...............................................27


Leurs                    Expires - April 2003                 [Page 2]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002




1. Definitions

   Following general terms are used in this document, see also [2]
   respectively reference model and terminology.


1.1 Gateway Types

   Gateway: A gateway converts media provided in one type of network to
   the format required in another type of network. For example, a
   gateway could terminate bearer channels from a switched circuit
   network (e.g., DS0s) and media streams from a packet network (e.g.,
   RTP streams in an IP network).

   Emitting Gateway: The access point that is called by a sending fax
   equipment that interfaces to the IP network. (Abbreviated to MG1)

   Receiving Gateway: The access point that is called by a receiving
   fax equipment that interfaces to the IP network. (Abbreviated to
   MG2)

1.2 Packet Network Transport Services


   Dialed Digits Relay: The transportation of multifrequency audio
   tones (e.g., DTMF) across a packet network using specific packet
   formats (e.g., RFC 2833 for IP networks) in the packet-switched
   network transport domain.

   Fax Relay: The transportation of fax modem traffic across a packet
   network using fax demodulation/remodulation techniques at the
   network access points.


   Tone Relay: The transportation of general audio tones (e.g.,
   telephony tones and telephony signals) across a packet network using
   specific packet formats (e.g., RFC 2833 for IP networks) in the
   packet-switched network transport domain.


1.3 States of MCUs and MGs

   The basic state definitions are provided by a companion document,
   see [2]. The purpose of this section is to detail the definition of
   the VBD state (also called Pass-Through mode).

   VBD has following characteristics:


Leurs                    Expires - April 2003                 [Page 3]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


  - A voice codec is used which passes voice band modulated signals
     with minimal distortion, i.e. G.711 coding.
  - have end-to-end constant latency => minimum jitter
  - Static de-jitter buffer configuration = non adaptive mode: the
     last value before switchover to VBD is frozen.
     In case of immediate switching to VBD, the default value is taken.
  - Disable Voice Activity Detection (VAD) and Comfort Noise
     Generation during data transfer phase => VAD = off
  - Disable any DC removal filters that may be integral with the
     speech encoder used.
  - EC = off
  - Be capable of tone detection
  - Forwards error Correction (FEC) = off
  - Deactivate PLC algorithm
  - Open parameter: A-law or u-law (fixed value)


2. Abbreviations

      B-IWF  Bearer Interworking Function
      C2P    Circuit-to-Packet (direction)
      CED    Called terminal identification, see [7]
      CNG    FAX Calling tone, see [7]
      DCE    Data Circuit-terminating Equipment (Modem)
      DCN    Disconnect, see [7]
      DSP    Digital Signal Processor (Europe)
             Digital Speech Processor (North America)
      DTE    Data Terminal Equipment
      DTMF   Dual Tone Multi-Frequency
      EC     Echo Cancellation
      E-MG   Emitting Media Gateway
      FSK    Frequency Shift Keying
      FoIP   Fax over Internet Protocol
      FR     Frame Relay
      GW     GateWay
      IP     Internet Protocol
      ISDN   Integrated Services Digital Network
      MCU    Media Conversion Unit (e.g., DSP channel)
      MG     Media Gateway (= via Megaco/H.248 controlled MG)
      MGC    Media Gateway Controller
      MMF    Media Mapping Function
      MMSF   Media Mapping and Switching Function
      NAS    Network Access Server
      NGN    Next Generation Network
      NTE    Named Telephone Events
      P2C    Packet-to-Circuit (direction)
      PLC    Packet Loss Concealment
      PSTN   Public Switched Telephone Network
      R-MG   Receiving Media Gateway


Leurs                    Expires - April 2003                 [Page 4]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


      RTP    Real-time Transport Protocol
      SCN    Switched Circuit Network
      UDPTL  Facsimile UDP Transport Layer protocol (T.38)
      VAD    Voice Activity Detection
      VBD    Voiceband Data
      VBDoIP Voiceband Data over IP
      Vc     Voice 'compressed'
      VoIP   Voice over Internet Protocol
      Vu     Voice 'uncompressed'

3. Motivation and Problem Definition

   The handling of FoIP in MGs, which are controlled with Megaco/H.248
   [6] is described in T.38 Appendix III ref [4], and supported by
   H.248 with help of the packages defined in H.248 Annex F., see ref
   [5].
   In the above scenario, the MGCs have the knowledge of the capability
   of the MGs to support T.38, by means of audit commands. Call set-up
   is done as usual, enabling resources for voice. Additionally, events
   are enabled as defined in the FAX packages. Upon detection of FAX
   signals, the MGC is notified by the emitting MG about the event, and
   gives the command to the receiving part via its controlling MGC to
   generate the signals. Answering signals are handled in the same way.
   When all signals needed are communicated between both FAX terminals
   via the MGs and MGCs, the MGCs will modify the contexts to put them
   into fax-mode. This scenario can take up to 20 Megaco commands, see
   T.38 Appendix III, [4].

   This document proposes a more direct handling of the fax-switchover,
   without intervention of the control domain, but by means of
   interchanging RFC2833 events between the two gateways. For reasons
   of robustness, as soon as a MG switches in T.38 mode, also T.38
   messages are sent of type T30_indicator, to indicate the detection
   of the signals CNG, CED or V.21 preamble flags.
   As long as a MG is in VBD mode, signals are also passed inband, in
   VBDoIP.
   If for some reason, during the negotiating phase of the call set-up,
   one gateways signals not to be able to support T.38, an automatic
   switchover to Fax-pass-through will occur upon detection of Fax
   tones











Leurs                    Expires - April 2003                 [Page 5]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002




3.1 Architecture Overview

        - - - - - - - - - - - - -- - - - - - - - - - - - - - - -
        |             IP network                                |
           +----------+                      +----------+
   e.g. |  |          |                      |          | e.g.  |
   SS7     |+------+  |                      | +------+ | SS7.
   ------->|| MGC1 |--|----------------------|-| MGC2 | |-------->
           |+------+  |                      | +------+ |
        |  +----------+                      +----------+       |
                |       Control domain             |
       - - - - -|- - - - - - - - - - - - - - - - - | - - - - - - -
        |       |      Transport domain            |            |
          +-------------+                     +-------------+
        | | MG1         |                     |  MG2        |   |
          | +---------+ |                     | +---------+ |
        | | |B-IWF    | |                     | | B-IWF   | |   |
          | | +-----+ | |      IP-flow        | | +-----+ | |
   --->-|-|-|-|C2P  |-|-|-------->------------|-|-|P2C  |-|-|->-|-
          | | |-----| | |                     | | |-----| | |
   ---<-|-|-|-|P2C  |-|-|--------<------------|-|-|C2P  |-|-|-<-|--
      |   | | +-----+ | |                     | | +-----+ | |
      | | | +---------+ |                     | +---------+ |   |
      |   +-------------+                     +-------------+
      | |                                                       |
      | - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      |
      v
       = 1 bi-directional DS0 bearer channel

              Figure 1: Reference Network Architecture

   This overview contains the involved network elements like MGCs and
   MGs. The MG contains a Bearer Interworking function, for the
   translation between DS0 channels and IP packets. It contains a MCU,
   a Media Conversion Unit with a B-IWF split for the 2 directions, C2P
   and P2C. For voice and FAX, both B-IWF parts will be synchronous,
   they will pass different states for receive and transmit in the same
   way.

   In this document, the MG1 will take the role of the Emitting Gateway
   and the MG2 will be the Receiving Gateway.
   The MGs are controlled by MGCs, via the Megaco protocol, [6]. In the
   figure 1, the general case is drawn, for which both MGs are
   controlled by different MGCs. The communication between the two MGCs
   is not scope of this document.



Leurs                    Expires - April 2003                 [Page 6]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


3.2 Major States of a Media Gateway

   At any given time, each direction of the B-IWF is in exactly one
   state. The states of the MGs are considered to be the states of the
   MCU.
   All states are quoted in Figure 2, the state transitions are
   simplified. All possible transitions and the conditions for which
   they occur are described in Appendix A.



               |--------|
               |  IDLE  |
               |        |<---------------------------------------|
               |--------|                                        |
                 |   A                                           |
     Call set-up |   | Call release (SUBTRACT)                   |
      (ADD)      |   |                                           |
                 V   |                                  Call end |
              |-------------------|                              |
              | Voice Mode        |                              |
              | -compressed (Vc)  |<---------------------|       |
              | -uncompressed (Vu)|                      |       |
              |-------------------|                      |       |
                     |                           Fax end |       |
                     |Fax tones                          |       |
                     |                                   |       |
                     |                                   |       |
                     | no T38 enabled    |-------|       |       |
                     |------------------>|  VBD  |------>|------>|
                     |                   |-------|       |       |
                     |                                   |       |
                     |  T.38 enabled  |---------------|  |       |
                     |--------------->| Fax Relay (FR)|->|------>|
                                      |---------------|

                Figure 2: MCU states



4. Scope

   The scope of this document is limited on T.38 Media Gateways capable
   of autonomous transition between VoIP and FoIP.







Leurs                    Expires - April 2003                 [Page 7]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


5. Description of Phases

   The different phases for handling of a FAX call follow the time
   sequence as described in T.30 [7], preceded by the Megaco/H.248
   audit capability sequences, see [6].

              +----------------------+
              |                      |
              |  Audit capabilities  |
              |        MG-MGC        |   see chapter 5.1
              |                      |
              +----------------------+
                         |
       +-------------------------------------+
       |  Phase A: Call establishment        |
       |      +----------------------+       |
       |      |   Call Set-up        |       |
       |      |  Codec negotiating   |       | see chapter 5.2
       |      |    MGC-MG1/2         |       |
       |      +----------------------+       |
       |                 |                   |
       |      +----------------------+       |
       |      |   Voice Call         |       |
       |      |  Switchover to       |       | see chapter 5.3
       |      |    FAX-mode          |       |
       |      |      MG1-MG2         |       |
       |      +----------------------+       |
       +-------------------------------------+
                         |
       +-------------------------------------+
       |  Phase B/C                          | not scope of
       |  Facsimile procedures               | this document
       |       MG1-MG2                       |
       +-------------------------------------+
                         |
       +-------------------------------------+
       |  Phase D: post message procedure    | see chapter 5.4
       |      MG1-MG2                        |
       +-------------------------------------+
                         |
       +-------------------------------------+
       |  Phase E: Call release              | see chapter 5.5
       |     MGC-MG1/2                       |
       +-------------------------------------+

        Figure 3: Phases of a Fax call





Leurs                    Expires - April 2003                 [Page 8]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


5.1 Audit of the Capabilities by the MGC

   At some point before a call establishment, the MGC will have sent an
   audit capabilities command to the MGs, and will know the
   capabilities of each MG. For connections whereby on of the MGs is
   not able to support T.38, the T.38 capability will not occur in the
   negotiating phase, and fax  modem and data modem services will only
   be possible in Pass-through mode.

5.2 Megaco/H.248 Call Establishment Procedures

  Triggered by a Call Control signaling message, the MGC will set up
  the call by creating a context, taking care that all resources needed
  to support the voice  call and a possible FAX call can be supported
  by both sides. Following actions has to be done:
  -  Negotiating about the codecs to be used for voice
  -  Negotiating about the ability to use T.38 for fax relay, and the
     values of the mandatory attributes.
  -  Interchange of the address information of both sides, IP address
     and UDP ports. Note that for voice and FAX, different UDP ports
     can be chosen.

  Because of the fact that the switchover to FAX is done internal in
  the MGs, and no notification is generated towards the MGC, the
  packages defined in H.248, Annex F, are not needed, and no FAX
  related Event detection∆s are enabled at the TDM termination at call
  set up.
  Remark: if the event detection for FAX signals as described in the
  FAX packages is enabled, switchover supported by the control domain
  will be enabled. The use of these packages can be considered as mode
  selection between autonomous switchover and MGC-controlled
  switchover.

   In the following example, the local control parameters ReserveGroup
   and ReserveValue are used as described in H.248, chapter 7.1.8, see
   ref [6], to request media streams and their values in the ADD and
   MODIFY commands.
   As an alternative, the principle of grouping of media lines in SDP
   as described in [8], using the group attribute "FID" and "mid" could
   be used.

  In the following example of a Megaco command sequence, the situation
  that one MGC controls both MGs is taken, as the communication between
  the two MGCs is not scope of this document.







Leurs                    Expires - April 2003                 [Page 9]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


  MGC -> MG1:
  ============
  MEGACO/1.0 [123.123.123.4]:55555
  Transaction = 11 {
   Context = $ {
      Add = DS0/1/1
      Add = $ {
         Media {
            LocalControl{
               Mode = ReceiveOnly,
               ReserveGroup = true,
               ReserveValue = true}; The MG1 should reserve all
                                       Codecs and sessions it
                                       can support, see [6], 7.1.8
            Local{
  v=0
  c=IN IP4 $
  m=audio $ RTP/AVP 4 0
  v=0
  c=IN IP4 $
  m=image $ udptl t38
  a=T38FaxRateManagment:localTCF
  a=T38FaxUdpEC:t38UDPFEC}
  }}}}

  MG1 -> MGC:
  =============
  Megaco/1.0 [124.124.124.222]:55555
  Reply = 11
   Context = 2000{
      Add = DS0/1/1
      Add = RTP/1{
               Media{
                  Local{
  v=0
  c=IN IP4 124.124.124.222
  m=audio 2222 RTP/AVP 4 0      ; MG1 can support both codecs
  v=0
  c=IN.IP4 0.0.0.0               ;
  m=image 1111 udptl t38        ; other UDP port chosen for fax
  a=T38FaxRateManagment:localTCF
  a=T38FaxUdpEC:t38UDPFEC

  }}}}}







Leurs                    Expires - April 2003                [Page 10]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


  MGC -> MG2:
  =============
  MEGACO/1.0 [123.123.123.4]:55555
  Transaction = 12 {
   Context = $ {
      Add = DS0/2/2
      Add = $ {
         Media {
            LocalControl{
               Mode = SendReceive,
               ReserveGroup = true,
               ReserveValue = false}; The MG2 should choose
                                      ; out of the list of codecs
                                      ; with decreasing priority
            Local{
  v=0
  c=IN IP4 $
  m=audio $ RTP/AVP 4 0
  v=0
  c=IN IP4 $
  m=image $ udptl t38
  a=T38FaxUdpEC:t38UDPFEC
  a=T38FaxRateManagment:localTCF
  }
            Remote{
  v=0
  c=IN IP4 124.124.124.222
  m=audio 2222 RTP/AVP 4 0
  v=0
  c=IN.IP4 0.0.0.0
  m=image 1111 udptl t38
  a=T38FaxRateManagment:localTCF
  a=T38FaxUdpEC:t38UDPFEC
  }}}}

  MG2 -> MGC:
  ============

  Megaco/1.0 [125.125.125.555]:55555
  Reply = 12
   Context = 5000{
      Add = DS0/2/2
      Add = RTP/2{
               Media{
                  Local{
  v=0
  c=IN IP4 125.125.125.555
  m=audio 5555 RTP/AVP 4       ; MG2 can support the codec which
                              ; had the highest priority


Leurs                    Expires - April 2003                [Page 11]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


  v=0
  c=IN.IP4 0.0.0.0
  m=image 4444 udptl t38        ; other UDP port chosen for fax
  a=T38FaxRateManagment:localTCF
  a=T38FaxUdpEC:t38UDPFEC

  }
                  Remote{
  v=0
  c=IN IP4 124.124.124.222
  m=audio 2222 RTP/AVP 4      ; the MG2 updated the remote
                              ; descriptor also
  v=0
  c=IN.IP4 0.0.0.0
  m=image 1111 udptl t38
  a=T38FaxRateManagment:localTCF
  a=T38FaxUdpEC:t38UDPFEC

  }}}}}


  MGC -> MG1:
  ============

  MEGACO/1.0 [123.123.123.4]:55555
  Transaction = 13 {
   Context = 2000 {
      Modify = RTP/1{
         Media{
            LocalControl{
               Mode = SendReceive,
               ReserveGroup = true,
               Local{
  v=0
  c=IN IP4 124.124.124.222
  m=audio 2222 RTP/AVP 4      ; value to be updated
  v=0
  c=IN.IP4 0.0.0.0
  m=image 1111 udptl t38

  }
  Remote{
  v=0
  c=IN IP4 125.125.125.555
  m=audio 5555 RTP/AVP 4       ;
  v=0
  c=IN.IP4 0.0.0.0               ;
  m=image 4444 udptl t38        ;
  a=T38FaxRateManagment:localTCF


Leurs                    Expires - April 2003                [Page 12]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


  a=T38FaxUdpEC:t38UDPFEC

  }}}}}

  MG1-> MGC:
  ==========

  Megaco/1.0 [124.124.124.222]:55555
  Reply = 13
   Context = 2000{
      Modify = RTP/1}








































Leurs                    Expires - April 2003                [Page 13]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



5.3 Autonomous Switchover from Voice to Fax Relay

  Following functions are needed to enable the autonomous switch over:
  -  The detection of tones
  -  The passing of the tones to the peer fax terminal, which includes
     signaling of the tones between the MGs.
  -  The switching to from Voice to VBD or FAX Relay


5.3.1 Fax Tones


  Tones used to signal the presence of a fax modem and data modem are
  (see also [7]):

  -  CNG tone at the transmitting terminal: After dialing the called
     fax machine∆s telephone number (and before it answers), the
     calling Group III fax machine (optionally) begins sending a
     calling tone (CNG) consisting of an interrupted tone of 1100 Hz.
     This is a certain indication that a FAX is going to be sent. It is
     however an optional signal. But when it is present, it has to be
     transmitted to the receiving terminal.
  -  CED tone transmitted by the receiving terminal. This 2100 +/- 15
     Hz tone is called terminal identification answer tone. This tone
     is not always present, it is an optional signal.
     Note: In case of Data Modems, this tone is called ANS, and used to
     disable echo suppression.
  -  V.21 preamble flag sequence, sent by the receiving terminal. The
     preamble is always present. It is the only mandatory signal during
     fax establishment.
     V.21 is a mean for data transmission up to 300bit/s in both
     directions simultaneously using FSK modulation. Two channels are
     defined.:
     - Channel 1: calling to called station:"0" as 1180Hz,"1" as 980Hz
     - Channel 2: called to calling station:"0" as 1850Hz,"1" as 1650Hz
     Preample flags are send for 1 sec (+/- 15%). In other words, flags
     ("0111 1110") are consecutive sent on the V.21 channel for at
     least 850ms. In order to discriminate clearly between data modems
     and fax modems, a non ambiguous detection of the preample has to
     be guaranteed by the receiving MG.



5.3.2 MG-to-MG Signaling


   Following methods exist to pass information about the detected
   signals and tones to the peer fax terminal over the packet network:
   (Note: meant here are not the MG capabilities exchange procedure as
   described in [2].




Leurs                    Expires - April 2003                [Page 14]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


   Method 1:
   Tone pass through: The tone is sent inband (e.g.
   TONEoG.711oRTP/UDP/IP)
   Upon detection of a tone, the MG switches autonomous to VBD, in
   which mode an appropriate codec is used, and passes the tone in the
   voice RTP payload. The receiving Gateway has to detect the tone, and
   has to switch to VBD, to pass the signal to the fax terminal.



   Method 2:
   Tone relay (RFC 2833 RTP Payload Format for Telephony Tones), see
   ref [9].
   All information needed to regenerate the tone are passed in the RTP
   payload. The B-IWF in the peer MG has to generate the tones towards
   the fax terminal.

   Method 3:
   Tone detection indication (RFC 2833 RTP Payload Format for Named
   Telephone Events):
   Event messages (NTE) are used to pass events. as described in RFC
   2833 [9], chapter 3.11 (Data modems and Fax Events). The peer MG
   shall use this message to switch to VBD or T.38, dependent of the
   current state, and shall generate the tones with the characteristics
   as described in T.30 [7].

   For redundancy reasons, it is proposed to send triplicate RFC2833
   events.

   Following events are to be sent, as defined in [9], Table 3:
   - ANS (=CED): encoding 32(decimal)
   - CNG:         encoding 36
   - V.21 ch2,"0"bit:   encoding 39
   - V.21 ch2,"1"bit:   encoding 40

   For the V.21 flags, there exist no RFC2833 event. Only V.21 ch2,
   bit"0" and bit"1" events exist, which are proposed to be sent after
   detection of a specified number of V.21 flags, needed to
   discriminate between fax calls and data calls..
   After the switchover to T.38, the V.21 flags are passed over UDPTL.

   Note: It would be more appropriate if RFC2833 could be extended by
   an own event for T.30 preample, instead of misusing the V.21 events.

   Method 4:
   After switch over to T.38, it is possible to send T.38 packets of
   Type T_30 indicator, to signal the presence of facsimile signals.




Leurs                    Expires - April 2003                [Page 15]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


   In case, a different UDP port is chosen for T.38 transport, these
   packets can be detected at the packet side as UDPTL packets, and can
   be used to trigger the switchover to T.38 mode.

   To be able to have compatible Gateways, it is proposed to follow the
   rule: "Send as much as possible, understand at least one":
   - to pass the information, all possible relevant methods are used
     which means
     In Voice and VBD mode:
     - RFC2833 NTE messages are sent (method 3)
     - the signals are sent inband, VBDoIP. (method 1)
     In T.38 mode:
     - T.38 packets are send with T_30 indicator messages
       (method 4)
   - at the receiving packet side, the MG must be able to evaluate at
     least one of the messages.



   RFC2833 payload type:
   It is also proposed to use a fixed payload type. The dynamic payload
   type value 96 is proposed.
   As an alternative, the payload type could be negotiated during call
   set-up.


5.3.3 Switching to T.38


   Due to the fact that the V.21 flags are the only signals which are
   not optional, it is recommended to switch to Fax Relay mode in the
   backwards direction upon detection of these flags.
   Upon detection of an sufficient number of V.21 flags at the TDM
   side, the receiving MG will switch to T.38 mode, after he has sent a
   RFC 2833. Being in T.38 mode, the receiving MG will also send a T.38
   packet with the T30 indicator message with preamble V21 flag
   indication. The transmitting MGC can choose which message it uses as
   trigger to make the switchover.(method 3 or method 4).
   The transmitting MG must generate V.21 flags towards the
   transmitting Fax machine.

   However, to avoid timeout of the sending Fax machine, also the CNG
   signal is used as trigger point to switch to T.38 if enabled.
   In this case, after detection of the CNG tone, the transmitting MG
   will do following:
   - send and RFC2833 NTE message with CNG event
   - switches to T.38 mode
   - send a T.38 packet with T30 indicator message with CNG indication.





Leurs                    Expires - April 2003                [Page 16]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002


   The receiving MG will use either the NTE message or the presence of
   a T.38 packet to switch over to T.38, and regenerates the CNG tone
   towards the receiving FAX.


5.3.4 Switching to VBD


   The CED tones at the TDM side trigger the receiving MG to switch to
   VBD mode, this tone, sent inband to the transmitting MG or the
   associated RFC2833 NTE message will trigger the transmitting MG to
   do the same.
   In case, T.38 is not enabled during call establishment, all Fax
   tones at the TDM side , and the tones passed inband to the peer
   side, or their related RFC2833 NTE messages will trigger a switch to
   VBD.






5.4 Termination of the FR Phase

   The sending FAX sends a DCN (DisCoNnect). Upon detection of this
   tone, the MGs should go back to voice mode, with the same voice
   codec as before. Note that this DCN tone is not confirmed by the
   receiving FAX, so that the receiving gateway has to react at the
   packet side on the DCN signal encoded in T.30.

   An alternative is to switch back to voice mode after a well defined
   time-out period.

5.5 Call Release

   The call is released by the MGC. This is possible after switching
   back to voice mode, or directly from the FAX state.

6. Summary

   The recommended scenario is described in detail with a state diagram
   and in an example of a call scenario in the Appendix A.

Security Considerations

   Security considerations are addressed as per Section 10 of RFC-3015







Leurs                    Expires - April 2003                [Page 17]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



References


                    

   1  Bradner, S., The Internet Standards Process -- Revision 3, BCP 9,
      RFC 2026, October 1996.

   2  Schwarz, A., Voiceband Data Transport Services in Megaco/H.248
      Networks, August 2002, work in progress.

   3  Bradner, S., Key words for use in RFCs to Indicate Requirement
      Levels, BCP 14, RFC 2119, March 1997

   4  ITU-T Recommendation T.38, Procedures for real-time Group3
      facsimile communication over IP networks, April 2002.

   5  ITU-T Recommendation H.248 Annex F, Facsimile, Text Conversation
      and Call Discrimination Packages, November 2000

   6  ITU-T Recommendation H.248, Gateway Control Protocol, June 2000.


   7  ITU-T Recommendation T.30, Procedure for Document Facsimile

      Transmission in the General Switched Network, 1996/1999


   8  The RFC that will come out of draft-ietf-mmusic-fid-06.txt,

      Gonzalo Camarillo, February 2002.


   9  Schulzrinne, H., Petrack, S., RTP Payload for DTMF Digits,
      Telephony Tones and Telephony Signals, RFC 2883, May 2000.


Informative reference:

      Internet Draft draft-ietf-sipping-realtimefax-00.txt, 'SIP
      Support for Real-time Fax: Call Flow Examples And Best Current
      Practices', August 2002.













Leurs                    Expires - April 2003                [Page 18]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002




Appendix A Scenarios for FoIP

     A.1 MCU States

                 +--------+
                 | IDLE   |<---------------------------------------|
                 +--------+                                        |
                   |   ^                                           |
               (1) |   | (9 )                                      |
                   v   |                                           |
                +----------------+                                 |
                | Voice Mode     |                                 |
                | -compressed    |<---------------------|          |
                | -uncompressed  |                      |          |
                +----------------+                      |          |
                       |    |(2)                        |          |
                       |    |              +-------+(5) |          |
                       |    |              |       |--->|     (8)  |
                       |    -------------->|  VBD  |----|--------->|
                       |                   +-------+    |          |
                       |(4)                  |   ^      |          |
                       |                  (3)|   |(6)   |          |
                       |                     v   |      |          |
                       |                +-----------+(7)|          |
                       |                |           |-->|     (8)  |
                       |--------------->| Fax Relay |---|--------->|
                                        +-----------+

         Figure A1: MCU states with transitions




















Leurs                    Expires - April 2003                [Page 19]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002




   --------------- ------------------------------------------------
   |Transition  | MG1_MCU                 | MG2_MCU               |
   ----------------------------------------------------------------
   | (1)        | H.248:Add(RTP/TDM)      | H.248:Add(RTP/TDM)    |
   |------------|-------------------------|-----------------------|
   | (2)        |RFC 2833(CED event) or   | CED or                |
   |            |(T.38 disabled and       | (T.38 disabled and    |
   |            |(CNG or                  |(RFC 2833(CNG event)and|
   |            | RFC 2833(V21 event))    | V.21 flags)           |
   |------------|-------------------------|-----------------------|
   | (3)        |(RFC 2833(V21 event)or   |V21 flags and          |
   |            |T38(T30 V21flag indic.)) |T38 enabled            |
   |            | and    T38 enabled      |                       |
   |------------|-------------------------|-----------------------|
   | (4)        |(CNG or                  |(RFC 2833(CNG event) or|
   |            |RFC 2833(V21 event) or   |T38(T30 CNG indication)|
   |            |T38(T30 V21flag indic.)) | or V21 flags)         |
   |            |   and T.38 enabled      | and T.38 enabled      |
   |------------|-------------------------|-----------------------|
   | (5)        | DCN or timeout          | T.30 DCN or timeout   |
   |------------|-------------------------|-----------------------|
   | (6)        |   ?                     |              ?        |
   |------------|-------------------------|-----------------------|
   | (7)        | DCN or timeout          | T.30 DCN or timeout   |
   |------------|-------------------------|-----------------------|
   | (8)        | H.248:Subtract          | H.248:Subtract        |
   |------------|-------------------------|-----------------------|
   | (9)        | H.248:Subtract          | H.248:Subtract        |
   ------------------------------------------------------------------


         Table A1: MCU state transitions

















Leurs                    Expires - April 2003                [Page 20]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



A.2 Scenario for call set-up with T.38 enabled

            MG1                   MGC                  MG2
      IAM    |                     |                     |
     ----------------------------->|                     |
             | Add(TDM/            |                     |
             |RTP(G 729.G 711).T.38)                     |note:[1,4]
             |<--------------------|                     |
             |     Reply           |                     |
             |-------------------->| Add(TDM/            |
             |                     |RTP(G 729+G 711).T.38|note:[2,4]
             |                     |-------------------->|
             |                     |   Reply(G.729/T.38) |
             | Modify(G.729/T.38)  |<--------------------|
   note:[3,4]|<--------------------|                     |
             |    Reply            |                     |
             |-------------------->|                     |
             |     Active Voice call                     |
             |<=========================================>|
             |                     |                     |
             |                     |                     |

   Figure A2: Scenario for call setup


     [1]: ReserveGroup = true, ReserveValue = true
     [2]: ReserveGroup = true, ReserveValue = false
     [3]: ReserveGroup = true
     [4]: G.727*G.711: AND function, G.729+G.711: OR function





















Leurs                    Expires - April 2003                [Page 21]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



A.3 Scenario with for Autonomous Switchover to T.38


           MG1                   MGC                  MG2
            |                     |                     |
            |     Active Voice call                     |
            |<=========================================>|
            |                     |                     |
            |                     |                     |
     CNG    |                     |                     |
   -------->|                     |                     |
            |                     |                     |
            |     RFC 2833 NTE(event=36)                |
            |------------------------------------------>| CNG :note [1]
            |                     |                     |--------->
      switch to T.38              |                     |
            |      T38(T30 indicator: CNG)              |
            |------------------------------------------>|
            |                     |                 switch to
            |                     |                    T.38  note [3]
            |                     |                     |
            |                     |                     | CNG :note [2]
            |                  Fax mode                 |----------->
            |<=========================================>|
            |                     |                     |
            |                     |                     |  CED
            |     T38(T30 indicator: CED)               |<-------
        CED |<------------------------------------------|
   <--------|                     |                     |
            |                     |                     |
            |                     |                     | V.21 flags
            |  T38(T30 indicator: V.21 preamble flags   |<---------
            |<------------------------------------------|
            |                     |                     |
   V.21 flags                     |                     |
   <--------|                     |                     | and so on

   [1]: CNG generated if RFC 2833 is used as trigger
   [2]: CNG generated if T38 indicator message is used as trigger
   [3]: Switch to T38 after RFC 2833 NTE or after T38 indicator
        message dependent on choice of trigger
   Note: all RFC 2833 messages are sent triple


   Figure A3: Scenario for switching to T.38





Leurs                    Expires - April 2003                [Page 22]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



   A.4 Scenario with for Autonomous Switchover to T.38, no CNG

           MG1                   MGC                  MG2
            |                     |                     |
            |     Active Voice call                     |
            |<=========================================>|
            |                     |                     |
            |                     |                     |  CED
            |     RFC 2833 NTE (event 22)               |<-------
            |<------------------------------------------|
            |      CED over VBDoIP                      |
            |<------------------------------------------|
   CED:note[1]                    |                     |
   <--------|                     |                     |
            |                     |                     |
      switch to VBD :note [2]     |               switch to VBD
            |                     |                     |
            |                     |                     | V.21 flags
            |       RFC 2833 NTE (event39)              |<---------
            |<------------------------------------------|
            |                     |                     |
            |                     |            switch to T.38
            | T38(T30 indicator V21 preamble flags)     |
            <-------------------------------------------|
   V21 flags: note [3]            |                     |
   <--------|                     |                     |
            |                     |                     |
      switch to T.38:note [4]     |                     |
            |                     |                     |
            |              Fax mode T.38                |
            |<=========================================>| V.21 flags
            |                     |                     |<---------
            |      V.21 flags over UDPTL                |
   V.21 flags<------------------------------------------|
   <--------|                     |                     |
            |                     |                     | and so on

   [1]: CED generated after reception of RFC2833 event or passed
        inband.
   [2]: switched to VBD after reception of RFC2833 event or after
        detection of CED tone at the packet side
   [3]: V21 flags generated after RFC2833 event or after T38
        indicator message
   [4]: switched to T38 after RFC2833 event or after T38 indicator
        message
   Note: all RFC 2833 messages are sent triple

   Figure A4: Scenario for switching to T.38, no CNG


Leurs                    Expires - April 2003                [Page 23]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



A.5 Scenario for Autonomous Switchback to Voice

           MG1                   MGC                  MG2
            |                     |                     |
     DCN    |                     |                     |
   -------->|                 T.30(DCN)                 |
            |------------------------------------------>|  DCN
       Switch to                  |                     |-------->
       Voice mode                 |                detect DCN and
            |                     |                 switch to
            |                     |                Voice mode
            |                 Voice mode                |
            |<=========================================>|

       Figure A5: Scenario for switching back to Voice mode


A.6 Scenario for Call Release

   e.g. REL |                     |                     |
   ------------------------------>|                     |
            |   Subtract          |                     |
            |<--------------------|                     |
            |  Reply (statistics) |                     |
            |-------------------->|   Subtract          |
            |                     |-------------------->|
            |                     | Reply(statistics)   |
            |                     |<--------------------|
   e.g. RLC |                     |                     |
   <------------------------------|                     |
            |                     |                     |

       Figure A6: Scenario for Call Release

















Leurs                    Expires - April 2003                [Page 24]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



   A.7 Scenario for call set-up with T.38 disabled

           MG1                   MGC                  MG2
      IAM   |                     |                     |
     ---------------------------->|                     |
            | Add(TDM/            |                     |
            |RTP(G.729.G7.11).T.38)                     |Note:[1,5]
            |<--------------------|                     |
            |     Reply           | Add(TDM/            |
            |-------------------->|RTP(G.729+G.711).T.38| Note:[2,4]
            |                     |-------------------->|
            |                     |   Reply(G.729)      |
            | Modify(G.729)       |<--------------------|Note:[3]
            |<--------------------|                     |
            |    Reply            |                     |
            |-------------------->|                     |
            |     Voice call                            |
            |<=========================================>|
            |                     |                     |
            |                     |                     |


   [1]: ReserveValue = true, ReserveGroup = true
   [2]: ReserveValue = false, ReserveGroup = true
   [3]: MG2 can∆t support T.38, the RTP termination in MG1 has to be
   adapted accordingly
   [4]: G.727*G.711: AND function, G.729+G.711: OR function

      Figure A7: Scenario to switch to/from VBD, because T.38 disabled





















Leurs                    Expires - April 2003                [Page 25]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002




     A.8 Scenario for Autonomous Switchover to/from VBD (T.38 not
     enabled)


            |     Voice call                            |
            |<=========================================>|
            |                     |                     |
      CNG   |                     |                     |
   -------->           RFC 2833 NTE(event 36)           |
            |------------------------------------------>|
      Switch to VBD               |                     |
            |         CNG over VBDoIP                   |
            |-------------------------------------------| CNG: note [1]
            |                     |                     |--------->
            |                     |             Switch to VBD: note [2]
            |                     |                     |
            |                     |                     |  CED
            |                     |                     |<--------
            |           RFC 2833 NTE(event 32)          |
            |<------------------------------------------|
            |         CED over VBDoIP                   |
            |<------------------------------------------|
    CED :note [1]                 |                     |V.21 flags
   <--------|                     |                     |<-----------
            |           RFC 2833 NTE(event 39)          |
            |<------------------------------------------|
            |                     |                     |
            |  all further T30 signaling transparent    |
            |<----------------------------------------->|
   V21 flags: note [1]            |                     |
            |           Fax over VBDoIP                 |
            |<=========================================>|
     DCN    |                     |                     |
   -------->|                 T.30(DCN)                 |
            |------------------------------------------>|  DCN
       Switch to                  |                     |-------->
       Voice mode                 |                detect DCN and
            |                 Voice mode         switch to Voice mode
            |<=========================================>|
            |                     |                     |and so on‡

   [1]: tone generated after RFC2833 event or passed inband
   [2]: switched to VBD after RFC2833 event or after detection of CNG
        tone at the packet side
   Note: all RFC 2833 messages are sent triple

Figure A8: Scenario to switch to/from VBD, because T.38 disabled


Leurs                    Expires - April 2003                [Page 26]
          Procedures for Autonomous Switchover to FAX Relay Oct. 2002



Acknowledgments

   The authors to thank G. Weiss, X. Meng, J. Stoetzer T. Voith,
   J. Felizardo and C. Gavanescu-Bayerle for their comments and
   suggestions.



Author's Addresses

   An Leurs
   Alcatel
   Lorenzstrasse 10
   D-70435 Stuttgart
   GERMANY

   Email: ALeurs@alcatel.de


   Carsten Waitzmann
   Alcatel
   Lorenzstrasse 10
   D-70435 Stuttgart
   GERMANY

   Email: CWaitzmann@alcatel.de



   Albrecht Schwarz
   Alcatel
   Lorenzstrasse 10
   D-70435 Stuttgart
   GERMANY

   Email: Albrecht.Schwarz@alcatel.de














Leurs                    Expires - April 2003                [Page 27]
