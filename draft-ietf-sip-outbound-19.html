<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Managing Client
    Initiated Connections in the Session Initiation Protocol (SIP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Managing Client
    Initiated Connections in the Session Initiation Protocol (SIP)">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">C. Jennings, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco Systems</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3261'>3261</a>, <a href='http://tools.ietf.org/html/rfc3327'>3327</a></td><td class="header">R. Mahy, Ed.</td></tr>
<tr><td class="header">(if&nbsp;approved)</td><td class="header">Unaffiliated</td></tr>
<tr><td class="header">Intended status:  Standards Track</td><td class="header">June 01, 2009</td></tr>
<tr><td class="header">Expires:  December 3, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Managing Client
    Initiated Connections in the Session Initiation Protocol (SIP)<br />draft-ietf-sip-outbound-19</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008. The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on December 3, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>The Session Initiation Protocol (SIP) allows proxy servers to
      initiate TCP connections or to send asynchronous UDP datagrams to User
      Agents in order to deliver requests. However, in a large number of real
      deployments, many practical considerations, such as the existence of
      firewalls and Network Address Translators (NATs) or the use of TLS with
      server-provided certificates, prevent servers from connecting to User
      Agents in this way. This specification defines behaviors for User
      Agents, registrars and proxy servers that allow requests to be delivered
      on existing connections established by the User Agent. It also defines
      keep alive behaviors needed to keep NAT bindings open and specifies the
      usage of multiple connections from the User Agent to its Registrar.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Conventions and Terminology<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.</a>&nbsp;
Definitions<br />
<a href="#anchor4">3.</a>&nbsp;
Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">3.1.</a>&nbsp;
Summary of Mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#example-single">3.2.</a>&nbsp;
Single Registrar and UA<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#multiple">3.3.</a>&nbsp;
Multiple Connections from a User Agent<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">3.4.</a>&nbsp;
Edge Proxies<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.5.</a>&nbsp;
Keep alive Technique<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.5.1.</a>&nbsp;
CRLF Keep alive Technique<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">3.5.2.</a>&nbsp;
STUN Keep alive Technique<br />
<a href="#mech-ua">4.</a>&nbsp;
User Agent Procedures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section-instance">4.1.</a>&nbsp;
Instance ID Creation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#reg">4.2.</a>&nbsp;
Registrations<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">4.2.1.</a>&nbsp;
Initial Registrations<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">4.2.2.</a>&nbsp;
Subsequent REGISTER requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#third-party-reg">4.2.3.</a>&nbsp;
Third Party Registrations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#send">4.3.</a>&nbsp;
Sending Non-REGISTER Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#detect-fail">4.4.</a>&nbsp;
Keep-alives and Detecting Flow Failure<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keepcrlf">4.4.1.</a>&nbsp;
Keep alive with CRLF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keepstun">4.4.2.</a>&nbsp;
Keep alive with STUN<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#recovery">4.5.</a>&nbsp;
Flow Recovery<br />
<a href="#anchor12">5.</a>&nbsp;
Edge Proxy Procedures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#edge">5.1.</a>&nbsp;
Processing Register Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#flowtokens">5.2.</a>&nbsp;
Generating Flow Tokens<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.3.</a>&nbsp;
Forwarding Non-REGISTER Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">5.3.1.</a>&nbsp;
Processing Incoming Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">5.3.2.</a>&nbsp;
Processing Outgoing Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#edgekeep">5.4.</a>&nbsp;
Edge Proxy Keep alive Handling<br />
<a href="#registrar">6.</a>&nbsp;
Registrar Procedures<br />
<a href="#anchor16">7.</a>&nbsp;
Authoritative Proxy Procedures: Forwarding Requests<br />
<a href="#stunkeep">8.</a>&nbsp;
STUN Keep alive Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">8.1.</a>&nbsp;
Use with Sigcomp<br />
<a href="#anchor18">9.</a>&nbsp;
Example Message Flow<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">9.1.</a>&nbsp;
Subscription to configuration package<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">9.2.</a>&nbsp;
Registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">9.3.</a>&nbsp;
Incoming call and proxy crash<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">9.4.</a>&nbsp;
Re-registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">9.5.</a>&nbsp;
Outgoing call<br />
<a href="#grammar">10.</a>&nbsp;
Grammar<br />
<a href="#iana">11.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iana-flow-timer">11.1.</a>&nbsp;
Flow-Timer Header Field<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iana-reg-id">11.2.</a>&nbsp;
'reg-id' Contact Header Field Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iana-keepalive">11.3.</a>&nbsp;
SIP/SIPS URI Parameters<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iana-outbound">11.4.</a>&nbsp;
SIP Option Tag<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">11.5.</a>&nbsp;
430 (Flow Failed) Response Code<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#bad-first-hop">11.6.</a>&nbsp;
439 (First Hop Lacks Outbound Support) Response Code<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">11.7.</a>&nbsp;
Media Feature Tag<br />
<a href="#anchor26">12.</a>&nbsp;
Security Considerations<br />
<a href="#anchor27">13.</a>&nbsp;
Operational Notes on Transports<br />
<a href="#anchor28">14.</a>&nbsp;
Requirements<br />
<a href="#anchor29">15.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">16.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">16.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">16.2.</a>&nbsp;
Informational References<br />
<a href="#anchor32">Appendix&nbsp;A.</a>&nbsp;
Default Flow Registration Backoff Times<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>There are many environments for <a class='info' href='#RFC3261'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261]
      deployments in which the User Agent (UA) can form a connection to a
      Registrar or Proxy but in which connections in the reverse direction to
      the UA are not possible. This can happen for several reasons, but the
      most likely is a NAT or a firewall in between the SIP UA and the proxy.
      Many such devices will only allow outgoing connections. This
      specification allows a SIP User Agent behind such a firewall or NAT to
      receive inbound traffic associated with registrations or dialogs that it
      initiates.
</p>
<p>Most IP phones and personal computers get their network
      configurations dynamically via a protocol such as DHCP (Dynamic Host
      Configuration Protocol). These systems typically do not have a useful
      name in the Domain Name System (DNS), and they almost never have a
      long-term, stable DNS name that is appropriate for use in the
      subjectAltName of a certificate, as required by <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. However, these systems can still act as a
      Transport Layer Security (TLS) <a class='info' href='#RFC5246'>[RFC5246]<span> (</span><span class='info'>Dierks, T. and E. Rescorla, &ldquo;The Transport Layer Security (TLS) Protocol Version 1.2,&rdquo; August&nbsp;2008.</span><span>)</span></a> client and
      form outbound connections to a proxy or registrar which authenticates
      with a server certificate. The server can authenticate the UA using a
      shared secret in a digest challenge (as defined in Section 22 of RFC
      3261) over that TLS connection. This specification allows a SIP User
      Agent who has to initiate the TLS connection to receive inbound traffic
      associated with registrations or dialogs that it initiates.
</p>
<p>The key idea of this specification is that when a UA sends a REGISTER
      request or a dialog-forming request, the proxy can later use this same
      network "flow"--whether this is a bidirectional stream of UDP datagrams,
      a TCP connection, or an analogous concept in another transport
      protocol--to forward any incoming requests that need to go to this UA in
      the context of the registration or dialog.
</p>
<p>For a UA to receive incoming requests, the UA has to connect to a
      server. Since the server can't connect to the UA, the UA has to make
      sure that a flow is always active. This requires the UA to detect when a
      flow fails. Since such detection takes time and leaves a window of
      opportunity for missed incoming requests, this mechanism allows the UA
      to register over multiple flows at the same time. This specification
      also defines two keep alive schemes. The keep alive mechanism is used to
      keep NAT bindings fresh, and to allow the UA to detect when a flow has
      failed.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Conventions and Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Definitions</h3>

<p></p>
<blockquote class="text"><dl>
<dt>Authoritative Proxy:</dt>
<dd>A proxy that handles
            non-REGISTER requests for a specific Address-of-Record (AOR),
            performs the logical Location Server lookup described in <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, and forwards those requests to specific
            Contact URIs. (In <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the role which
            is authoritative for REGISTER requests for a specific AOR is a
            Registration Server.)
</dd>
<dt>Edge Proxy:</dt>
<dd>An Edge Proxy is any proxy that is
            located topologically between the registering User Agent and the
            Authoritative Proxy. The "first" edge proxy refers to the first
            edge proxy encountered when a UA sends a request.
</dd>
<dt>Flow:</dt>
<dd>A Flow is a network transport layer
            association between two hosts that is represented by the network
            address and port number of both ends and by the transport
            protocol. For TCP, a flow is equivalent to a TCP connection. For
            UDP a flow is a bidirectional stream of datagrams between a single
            pair of IP addresses and ports of both peers. With TCP, a flow
            often has a one to one correspondence with a single file
            descriptor in the operating system.
</dd>
<dt>Flow Token:</dt>
<dd>An identifier which uniquely identifies
            a flow which can be included in a SIP URI (Uniform Resource
            Identifier).
</dd>
<dt>reg-id:</dt>
<dd>This refers to the value of a new header
            field parameter value for the Contact header field. When a UA
            registers multiple times, each for a different flow, each
            concurrent registration gets a unique reg-id value.
</dd>
<dt>instance-id:</dt>
<dd>This specification uses the word
            instance-id to refer to the value of the "sip.instance" media
            feature tag in the Contact header field. This is a Uniform
            Resource Name (URN) that uniquely identifies this specific UA
            instance.
</dd>
<dt>ob Parameter:</dt>
<dd>The 'ob' parameter is a SIP URI
            parameter which has different meaning depending on context. In a
            Path header field value it is used by the first edge proxy to
            indicate that a flow token was added to the URI. In a Contact or
            Route header field value it indicates that the UA would like other
            requests in the same dialog routed over the same flow.
</dd>
<dt>outbound-proxy-set:</dt>
<dd>A set of SIP URIs (Uniform
            Resource Identifiers) that represents each of the outbound proxies
            (often Edge Proxies) with which the UA will attempt to maintain a
            direct flow. The first URI in the set is often referred to as the
            primary outbound proxy and the second as the secondary outbound
            proxy. There is no difference between any of the URIs in this set,
            nor does the primary/secondary terminology imply that one is
            preferred over the other.
</dd>
</dl></blockquote>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview</h3>

<p>The mechanisms defined in this document are useful in several
      scenarios discussed below, including the simple co-located registrar and
      proxy, a User Agent desiring multiple connections to a resource (for
      redundancy, for example), and a system that uses Edge Proxies.
</p>
<p>This entire section is non-normative.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Summary of Mechanism</h3>

<p>Each UA has a unique instance-id that stays the same for this UA
        even if the UA reboots or is power cycled. Each UA can register
        multiple times over different flows for the same SIP Address of Record
        (AOR) to achieve high reliability. Each registration includes the
        instance-id for the UA and a reg-id label that is different for each
        flow. The registrar can use the instance-id to recognize that two
        different registrations both correspond to the same UA. The registrar
        can use the reg-id label to recognize whether a UA is creating a new
        flow or refreshing or replacing an old one, possibly after a reboot or
        a network failure.
</p>
<p>When a proxy goes to route a message to a UA for which it has a
        binding, it can use any one of the flows on which a successful
        registration has been completed. A failure to deliver a request on a
        particular flow can be tried again on an alternate flow. Proxies can
        determine which flows go to the same UA by comparing the instance-id.
        Proxies can tell that a flow replaces a previously abandoned flow by
        looking at the reg-id.
</p>
<p>When sending a dialog-forming request, a UA can also ask its first
        edge proxy to route subsequent requests in that dialog over the same
        flow. This is necessary whether the UA has registered or not.
</p>
<p>UAs use a simple periodic message as a keep alive mechanism to keep
        their flow to the proxy or registrar alive. For connection oriented
        transports such as TCP this is based on carriage-return and line-feed
        sequences (CRLF), while for transports that are not connection
        oriented this is accomplished by using a SIP-specific usage profile of
        <a class='info' href='#RFC5389'>STUN (Session Traversal Utilities for
        NAT)<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> [RFC5389].
</p>
<a name="example-single"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Single Registrar and UA</h3>

<p>In the topology shown below, a single server is acting as both a
        registrar and proxy.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   +-----------+
   | Registrar |
   | Proxy     |
   +-----+-----+
         |
         |
    +----+--+
    | User  |
    | Agent |
    +-------+
</pre></div>
<p>User Agents which form only a single flow continue to register
        normally but include the instance-id as described in <a class='info' href='#section-instance'>Section&nbsp;4.1<span> (</span><span class='info'>Instance ID Creation</span><span>)</span></a>. The UA also includes a reg-id
        Contact header field which is used to allow the registrar to detect
        and avoid keeping invalid contacts when a UA reboots or reconnects
        after its old connection has failed for some reason.
</p>
<p>For clarity, here is an example. Bob's UA creates a new TCP flow to
        the registrar and sends the following REGISTER request.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bK-bad0ce-11-1036
Max-Forwards: 70
From: Bob &lt;sip:bob@example.com&gt;;tag=d879h76
To: Bob &lt;sip:bob@example.com&gt;
Call-ID: 8921348ju72je840.204
CSeq: 1 REGISTER
Supported: path, outbound
Contact: &lt;sip:line1@192.0.2.2;transport=tcp&gt;; reg-id=1;
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-000A95A0E128&gt;"
Content-Length: 0
</pre></div>
<p>The registrar challenges this registration to authenticate Bob.
        When the registrar adds an entry for this contact under the AOR for
        Bob, the registrar also keeps track of the connection over which it
        received this registration.
</p>
<p>The registrar saves the instance-id
        ("urn:uuid:00000000-0000-1000-8000-000A95A0E128") and reg-id ("1")
        along with the rest of the Contact header field. If the instance-id
        and reg-id are the same as a previous registration for the same AOR,
        the registrar replaces the old Contact URI and flow information. This
        allows a UA that has rebooted to replace its previous registration for
        each flow with minimal impact on overall system load.
</p>
<p>When Alice sends a request to Bob, his authoritative proxy selects
        the target set. The proxy forwards the request to elements in the
        target set based on the proxy's policy. The proxy looks at the target
        set and uses the instance-id to understand if two targets both end up
        routing to the same UA. When the proxy goes to forward a request to a
        given target, it looks and finds the flows over which it received the
        registration. The proxy then forwards the request over an existing
        flow, instead of resolving the Contact URI using the procedures in
        <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a> and trying to form a new flow to that
        contact.
</p>
<p>As described in the next section, if the proxy has multiple flows
        that all go to this UA, the proxy can choose any one of the
        registration bindings for this AOR that has the same instance-id as
        the selected UA.
</p>
<a name="multiple"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Multiple Connections from a User Agent</h3>

<p>There are various ways to deploy SIP to build a reliable and
        scalable system. This section discusses one such design that is
        possible with the mechanisms in this specification. Other designs are
        also possible.
</p>
<p>In the example system below, the logical outbound proxy/registrar
        for the domain is running on two hosts that share the appropriate
        state and can both provide registrar and outbound proxy functionality
        for the domain. The UA will form connections to two of the physical
        hosts that can perform the authoritative proxy/registrar function for
        the domain. Reliability is achieved by having the UA form two TCP
        connections to the domain.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    +-------------------+
    | Domain            |
    | Logical Proxy/Reg |
    |                   |
    |+-----+     +-----+|
    ||Host1|     |Host2||
    |+-----+     +-----+|
    +---\------------/--+
         \          /
          \        /
           \      /
            \    /
           +------+
           | User |
           | Agent|
           +------+
</pre></div>
<p>The UA is configured with multiple outbound proxy registration
        URIs. These URIs are configured into the UA through whatever the
        normal mechanism is to configure the proxy address and AOR in the UA.
        If the AOR is alice@example.com, the outbound-proxy-set might look
        something like "sip:primary.example.com" and
        "sip:secondary.example.com". Note that each URI in the
        outbound-proxy-set could resolve to several different physical hosts.
        The administrative domain that created these URIs should ensure that
        the two URIs resolve to separate hosts. These URIs are handled
        according to normal SIP processing rules, so mechanisms like <a class='info' href='#RFC2782'>DNS SRV<span> (</span><span class='info'>Gulbrandsen, A., Vixie, P., and L. Esibov, &ldquo;A DNS RR for specifying the location of services (DNS SRV),&rdquo; February&nbsp;2000.</span><span>)</span></a> [RFC2782] can be used to do load balancing
        across a proxy farm. The approach in this document does not prevent
        future extensions, such as <a class='info' href='#I-D.ietf-sipping-config-framework'>the SIP UA configuration
        framework<span> (</span><span class='info'>Channabasappa, S., &ldquo;A Framework for Session Initiation Protocol User Agent Profile Delivery,&rdquo; February&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;sipping&#8209;config&#8209;framework], from adding other ways for a User Agent to discover
        its outbound-proxy-set.
</p>
<p>The domain also needs to ensure that a request for the UA sent to
        host1 or host2 is then sent across the appropriate flow to the UA. The
        domain might choose to use the Path header approach (as described in
        the next section) to store this internal routing information on host1
        or host2.
</p>
<p>When a single server fails, all the UAs that have a flow through it
        will detect a flow failure and try to reconnect. This can cause large
        loads on the server. When large numbers of hosts reconnect nearly
        simultaneously, this is referred to as the avalanche restart problem,
        and is further discussed in <a class='info' href='#recovery'>Section&nbsp;4.5<span> (</span><span class='info'>Flow Recovery</span><span>)</span></a>. The
        multiple flows to many servers help reduce the load caused by the
        avalanche restart. If a UA has multiple flows, and one of the servers
        fails, the UA delays a recommended amount of time before trying to
        form a new connection to replace the flow to the server that failed.
        By spreading out the time used for all the UAs to reconnect to a
        server, the load on the server farm is reduced.
</p>
<p>Scalability is achieved by using <a class='info' href='#RFC2782'>DNS
        SRV<span> (</span><span class='info'>Gulbrandsen, A., Vixie, P., and L. Esibov, &ldquo;A DNS RR for specifying the location of services (DNS SRV),&rdquo; February&nbsp;2000.</span><span>)</span></a> [RFC2782] to load balance the primary connection across a set of
        machines that can service the primary connection, and also using DNS
        SRV to load balance across a separate set of machines that can service
        the secondary connection. The deployment here requires that DNS is
        configured with one entry that resolves to all the primary hosts and
        another entry that resolves to all the secondary hosts. While this
        introduces additional DNS configuration, the approach works and
        requires no additional SIP extensions to <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<p>Another motivation for maintaining multiple flows between the UA
        and its registrar is related to multihomed UAs. Such UAs can benefit
        from multiple connections from different interfaces to protect against
        the failure of an individual access link.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Edge Proxies</h3>

<p>Some SIP deployments use edge proxies such that the UA sends the
        REGISTER to an Edge Proxy that then forwards the REGISTER to the
        Registrar. There could be a NAT or firewall between the UA and the
        Edge Proxy.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
             +---------+
             |Registrar|
             |Proxy    |
             +---------+
              /      \
             /        \
            /          \
         +-----+     +-----+
         |Edge1|     |Edge2|
         +-----+     +-----+
            \           /
             \         /
     ----------------------------NAT/FW
               \     /
                \   /
               +------+
               |User  |
               |Agent |
               +------+
</pre></div>
<p>The Edge Proxy includes a <a class='info' href='#RFC3327'>Path header<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> [RFC3327]
        so that when the proxy/registrar later forwards a request to this UA,
        the request is routed through the Edge Proxy.
</p>
<p>These systems can use effectively the same mechanism as described
        in the previous sections but need to use the Path header. When the
        Edge Proxy receives a registration, it needs to create an identifier
        value that is unique to this flow (and not a subsequent flow with the
        same addresses) and put this identifier in the Path header URI. This
        identifier has two purposes. First, it allows the Edge Proxy to map
        future requests back to the correct flow. Second, because the
        identifier will only be returned if the user authenticates with the
        registrar successfully, it allows the Edge Proxy to indirectly check
        the user's authentication information via the registrar. The
        identifier is placed in the user portion of a loose route in the Path
        header. If the registration succeeds, the Edge Proxy needs to map
        future requests that are routed to the identifier value from the Path
        header, to the associated flow.
</p>
<p>The term Edge Proxy is often used to refer to deployments where the
        Edge Proxy is in the same administrative domain as the Registrar.
        However, in this specification we use the term to refer to any proxy
        between the UA and the Registrar. For example the Edge Proxy may be
        inside an enterprise that requires its use and the registrar could be
        from a service provider with no relationship to the enterprise.
        Regardless if they are in the same administrative domain, this
        specification requires that Registrars and Edge proxies support the
        Path header mechanism in <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
Keep alive Technique</h3>

<p>This document describes two keep alive mechanisms: a CRLF keep
        alive and a STUN keep alive. Each of these mechanisms uses a
        client-to-server "ping" keep alive and a corresponding
        server-to-client "pong" message. This ping-pong sequence allows the
        client, and optionally the server, to tell if its flow is still active
        and useful for SIP traffic. The server responds to pings by sending
        pongs. If the client does not receive a pong in response to its ping
        (allowing for retransmission for STUN as described in <a class='info' href='#keepstun'>Section&nbsp;4.4.2<span> (</span><span class='info'>Keep alive with STUN</span><span>)</span></a>), it declares the flow dead and opens a new
        flow in its place.
</p>
<p>This document also suggests timer values for these client keep
        alive mechanisms. These timer values were chosen to keep most NAT and
        firewall bindings open, to detect unresponsive servers within 2
        minutes, and to mitigate against the avalanche restart problem.
        However, the client may choose different timer values to suit its
        needs, for example to optimize battery life. In some environments, the
        server can also keep track of the time since a ping was received over
        a flow to guess the likelihood that the flow is still useful for
        delivering SIP messages.
</p>
<p>When the UA detects that a flow has failed or that the flow
        definition has changed, the UA needs to re-register and will use the
        back-off mechanism described in <a class='info' href='#recovery'>Section&nbsp;4.5<span> (</span><span class='info'>Flow Recovery</span><span>)</span></a> to
        provide congestion relief when a large number of agents simultaneously
        reboot.
</p>
<p>A keep alive mechanism needs to keep NAT bindings refreshed; for
        connections, it also needs to detect failure of a connection; and for
        connectionless transports, it needs to detect flow failures including
        changes to the NAT public mapping. For connection oriented transports
        such as TCP <a class='info' href='#RFC0793'>[RFC0793]<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> and SCTP <a class='info' href='#RFC4960'>[RFC4960]<span> (</span><span class='info'>Stewart, R., &ldquo;Stream Control Transmission Protocol,&rdquo; September&nbsp;2007.</span><span>)</span></a>, this specification describes a keep alive
        approach based on sending CRLFs. For connectionless transport, such as
        UDP <a class='info' href='#RFC0768'>[RFC0768]<span> (</span><span class='info'>Postel, J., &ldquo;User Datagram Protocol,&rdquo; August&nbsp;1980.</span><span>)</span></a>, this specification describes using
        <a class='info' href='#RFC5389'>STUN<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> [RFC5389] over the same flow as the SIP
        traffic to perform the keep alive.
</p>
<p>UAs and Proxies are also free to use native transport keep alives,
        however the application may not be able to set these timers on a
        per-connection basis, and the server certainly cannot make any
        assumption about what values are used. Use of native transport keep
        alives is outside the scope of this document.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5.1"></a><h3>3.5.1.&nbsp;
CRLF Keep alive Technique</h3>

<p>This approach can only be used with connection-oriented
          transports such as TCP or SCTP. The client periodically sends a
          double-CRLF (the "ping") then waits to receive a single CRLF (the
          "pong"). If the client does not receive a "pong" within an
          appropriate amount of time, it considers the flow failed.
</p>
<p></p>
<blockquote class="text">
<p>Sending a CRLF over a connection-oriented transport is
              backwards compatible (because of requirements in Section 7.5 of
              <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>), but only implementations which
              support this specification will respond to a "ping" with a
              "pong".
</p>
</blockquote>

<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5.2"></a><h3>3.5.2.&nbsp;
STUN Keep alive Technique</h3>

<p>This approach can only be used for connection-less transports,
          such as UDP.
</p>
<p>For connection-less transports, a flow definition could change
          because a NAT device in the network path reboots and the resulting
          public IP address or port mapping for the UA changes. To detect
          this, STUN requests are sent over the same flow that is being used
          for the SIP traffic. The proxy or registrar acts as a limited <a class='info' href='#RFC5389'>Session Traversal Utilities for NAT (STUN)<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> [RFC5389]
          server on the SIP signaling port.
</p>
<p></p>
<blockquote class="text">
<p>Note: The STUN mechanism is very robust and allows the
              detection of a changed IP address and port. Many other options
              were considered, but the SIP Working Group selected the
              STUN-based approach. Approaches using SIP requests were
              abandoned because many believed that good performance and full
              backwards compatibility using this method were mutually
              exclusive.
</p>
</blockquote>

<a name="mech-ua"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
User Agent Procedures</h3>

<a name="section-instance"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Instance ID Creation</h3>

<p>Each UA MUST have an Instance Identifier <a class='info' href='#RFC2141'>Uniform Resource Name (URN)<span> (</span><span class='info'>Moats, R., &ldquo;URN Syntax,&rdquo; May&nbsp;1997.</span><span>)</span></a> [RFC2141] that uniquely
        identifies the device. Usage of a URN provides a persistent and unique
        name for the UA instance. It also provides an easy way to guarantee
        uniqueness within the AOR. This URN MUST be persistent across power
        cycles of the device. The Instance ID MUST NOT change as the device
        moves from one network to another.
</p>
<p>A UA SHOULD create a UUID URN <a class='info' href='#RFC4122'>[RFC4122]<span> (</span><span class='info'>Leach, P., Mealling, M., and R. Salz, &ldquo;A Universally Unique IDentifier (UUID) URN Namespace,&rdquo; July&nbsp;2005.</span><span>)</span></a> as its
        instance-id. The UUID URN allows for non-centralized computation of a
        URN based on time, unique names (such as a MAC address), or a random
        number generator.
</p>
<p></p>
<blockquote class="text">
<p>A device like a soft-phone, when first installed, can generate
            a <a class='info' href='#RFC4122'>UUID<span> (</span><span class='info'>Leach, P., Mealling, M., and R. Salz, &ldquo;A Universally Unique IDentifier (UUID) URN Namespace,&rdquo; July&nbsp;2005.</span><span>)</span></a> [RFC4122] and then save this in
            persistent storage for all future use. For a device such as a hard
            phone, which will only ever have a single SIP UA present, the UUID
            can include the MAC address and be generated at any time because
            it is guaranteed that no other UUID is being generated at the same
            time on that physical device. This means the value of the time
            component of the UUID can be arbitrarily selected to be any time
            less than the time when the device was manufactured. A time of 0
            (as shown in the example in <a class='info' href='#example-single'>Section&nbsp;3.2<span> (</span><span class='info'>Single Registrar and UA</span><span>)</span></a>)
            is perfectly legal as long as the device knows no other UUIDs were
            generated at this time on this device.
</p>
</blockquote>

<p>If a URN scheme other than UUID is used, the UA MUST only use URNs
        for which an IETF RFC defines how the specific URN needs to be
        constructed and used in the sip.instance Contact parameter for
        outbound behavior.
</p>
<p>To convey its instance-id in both requests and responses, the UA
        includes a "sip.instance" media feature tag as a UA characteristic
        <a class='info' href='#RFC3840'>[RFC3840]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Indicating User Agent Capabilities in the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>. This media feature tag is encoded in
        the Contact header field as the "+sip.instance" Contact header field
        parameter. One case where a UA could prefer to omit the sip.instance
        media feature tag is when it is making an anonymous request or some
        other privacy concern requires that the UA not reveal its
        identity.
</p>
<p></p>
<blockquote class="text">
<p><a class='info' href='#RFC3840'>[RFC3840]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Indicating User Agent Capabilities in the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a> defines equality rules for
            callee capabilities parameters, and according to that
            specification, the "sip.instance" media feature tag will be
            compared by case-sensitive string comparison. This means that the
            URN will be encapsulated by angle brackets ("&lt;" and "&gt;")
            when it is placed within the quoted string value of the
            +sip.instance Contact header field parameter. The case-sensitive
            matching rules apply only to the generic usages defined in the
            <a class='info' href='#RFC3841'>callee capabilities<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a> [RFC3841] and the <a class='info' href='#RFC3841'>caller preferences<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a> [RFC3841] specifications. When
            the instance ID is used in this specification, it is "extracted"
            from the value in the "sip.instance" media feature tag. Thus,
            equality comparisons are performed using the rules for URN
            equality that are specific to the scheme in the URN. If the
            element performing the comparisons does not understand the URN
            scheme, it performs the comparisons using the lexical equality
            rules defined in <a class='info' href='#RFC2141'>[RFC2141]<span> (</span><span class='info'>Moats, R., &ldquo;URN Syntax,&rdquo; May&nbsp;1997.</span><span>)</span></a>. Lexical equality
            could result in two URNs being considered unequal when they are
            actually equal. In this specific usage of URNs, the only element
            which provides the URN is the SIP UA instance identified by that
            URN. As a result, the UA instance has to provide lexically
            equivalent URNs in each registration it generates. This is likely
            to be normal behavior in any case; clients are not likely to
            modify the value of the instance ID so that it remains
            functionally equivalent yet lexicographically different from
            previous registrations.
</p>
</blockquote>

<a name="reg"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Registrations</h3>

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.1"></a><h3>4.2.1.&nbsp;
Initial Registrations</h3>

<p>At configuration time, UAs obtain one or more SIP URIs
          representing the default outbound-proxy-set. This specification
          assumes the set is determined via any of a number of configuration
          mechanisms, and future specifications can define additional
          mechanisms such as using DNS to discover this set. How the UA is
          configured is outside the scope of this specification. However, a UA
          MUST support sets with at least two outbound proxy URIs and SHOULD
          support sets with up to four URIs.
</p>
<p>For each outbound proxy URI in the set, the UAC SHOULD send a
          REGISTER request using this URI as the default outbound proxy.
          (Alternatively, the UA could limit the number of flows formed to
          conserve battery power, for example). If the set has more than one
          URI, the UAC MUST send a REGISTER request to at least two of the
          default outbound proxies from the set. UAs that support this
          specification MUST include the outbound option tag in a Supported
          header field in a REGISTER request. Each of these REGISTER requests
          will use a unique Call-ID. Forming the route set for the request is
          outside the scope of this document, but typically results in sending
          the REGISTER such that the topmost Route header field contains a
          loose route to the outbound proxy URI.
</p>
<p>REGISTER requests, other than those described in <a class='info' href='#third-party-reg'>Section&nbsp;4.2.3<span> (</span><span class='info'>Third Party Registrations</span><span>)</span></a>, MUST include an instance-id media
          feature tag as specified in <a class='info' href='#section-instance'>Section&nbsp;4.1<span> (</span><span class='info'>Instance ID Creation</span><span>)</span></a>.
</p>
<p>For registration requests in accordance to this specification,
          the UA MUST include reg-id parameter in the Contact header field
          that is distinct from other reg-id parameters used from the same
          +sip.instance and AOR. Each one of these registrations will form a
          new flow from the UA to the proxy. The sequence of reg-id values
          does not have to be sequential but MUST be exactly the same sequence
          of reg-id values each time the UA instance power cycles or reboots
          so that the reg-id values will collide with the previously used
          reg-id values. This is so the registrar can replace the older
          registrations.
</p>
<p></p>
<blockquote class="text">
<p>The UAC can situationally decide whether to request outbound
              behavior by including or omitting the reg-id Contact header
              field parameter. For example, imagine the outbound-proxy-set
              contains two proxies in different domains, EP1 and EP2. If an
              outbound-style registration succeeded for a flow through EP1,
              the UA might decide to include 'outbound' in its Require header
              field when registering with EP2, in order to insure consistency.
              Similarly, if the registration through EP1 did not support
              outbound, the UA might not register with EP2 at all.
</p>
</blockquote>

<p>The UAC MUST support the <a class='info' href='#RFC3327'>Path
          header<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> [RFC3327] mechanism, and indicate its support by including the
          'path' option-tag in a Supported header field value in its REGISTER
          requests. Other than optionally examining the Path vector in the
          response, this is all that is required of the UAC to support
          Path.
</p>
<p>The UAC examines successful registration responses for the
          presence of an outbound option-tag in a Require header field value.
          Presence of this option-tag indicates that the registrar is
          compliant with this specification, and that any edge proxies which
          needed to participate are also compliant. If the registrar did not
          support outbound, the UA has potentially registered an un-routable
          contact. It is the responsibility of the UA to remove any
          inappropriate Contacts.
</p>
<p>If outbound registration succeeded, as indicated by the presence
          of the outbound option-tag in the Require header field of a
          successful registration response, the UA begins sending keep alives
          as described in <a class='info' href='#detect-fail'>Section&nbsp;4.4<span> (</span><span class='info'>Keep-alives and Detecting Flow Failure</span><span>)</span></a>.
</p>
<p>Note that the UA needs to honor 503 (Service Unavailable)
          responses to registrations as described in <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>. In
          particular, implementors should note that when receiving a 503
          (Service Unavailable) response with a Retry-After header field, the
          UA is expected to wait the indicated amount of time and retry the
          registration. A Retry-After header field value of 0 is valid and
          indicates the UA is expected to retry the REGISTER request
          immediately. Implementations need to ensure that when retrying the
          REGISTER request, they revisit the DNS resolution results such that
          the UA can select an alternate host from the one chosen the previous
          time the URI was resolved.
</p>
<p>If the registering UA receives a 439 (First Hop Lacks Outbound
          Support) response to a REGISTER request, it MAY re-attempt
          registration without using the outbound mechanism (subject to local
          policy at the client). If the client has one or more alternate
          outbound proxies available, it MAY re-attempt registration through
          such outbound proxies. See <a class='info' href='#bad-first-hop'>Section&nbsp;11.6<span> (</span><span class='info'>439 (First Hop Lacks Outbound Support) Response Code</span><span>)</span></a> for
          more information on the 439 response code.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.2"></a><h3>4.2.2.&nbsp;
Subsequent REGISTER requests</h3>

<p>Registrations for refreshing a binding and for removing a binding
          use the same instance-id and reg-id values as the corresponding
          initial registration where the binding was added. Registrations
          which merely refresh an existing binding are sent over the same flow
          as the original registration where the binding was added.
</p>
<p>If a re-registration is rejected with a recoverable error
          response, for example by a 503 (Service Unavailable) containing a
          Retry-After header, the UAC SHOULD NOT tear down the corresponding
          flow if the flow uses a connection-oriented transport such as TCP.
          As long as "pongs" are received in response to "pings", the flow
          SHOULD be kept active until a non-recoverable error response is
          received. This prevents unnecessary closing and opening of
          connections.
</p>
<a name="third-party-reg"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.3"></a><h3>4.2.3.&nbsp;
Third Party Registrations</h3>

<p>In an initial registration or re-registration, a UA MUST NOT
          include a reg-id header parameter in the Contact header field if the
          registering UA is not the same instance as the UA referred to by the
          target Contact header field. (This practice is occasionally used to
          install forwarding policy into registrars.)
</p>
<p>A UAC also MUST NOT include an instance-id feature tag or reg-id
          Contact header field parameter in a request to un-register all
          Contacts (a single Contact header field value with the value of
          "*").
</p>
<a name="send"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Sending Non-REGISTER Requests</h3>

<p>When a UAC is about to send a request, it first performs normal
        processing to select the next hop URI. The UA can use a variety of
        techniques to compute the route set and accordingly the next hop URI.
        Discussion of these techniques is outside the scope of this document.
        UAs that support this specification SHOULD include the outbound option
        tag in a Supported header field in a request that is not a REGISTER
        request.
</p>
<p>The UAC performs normal DNS resolution on the next hop URI (as
        described in <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>) to find a protocol, IP
        address, and port. For protocols that don't use TLS, if the UAC has an
        existing flow to this IP address, and port with the correct protocol,
        then the UAC MUST use the existing connection. For TLS protocols,
        there MUST also be a match between the host production in the next hop
        and one of the URIs contained in the subjectAltName in the peer
        certificate. If the UAC cannot use one of the existing flows, then it
        SHOULD form a new flow by sending a datagram or opening a new
        connection to the next hop, as appropriate for the transport
        protocol.
</p>
<p>Typically, a UAC using the procedures of this document and sending
        a dialog-forming request will want all subsequent requests in the
        dialog to arrive over the same flow. If the UAC is using a <a class='info' href='#I-D.ietf-sip-gruu'>GRUU<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP),&rdquo; October&nbsp;2007.</span><span>)</span></a> [I&#8209;D.ietf&#8209;sip&#8209;gruu] that was instantiated using a
        Contact header field value that included an "ob" parameter, the UAC
        sends the request over the flow used for registration and susequent
        requests will arrive over that same flow. If the UAC is not using such
        a GRUU, then the UAC adds an "ob" parameter to its Contact header
        field value. This will cause all subsequent requests in the dialog to
        arrive over the flow instantiated by the dialog-forming request. This
        case is typical when the request is sent prior to registration, such
        as in the the initial subcription dialog for the <a class='info' href='#I-D.ietf-sipping-config-framework'>configuration
        framework<span> (</span><span class='info'>Channabasappa, S., &ldquo;A Framework for Session Initiation Protocol User Agent Profile Delivery,&rdquo; February&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;sipping&#8209;config&#8209;framework].
</p>
<p></p>
<blockquote class="text">
<p>Note that if the UAC wants a UDP flow to work through NATs or
            firewalls it still needs to put the 'rport' parameter <a class='info' href='#RFC3581'>[RFC3581]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Extension to the Session Initiation Protocol (SIP) for Symmetric Response Routing,&rdquo; August&nbsp;2003.</span><span>)</span></a> in its Via header field value, and send
            from the port it is prepared to receive on. More general
            information about NAT traversal in SIP is described in <a class='info' href='#I-D.ietf-sipping-nat-scenarios'>[I&#8209;D.ietf&#8209;sipping&#8209;nat&#8209;scenarios]<span> (</span><span class='info'>Boulton, C., Rosenberg, J., Camarillo, G., and F. Audet, &ldquo;Best Current Practices for NAT Traversal for Client-Server SIP,&rdquo; February&nbsp;2010.</span><span>)</span></a>.
</p>
</blockquote>

<a name="detect-fail"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Keep-alives and Detecting Flow Failure</h3>

<p>Keep alives are used for refreshing NAT/firewall bindings and
        detecting flow failure. Flows can fail for many reasons including NATs
        rebooting and Edge Proxies crashing.
</p>
<p>As described in <a class='info' href='#reg'>Section&nbsp;4.2<span> (</span><span class='info'>Registrations</span><span>)</span></a>, a UA that registers
        will begin sending keep alives after an appropriate registration
        response. A UA that does not register (for example, a PSTN gateway
        behind a firewall) can also send keep alives under certain
        circumstances.
</p>
<p>Under specific circumstances, a UAC might be allowed to send STUN
        keep alives even if the procedures in <a class='info' href='#reg'>Section&nbsp;4.2<span> (</span><span class='info'>Registrations</span><span>)</span></a> were
        not completed, provided that there is an explicit indication that the
        target first hop SIP node supports STUN keep alives. This applies for
        example to a non-registering UA or to a case where the UA registration
        succeeded, but the response did not include the outbound option-tag in
        the Require header field.
</p>
<p></p>
<blockquote class="text">
<p>Note that a UA can "always" send a double CRLF (a "ping") over
            connection-oriented transports as this is already allowed by
            Section 7.5/<a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, However a UA that did
            not register using outbound registration cannot expect a CRLF in
            response (a "pong") unless the UA has an explicit indication that
            CRLF keep alives are supported as described in this section.
            Likewise, a UA that did not successfully register with outbound
            procedures needs explicit indication that the target first hop SIP
            node supports STUN keep alives before it can send any STUN
            messages.
</p>
</blockquote>

<p>A configuration option indicating keep alive support for a specific
        target is considered an explicit indication. If these conditions are
        satisfied, the UA sends its keep alives according to the same
        guidelines described in the rest of this section as UAs which
        register.
</p>
<p>The UA needs to detect when a specific flow fails. The UA actively
        tries to detect failure by periodically sending keep alive messages
        using one of the techniques described in <a class='info' href='#keepcrlf'>Section&nbsp;4.4.1<span> (</span><span class='info'>Keep alive with CRLF</span><span>)</span></a> or <a class='info' href='#keepstun'>Section&nbsp;4.4.2<span> (</span><span class='info'>Keep alive with STUN</span><span>)</span></a>. If a
        flow with a registration has failed, the UA follows the procedures in
        <a class='info' href='#reg'>Section&nbsp;4.2<span> (</span><span class='info'>Registrations</span><span>)</span></a> to form a new flow to replace the failed
        one.
</p>
<p>When a successful registration response contains the Flow-Timer
        header field, the value of this header field is the number of seconds
        the server is prepared to wait without seeing keep alives before it
        could consider the corresponding flow dead. Note that the server would
        wait for an amount of time larger than the Flow-Timer in order to have
        a grace period to account for transport delay. The UA MUST send keep
        alives at least as often as this number of seconds. If the UA uses the
        server recommended keep alive frequency it SHOULD send its keep alives
        so that the interval between each keep alive is randomly distributed
        between 80% and 100% of the server provided time. For example, if the
        server suggests 120 seconds, the UA would send each keep alive with a
        different frequency between 95 and 120 seconds.
</p>
<p>If no Flow-Timer header field was present in a register response
        for this flow, the UA can send keep alives at its discretion. The
        sections below provide RECOMMENDED default values for these keep
        alives.
</p>
<p>The client needs to perform normal <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>
        SIP DNS resolution on the URI from the outbound-proxy-set to pick a
        transport. Once a transport is selected, the UA selects the keep alive
        approach that is recommended for that transport.
</p>
<p>Section <a class='info' href='#keepcrlf'>Section&nbsp;4.4.1<span> (</span><span class='info'>Keep alive with CRLF</span><span>)</span></a> describes a keep alive
        mechanism for connection oriented transports such as TCP or SCTP.
        Section <a class='info' href='#keepstun'>Section&nbsp;4.4.2<span> (</span><span class='info'>Keep alive with STUN</span><span>)</span></a> describes a keep alive
        mechanism for connection-less transports such as UDP. Support for
        other transports such as DCCP <a class='info' href='#RFC4340'>[RFC4340]<span> (</span><span class='info'>Kohler, E., Handley, M., and S. Floyd, &ldquo;Datagram Congestion Control Protocol (DCCP),&rdquo; March&nbsp;2006.</span><span>)</span></a> is for
        further study.
</p>
<a name="keepcrlf"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.1"></a><h3>4.4.1.&nbsp;
Keep alive with CRLF</h3>

<p>This approach MUST only be used with connection oriented
          transports such as TCP or SCTP.
</p>
<p>A User Agent that forms flows, checks if the configured URI to
          which the UA is connecting resolves to a connection-oriented
          transport (ex: TCP and TLS over TCP).
</p>
<p>For this mechanism, the client "ping" is a double-CRLF sequence,
          and the server "pong" is a single CRLF, as defined in the ABNF
          below:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
CRLF = CR LF
double-CRLF = CR LF CR LF
CR = 0x0d
LF = 0x0a</pre></div>
<p>The ping and pong need to be sent between SIP messages and cannot
          be sent in the middle of a SIP message. If sending over TLS, the
          CRLFs are sent inside the TLS protected channel. If sending over a
          <a class='info' href='#RFC3320'>SigComp<span> (</span><span class='info'>Price, R., Bormann, C., Christoffersson, J., Hannu, H., Liu, Z., and J. Rosenberg, &ldquo;Signaling Compression (SigComp),&rdquo; January&nbsp;2003.</span><span>)</span></a> [RFC3320] compressed data stream, the
          CRLF keep alives are sent inside the compressed stream. The double
          CRLF is considered a single SigComp message. The specific mechanism
          for representing these characters is an implementation specific
          matter to be handled by the SigComp compressor at the sending
          end.
</p>
<p>If a pong is not received within 10 seconds after sending a ping
          (or immediately after processing any incoming message being received
          when that 10 seconds expires), then the client MUST treat the flow
          as failed. Clients MUST support this CRLF keep alive.
</p>
<p></p>
<blockquote class="text">
<p>Note: This value of 10 second timeout was selected to be long
              enough that it allows plenty of time for a server to send a
              response even if the server is temporarily busy with an
              administrative activity. At the same time, it was selected to be
              small enough that a UA registered to two redundant servers with
              unremarkable hardware uptime could still easily provide very
              high levels of overall reliability. Although some Internet
              protocols are designed for round trip times over 10 seconds, SIP
              for real time communications is not really usable in these type
              of environments as users often abandon calls before waiting much
              more than a few seconds.
</p>
</blockquote><p>When a Flow-Timer header field is not provided in the most
          recent success registration response, the proper selection of keep
          alive frequency is primarily a trade-off between battery usage and
          availability. The UA MUST select a random number between a fixed or
          configurable upper bound and a lower bound, where the lower bound is
          20% less then the upper bound. The fixed upper bound or the default
          configurable upper bound SHOULD be 120 seconds (95 seconds lower
          bound) where battery power is not a concern and 840 seconds (672
          seconds lower bound) where battery power is a concern. The random
          number will be different for each keep alive ping.
</p>
<p></p>
<blockquote class="text">
<p>Note on selection of time values: the 120 seconds upper bound
              was chosen based on the idea that for a good user experience,
              failures normally will be detected in this amount of time and a
              new connection set up. The 14 minute upper-bound for
              battery-powered devices was selected based on NATs with TCP
              timeouts as low as 15 minutes. Operators that wish to change the
              relationship between load on servers and the expected time that
              a user might not receive inbound communications will probably
              adjust this time. The 95 seconds lower bound was chosen so that
              the jitter introduced will result in a relatively even load on
              the servers after 30 minutes.
</p>
</blockquote>

<a name="keepstun"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.2"></a><h3>4.4.2.&nbsp;
Keep alive with STUN</h3>

<p>This approach MUST only be used with connection-less transports,
          such as UDP.
</p>
<p>A User Agent that forms flows, checks if the configured URI to
          which the UA is connecting resolves to use the UDP transport. The UA
          can periodically perform keep alive checks by sending <a class='info' href='#RFC5389'>STUN<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> [RFC5389] Binding Requests over the flow as
          described in <a class='info' href='#stunkeep'>Section&nbsp;8<span> (</span><span class='info'>STUN Keep alive Processing</span><span>)</span></a>. Clients MUST support
          STUN based keep alives.
</p>
<p>When a Flow-Timer header field is not included in a successful
          registration response, the time between each keep alive request
          SHOULD be a random number between 24 and 29 seconds.
</p>
<p></p>
<blockquote class="text">
<p>Note on selection of time values: the upper bound of 29
              seconds was selected, as many NATs have UDP timeouts as low as
              30 seconds. The 24 second lower bound was selected so that after
              10 minutes the jitter introduced by different timers will make
              the keep alive requests unsynchronized to evenly spread the load
              on the servers. Note that the short NAT timeouts with UDP have a
              negative impact on battery life.
</p>
</blockquote>

<p>If a STUN Binding Error Response is received, or if no Binding
          Response is received after 7 retransmissions (16 times the STUN
          "RTO" timer--RTO is an estimate of round-trip time), the UA
          considers the flow failed. If the XOR-MAPPED-ADDRESS in the STUN
          Binding Response changes, the UA MUST treat this event as a failure
          on the flow.
</p>
<a name="recovery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Flow Recovery</h3>

<p>When a flow used for registration (through a particular URI in the
        outbound-proxy-set) fails, the UA needs to form a new flow to replace
        the old flow and replace any registrations that were previously sent
        over this flow. Each new registration MUST have the same reg-id value
        as the registration it replaces. This is done in much the same way as
        forming a brand new flow as described in <a class='info' href='#reg'>Section&nbsp;4.2<span> (</span><span class='info'>Registrations</span><span>)</span></a>;
        however, if there is a failure in forming this flow, the UA needs to
        wait a certain amount of time before retrying to form a flow to this
        particular next hop.
</p>
<p>The amount of time to wait depends if the previous attempt at
        establishing a flow was successful. For the purposes of this section,
        a flow is considered successful if outbound registration succeeded,
        and if keep alives are in use on this flow, at least one subsequent
        keep alive response was received.
</p>
<p>The number of seconds to wait is computed in the following way. If
        all of the flows to every URI in the outbound proxy set have failed,
        the base-time is set to 30 seconds; otherwise, in the case where at
        least one of the flows has not failed, the base-time is set to 90
        seconds. The upper-bound wait time (W) is computed by taking two
        raised to the power of the number of consecutive registration failures
        for that URI, and multiplying this by the base time, up to a maximum
        of 1800 seconds.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
W = min( max-time, (base-time * (2 ^ consecutive-failures)))</pre></div>
<p>These times MAY be configurable in the UA. The three times are:
        </p>
<ul class="text">
<li>max-time with a default of 1800 seconds
</li>
<li>base-time (if all failed) with a default of 30 seconds
</li>
<li>base-time (if all have not failed) with a default of 90
            seconds
</li>
</ul><p>For example, if the base time is 30 seconds, and there were
        three failures, then the upper-bound wait time is min(1800,30*(2^3))
        or 240 seconds. The actual amount of time the UA waits before retrying
        registration (the retry delay time) is computed by selecting a uniform
        random time between 50 and 100 percent of the upper-bound wait time.
        The UA MUST wait for at least the value of the retry delay time before
        trying another registration to form a new flow for that URI (a 503
        response to an earlier failed registration attempt with a Retry-After
        header field value may cause the UA to wait longer)..
</p>
<p>To be explicitly clear on the boundary conditions: when the UA
        boots it immediately tries to register. If this fails and no
        registration on other flows succeed, the first retry happens somewhere
        between 30 and 60 seconds after the failure of the first registration
        request. If the number of consecutive-failures is large enough that
        the maximum of 1800 seconds is reached, the UA will keep trying
        indefinitely with a random time of 15 to 30 minutes between each
        attempt.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Edge Proxy Procedures</h3>

<a name="edge"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Processing Register Requests</h3>

<p>When an Edge Proxy receives a registration request with a reg-id
        header field parameter in the Contact header field, it needs to
        determine if it (the edge proxy) will have to be visited for any
        subsequent requests sent to the user agent identified in the Contact
        header field, or not. If the edge proxy is the first hop, as indicated
        by the Via header field, it MUST insert its URI in a Path header field
        value as described in <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>. If it is not the
        first hop, it might still decide to add itself to the Path header
        based on local policy. In addition, if the Edge Proxy is the first SIP
        node after the UAC, the edge proxy either MUST store a "flow token"
        (containing information about the flow from the previous hop) in its
        Path URI or reject the request. The flow token MUST be an identifier
        that is unique to this network flow. The flow token MAY be placed in
        the userpart of the URI. In addition, the first node MUST include an
        'ob' URI parameter in its Path header field value. If the Edge Proxy
        is not the first SIP node after the UAC it MUST NOT place an ob URI
        parameter in a Path header field value. The Edge Proxy can determine
        if it is the first hop by examining the Via header field.
</p>
<a name="flowtokens"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Generating Flow Tokens</h3>

<p>A trivial but impractical way to satisfy the flow token requirement
        in <a class='info' href='#edge'>Section&nbsp;5.1<span> (</span><span class='info'>Processing Register Requests</span><span>)</span></a> involves storing a mapping between an
        incrementing counter and the connection information; however this
        would require the Edge Proxy to keep an infeasible amount of state. It
        is unclear when this state could be removed and the approach would
        have problems if the proxy crashed and lost the value of the counter.
        A stateless example is provided below. A proxy can use any algorithm
        it wants as long as the flow token is unique to a flow, the flow can
        be recovered from the token, and the token cannot be modified by
        attackers.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Example Algorithm:</dt>
<dd>When the proxy boots it selects a
            20-octet crypto random key called K that only the Edge Proxy
            knows. A byte array, called S, is formed that contains the
            following information about the flow the request was received on:
            an enumeration indicating the protocol, the local IP address and
            port, the remote IP address and port. The HMAC of S is computed
            using the key K and the HMAC-SHA1-80 algorithm, as defined in
            <a class='info' href='#RFC2104'>[RFC2104]<span> (</span><span class='info'>Krawczyk, H., Bellare, M., and R. Canetti, &ldquo;HMAC: Keyed-Hashing for Message Authentication,&rdquo; February&nbsp;1997.</span><span>)</span></a>. The concatenation of the HMAC and
            S are base64 encoded, as defined in <a class='info' href='#RFC4648'>[RFC4648]<span> (</span><span class='info'>Josefsson, S., &ldquo;The Base16, Base32, and Base64 Data Encodings,&rdquo; October&nbsp;2006.</span><span>)</span></a>, and used as the flow identifier. When
            using IPv4 addresses, this will result in a 32-octet
            identifier.
</dd>
</dl></blockquote>

<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Forwarding Non-REGISTER Requests</h3>

<p>When an Edge Proxy receives a request, it applies normal routing
        procedures with the following additions. If the Edge Proxy receives a
        request where the edge proxy is the host in the topmost Route header
        field value, and the Route header field value contains a flow token,
        the proxy follows the procedures of this section. Otherwise the edge
        proxy skips the procedures in this section, removes itself from the
        Route header field, and continues processing the request.
</p>
<p>The proxy decodes the flow token and compares the flow in the flow
        token with the source of the request to determine if this is an
        "incoming" or "outgoing" request.
</p>
<p>If the flow in the flow token identified by the topmost Route
        header field value matches the source IP address and port of the
        request, the request is an "outgoing" request, otherwise, it is an
        "incoming" request.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.1"></a><h3>5.3.1.&nbsp;
Processing Incoming Requests</h3>

<p>If the Route header value contains an ob URI parameter, the Route
          header was probably copied from the Path header in a registration.
          If the Route header value contains an ob URI parameter, and the
          request is a new dialog-forming request, the proxy needs to adjust
          the route set to insure that subsequent requests in the dialog can
          be delivered over a valid flow to the UA instance identified by the
          flow token.
</p>
<p></p>
<blockquote class="text">
<p>A simple approach to satisfy this requirement is for the
              proxy to add a Record-Route header field value that contains the
              flow-token, by copying the URI in the Route header minus the
              'ob' parameter.
</p>
</blockquote>

<p>Next, whether the Route header field contained an ob URI
          parameter or not, the proxy removes the Route header field value and
          forwards the request over the 'logical flow' identified by the flow
          token, that is known to deliver data to the specific target UA
          instance. If the flow token has been tampered with, the proxy SHOULD
          send a 403 (Forbidden) response. If the flow no longer exists the
          proxy SHOULD send a 430 (Flow Failed) response to the request.
</p>
<p>Proxies which used the example algorithm described in <a class='info' href='#flowtokens'>Section&nbsp;5.2<span> (</span><span class='info'>Generating Flow Tokens</span><span>)</span></a> to form a flow token follow the
          procedures below to determine the correct flow. To decode the flow
          token, take the flow identifier in the user portion of the URI and
          base64 decode it, then verify the HMAC is correct by recomputing the
          HMAC and checking that it matches. If the HMAC is not correct, the
          request has been tampered with.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.2"></a><h3>5.3.2.&nbsp;
Processing Outgoing Requests</h3>

<p>For mid-dialog requests to work with outbound UAs, the requests
          need to be forwarded over some valid flow to the appropriate UA
          instance. If the Edge Proxy receives an outgoing dialog-forming
          request, the Edge Proxy can use the presence of the ob URI parameter
          in the UAC's Contact URI (or topmost Route header field) to
          determine if the Edge Proxy needs to assist in mid-dialog request
          routing.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Implementation note:</dt>
<dd>Specific procedures at the
              edge proxy to ensure that mid-dialog requests are routed over an
              existing flow are not part of this specification. However, an
              approach such as having the Edge Proxy add a Record-Route header
              with a flow token is one way to ensure that mid-dialog requests
              are routed over the correct flow.
</dd>
</dl></blockquote>

<a name="edgekeep"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Edge Proxy Keep alive Handling</h3>

<p>All edge proxies compliant with this specification MUST implement
        support for STUN NAT Keep alives on its SIP UDP ports as described in
        <a class='info' href='#stunkeep'>Section&nbsp;8<span> (</span><span class='info'>STUN Keep alive Processing</span><span>)</span></a>.
</p>
<p>When a server receives a double CRLF sequence between SIP messages
        on a connection oriented transport such as TCP or SCTP, it MUST
        immediately respond with a single CRLF over the same connection.
</p>
<p>The last proxy to forward a successful registration response to a
        UA MAY include a Flow-Timer header field if the response contains the
        outbound option-tag in a Require header field value in the response.
        The reason a proxy would send a Flow-Timer is if it wishes to detect
        flow failures proactively and take appropriate action (e.g., log
        alarms, provide alternative treatment if incoming requests for the UA
        are received, etc.). The server MUST wait for an amount of time larger
        than the Flow-Timer in order to have a grace period to account for
        transport delay.
</p>
<a name="registrar"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Registrar Procedures</h3>

<p>This specification updates the definition of a binding in <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> Section 10 and <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>
      Section 5.3.
</p>
<p>Registrars which implement this specification MUST support the Path
      header mechanism <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>.
</p>
<p>When receiving a REGISTER request, the registrar MUST check from its
      Via header field if the registrar is the first hop or not. If the
      registrar is not the first hop, it MUST examine the Path header of the
      request. If the Path header field is missing or it exists but the first
      URI does not have an ob URI parameter, then outbound processing MUST NOT
      be applied to the registration. In this case, the following processing
      applies: if the REGISTER request contains the reg-id and the outbound
      option tag in a Supported header field, then the registrar MUST respond
      to the REGISTER request with a 439 (First Hop Lacks Outbound Support)
      response; otherwise, the registrar MUST ignore the reg-id parameter of
      the Contact header. See <a class='info' href='#bad-first-hop'>Section&nbsp;11.6<span> (</span><span class='info'>439 (First Hop Lacks Outbound Support) Response Code</span><span>)</span></a> for more
      information on the 439 response code.
</p>
<p>A Contact header field value with an instance-id media feature tag
      but no reg-id header field parameter is valid (this combination will
      result in the creation of a GRUU, as described in <a class='info' href='#I-D.ietf-sip-gruu'>GRUU<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP),&rdquo; October&nbsp;2007.</span><span>)</span></a> [I&#8209;D.ietf&#8209;sip&#8209;gruu] specification), but one with a
      reg-id but no instance-id is not. If the registrar processes a Contact
      header field value with a reg-id but no instance-id, it simply ignores
      the reg-id parameter.
</p>
<p>A registration containing a reg-id header field parameter and a
      non-zero expiration is used to register a single UA instance over a
      single flow, and can also de-register any Contact header fields with
      zero expiration. Therefore if the Contact header field contains more
      than one header field value with a non-zero expiration and any of these
      header field values contain a reg-id Contact header field parameter, the
      entire registration SHOULD be rejected with a 400 (Bad Request)
      response. The justification for recommending rejection versus making it
      mandatory is that the receiver is allowed by <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> to squelch (not respond to) excessively
      malformed or malicious messages.
</p>
<p>If the Contact header did not contain a reg-id Contact header field
      parameter or if that parameter was ignored (as described above) the
      registrar MUST NOT include the outbound option-tag in the Require header
      field of its response.
</p>
<p>The registrar MUST be prepared to receive, simultaneously for the
      same AOR, some registrations that use instance-id and reg-id and some
      registrations that do not. The Registrar MAY be configured with local
      policy to reject any registrations that do not include the instance-id
      and reg-id, or with Path header field values that do not contain the ob
      URI parameter. If the Contact header field does not contain a
      '+sip.instance' media feature parameter, the registrar processes the
      request using the Contact binding rules in <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<p>When a '+sip.instance' media feature parameter and a reg-id Contact
      header field parameter are present in a Contact header field of a
      REGISTER request (after the Contact header validation as described
      above), the corresponding binding is between an AOR and the combination
      of the instance-id (from the +sip.instance media feature parameter) and
      the value of reg-id Contact header field parameter parameter. The
      registrar MUST store in the binding the Contact URI, all the Contact
      header field parameters, and any Path header field values. (Even though
      the Contact URI is not used for binding comparisons, it is still needed
      by the authoritative proxy to form the target set.) Provided that the
      UAC had included an oubound option-tag (defined in <a class='info' href='#iana-outbound'>Section&nbsp;11.4<span> (</span><span class='info'>SIP Option Tag</span><span>)</span></a>) in a Supported header field value in the
      REGISTER request, the Registrar MUST include the outbound option-tag in
      a Require header field value in its response to that REGISTER
      request.
</p>
<p>If the UAC has a direct flow with the registrar, the registrar MUST
      store enough information to uniquely identify the network flow over
      which the request arrived. For common operating systems with TCP, this
      would typically just be the handle to the file descriptor where the
      handle would become invalid if the TCP session was closed. For common
      operating systems with UDP this would typically be the file descriptor
      for the local socket that received the request, the local interface, and
      the IP address and port number of the remote side that sent the request.
      The registrar MAY store this information by adding itself to the Path
      header field with an appropriate flow token.
</p>
<p>If the registrar receives a re-registration for a specific
      combination of AOR, instance-id and reg-id values, the registrar MUST
      update any information that uniquely identifies the network flow over
      which the request arrived if that information has changed, and SHOULD
      update the time the binding was last updated.
</p>
<p>To be compliant with this specification, registrars which can receive
      SIP requests directly from a UAC without intervening edge proxies MUST
      implement the same keep alive mechanisms as Edge Proxies (<a class='info' href='#edgekeep'>Section&nbsp;5.4<span> (</span><span class='info'>Edge Proxy Keep alive Handling</span><span>)</span></a>). Registrars with a direct flow with a UA MAY
      include a Flow-Timer header in a 2XX class registration response which
      includes the outbound option-tag in the Require header.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Authoritative Proxy Procedures: Forwarding Requests</h3>

<p>When a proxy uses the location service to look up a registration
      binding and then proxies a request to a particular contact, it selects a
      contact to use normally, with a few additional rules:
</p>
<p></p>
<ul class="text">
<li>The proxy MUST NOT populate the target set with more than one
          contact with the same AOR and instance-id at a time.
</li>
<li>If a request for a particular AOR and instance-id fails with a
          430 (Flow Failed) response, the proxy SHOULD replace the failed
          branch with another target (if one is available) with the same AOR
          and instance-id, but a different reg-id.
</li>
<li>If the proxy receives a final response from a branch other than a
          408 (Request Timeout) or a 430 (Flow Failed) response, the proxy
          MUST NOT forward the same request to another target representing the
          same AOR and instance-id. The targeted instance has already provided
          its response.
</li>
</ul>

<p>The proxy uses the next-hop target of the message and the value of
      any stored Path header field vector in the registration binding to
      decide how to forward and populate the Route header in the request. If
      the proxy is colocated with the registrar and stored information about
      the flow to the UA that created the binding, then the proxy MUST send
      the request over the same 'logical flow' saved with the binding, since
      that flow is known to deliver data to the specific target UA instance's
      network flow that was saved with the binding.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Implementation Note:</dt>
<dd>Typically this means that for
          TCP, the request is sent on the same TCP socket that received the
          REGISTER request. For UDP, the request is sent from the same local
          IP address and port over which the registration was received, to the
          same IP address and port from which the REGISTER was received.
</dd>
</dl></blockquote>

<p>If a proxy or registrar receives information from the network that
      indicates that no future messages will be delivered on a specific flow,
      then the proxy MUST invalidate all the bindings in the target set that
      use that flow (regardless of AOR). Examples of this are a TCP socket
      closing or receiving a destination unreachable ICMP error on a UDP flow.
      Similarly, if a proxy closes a file descriptor, it MUST invalidate all
      the bindings in the target set with flows that use that file
      descriptor.
</p>
<a name="stunkeep"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
STUN Keep alive Processing</h3>

<p>This section describes changes to the SIP transport layer that allow
      SIP and <a class='info' href='#RFC5389'>STUN<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> [RFC5389] Binding Requests to be mixed
      over the same flow. This constitutes a new STUN usage. The STUN messages
      are used to verify that connectivity is still available over a UDP flow,
      and to provide periodic keep alives. These STUN keep alives are always
      sent to the next SIP hop. STUN messages are not delivered
      end-to-end.
</p>
<p>The only STUN messages required by this usage are Binding Requests,
      Binding Responses, and Binding Error Responses. The UAC sends Binding
      Requests over the same UDP flow that is used for sending SIP messages.
      These Binding Requests do not require any STUN attributes. The
      corresponding Binding Responses do not require any STUN attributes
      except the XOR-MAPPED-ADDRESS. The UAS, proxy, or registrar responds to
      a valid Binding Request with a Binding Response which MUST include the
      XOR-MAPPED-ADDRESS attribute.
</p>
<p>If a server compliant to this section receives SIP requests on a
      given interface and UDP port, it MUST also provide a limited version of
      a STUN server on the same interface and UDP port.
</p>
<p></p>
<blockquote class="text">
<p>It is easy to distinguish STUN and SIP packets sent over UDP,
          because the first octet of a STUN Binding method has a value of 0 or
          1 while the first octet of a SIP message is never a 0 or 1.
</p>
</blockquote>

<p>Because sending and receiving binary STUN data on the same ports used
      for SIP is a significant and non-backwards compatible change to RFC
      3261, this section requires a number of checks before sending STUN
      messages to a SIP node. If a SIP node sends STUN requests (for example
      due to incorrect configuration) despite these warnings, the node could
      be blacklisted for UDP traffic.
</p>
<p>A SIP node MUST NOT send STUN requests over a flow unless it has an
      explicit indication that the target next hop SIP server claims to
      support this specification. UACs MUST NOT use an ambiguous configuration
      option such as "Work through NATs?" or "Do Keep alives?" to imply next
      hop STUN support. A UAC MAY use the presence of an ob URI parameter in
      the Path header in a registration response as an indication that its
      first edge proxy supports the keep alives defined in this document.
</p>
<p></p>
<blockquote class="text">
<p>Typically, a SIP node first sends a SIP request and waits to
          receive a 2XX class response over a flow to a new target
          destination, before sending any STUN messages. When scheduled for
          the next NAT refresh, the SIP node sends a STUN request to the
          target.
</p>
</blockquote>

<p>Once a flow is established, failure of a STUN request (including its
      retransmissions) is considered a failure of the underlying flow. For SIP
      over UDP flows, if the XOR-MAPPED-ADDRESS returned over the flow
      changes, this indicates that the underlying connectivity has changed,
      and is considered a flow failure.
</p>
<p>The SIP keep alive STUN usage requires no backwards compatibility
      with <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Use with Sigcomp</h3>

<p>When STUN is used together with <a class='info' href='#RFC3320'>SigComp<span> (</span><span class='info'>Price, R., Bormann, C., Christoffersson, J., Hannu, H., Liu, Z., and J. Rosenberg, &ldquo;Signaling Compression (SigComp),&rdquo; January&nbsp;2003.</span><span>)</span></a> [RFC3320] compressed SIP messages over the same
        flow, the STUN messages are simply sent uncompressed, "outside" of
        SigComp. This is supported by multiplexing STUN messages with SigComp
        messages by checking the two topmost bits of the message. These bits
        are always one for SigComp, or zero for STUN.
</p>
<p></p>
<blockquote class="text">
<p>All SigComp messages contain a prefix (the five
            most-significant bits of the first byte are set to one) that does
            not occur in <a class='info' href='#RFC3629'>UTF-8<span> (</span><span class='info'>Yergeau, F., &ldquo;UTF-8, a transformation format of ISO 10646,&rdquo; November&nbsp;2003.</span><span>)</span></a> [RFC3629] encoded text
            messages, so for applications which use this encoding (or ASCII
            encoding) it is possible to multiplex uncompressed application
            messages and SigComp messages on the same UDP port.
</p>
<p>The most significant two bits of every STUN Binding method are
            both zeroes. This, combined with the magic cookie, aids in
            differentiating STUN packets from other protocols when STUN is
            multiplexed with other protocols on the same port.
</p>
</blockquote>

<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Example Message Flow</h3>

<p>Below is an example message flow illustrating most of the concepts
      discussed in this specification. In many cases, Via, Content-Length and
      Max-Forwards headers are omitted for brevity and readability.
</p>
<p>In these examples, "EP1" and "EP2" are outbound proxies, and "Proxy"
      is the authoritativeProxy.
</p>
<p>The section is subdivided into independent calls flows: however, they
      are structured in sequential order of an hypothetical sequence of call
      flows.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Subscription to configuration package</h3>

<p>If the outbound proxy set is already configured on Bob's UA, then
        this subsection can be skipped. Otherwise, if the outbound proxy set
        is learned through the configuration package, Bob's UA sends a
        SUBSCRIBE request for the UA profile configuration package <a class='info' href='#I-D.ietf-sipping-config-framework'>[I&#8209;D.ietf&#8209;sipping&#8209;config&#8209;framework]<span> (</span><span class='info'>Channabasappa, S., &ldquo;A Framework for Session Initiation Protocol User Agent Profile Delivery,&rdquo; February&nbsp;2010.</span><span>)</span></a>. This request is a
        poll (Expires is zero). After receiving the NOTIFY request, Bob's UA
        fetches the external configuration using HTTPS (not shown) and obtains
        a configuration file which contains the outbound-proxy-set
        "sip:ep1.example.com;lr" and "sip:ep2.example.com;lr.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  [----example.com domain-------------------------]
  Bob         EP1   EP2     Proxy             Config
   |           |     |        |                  |
 1)|SUBSCRIBE-&gt;|     |        |                  |
 2)|           |---SUBSCRIBE Event: ua-profile -&gt;|
 3)|           |&lt;--200 OK -----------------------|
 4)|&lt;--200 OK--|     |        |                  |
 5)|           |&lt;--NOTIFY------------------------|
 6)|&lt;--NOTIFY--|     |        |                  |
 7)|---200 OK-&gt;|     |        |                  |
 8)|           |---200 OK ----------------------&gt;|
   |           |     |        |                  |
</pre></div>
<p>In this example, the DNS server happens to be configured so that
        sip:example.com resolves to EP1 and EP2.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Example Message #1:

SUBSCRIBE sip:00000000-0000-1000-8000-AABBCCDDEEFF@example.com
  SIP/2.0
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bKnlsdkdj2
Max-Forwards: 70
From: &lt;anonymous@example.com&gt;;tag=23324
To: &lt;sip:00000000-0000-1000-8000-AABBCCDDEEFF@example.com&gt;
Call-ID: nSz1TWN54x7My0GvpEBj
CSeq: 1 SUBSCRIBE
Event: ua-profile ;profile-type=device
 ;vendor="example.com";model="uPhone";version="1.1"
Expires: 0
Supported: path, outbound
Accept: message/external-body, application/x-uPhone-config
Contact: &lt;sip:192.0.2.2;transport=tcp;ob&gt;
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Content-Length: 0</pre></div>
<p>In message #2, EP1 adds the following Record-Route header:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Record-Route:
 &lt;sip:GopIKSsn0oGLPXRdV9BAXpT3coNuiGKV@ep1.example.com;lr&gt;</pre></div>
<p>In message #5, the configuration server sends a NOTIFY with an
        external URL for Bob to fetch his configuration. The NOTIFY has a
        Subscription-State header that ends the subscription.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #5

NOTIFY sip:192.0.2.2;transport=tcp;ob SIP/2.0
Via: SIP/2.0/TCP 192.0.2.5;branch=z9hG4bKn81dd2
Max-Forwards: 70
To: &lt;anonymous@example.com&gt;;tag=23324
From: &lt;sip:00000000-0000-1000-8000-AABBCCDDEEFF@example.com&gt;;tag=0983
Call-ID: nSz1TWN54x7My0GvpEBj
CSeq: 1 NOTIFY
Route: &lt;sip:GopIKSsn0oGLPXRdV9BAXpT3coNuiGKV@ep1.example.com;lr&gt;
Subscription-State: terminated;reason=timeout
Event: ua-profile
Content-Type: message/external-body; access-type="URL"
 ;expiration="Thu, 01 Jan 2009 09:00:00 UTC"
 ;URL="http://example.com/uPhone.cfg"
 ;size=9999;hash=10AB568E91245681AC1B
Content-Length: 0
</pre></div>
<p>EP1 receives this NOTIFY request, strips off the Route header,
        extracts the flow-token, calculates the correct flow and forwards the
        request (Message #6) over that flow to Bob.
</p>
<p>Bob's UA fetches the configuration file and learns the outbound
        proxy set.
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2"></a><h3>9.2.&nbsp;
Registration</h3>

<p>Now that Bob's UA is configured with the outbound-proxy-set whether
        through configuration or using the configuration framework procedures
        of the previous section, Bob's UA sends REGISTER requests through each
        edge proxy in the set. Once the registrations succeed, Bob's UA begins
        sending CRLF keep alives about every 2 minutes.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Bob         EP1   EP2     Proxy     Alice
   |           |     |        |         |
 9)|-REGISTER-&gt;|     |        |         |
10)|           |---REGISTER--&gt;|         |
11)|           |&lt;----200 OK---|         |
12)|&lt;-200 OK---|     |        |         |
13)|----REGISTER----&gt;|        |         |
14)|           |     |--REG--&gt;|         |
15)|           |     |&lt;-200---|         |
16)|&lt;----200 OK------|        |         |
   |           |     |        |         |
   |  about 120 seconds later...        |
   |           |     |        |         |
17)|--2CRLF---&gt;|     |        |         |
18)|&lt;--CRLF----|     |        |         |
19)|------2CRLF-----&gt;|        |         |
20)|&lt;------CRLF------|        |         |
   |           |     |        |         |
</pre></div>
<p>In message #9, Bob's UA sends its first registration through the
        first edge proxy in the outbound-proxy-set by including a loose route.
        The UA includes an instance-id and reg-id in its Contact header field
        value. Note the option-tags in the Supported header.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #9

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bKnashds7
Max-Forwards: 70
From: Bob &lt;sip:bob@example.com&gt;;tag=7F94778B653B
To: Bob &lt;sip:bob@example.com&gt;
Call-ID: 16CB75F21C70
CSeq: 1 REGISTER
Supported: path, outbound
Route: &lt;sip:ep1.example.com;lr&gt;
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=1
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Content-Length: 0
</pre></div>
<p>Message #10 is similar. EP1 removes the Route header field value,
        decrements Max-Forwards, and adds its Via header field value. Since
        EP1 is the first edge proxy, it adds a Path header with a flow token
        and includes the 'ob' parameter.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Path: &lt;sip:VskztcQ/S8p4WPbOnHbuyh5iJvJIW3ib@ep1.example.com;lr;ob&gt;
</pre></div>
<p>Since the response to the REGISTER (message #11) contains the
        outbound option-tag in the Require header field, Bob's UA will know
        that the registrar used outbound binding rules. The response also
        contains the currently active Contacts, the Path for the current
        registration.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #11

SIP/2.0 200 OK
Via: SIP/2.0/TCP 192.0.2.15;branch=z9hG4bKnuiqisi
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bKnashds7
From: Bob &lt;sip:bob@example.com&gt;;tag=7F94778B653B
To: Bob &lt;sip:bob@example.com&gt;;tag=6AF99445E44A
Call-ID: 16CB75F21C70
CSeq: 1 REGISTER
Supported: path, outbound
Require: outbound
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=1;expires=3600
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Path: &lt;sip:VskztcQ/S8p4WPbOnHbuyh5iJvJIW3ib@ep1.example.com;lr;ob&gt;
Content-Length: 0
</pre></div>
<p>The second registration through EP2 (message #13) is similar other
        than the Call-ID has changed, the reg-id is 2, and the Route header
        goes through EP2.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #13

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bKnqr9bym
Max-Forwards: 70
From: Bob &lt;sip:bob@example.com&gt;;tag=755285EABDE2
To: Bob &lt;sip:bob@example.com&gt;
Call-ID: E05133BD26DD
CSeq: 1 REGISTER
Supported: path, outbound
Route: &lt;sip:ep2.example.com;lr&gt;
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=2
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Content-Length: 0
</pre></div>
<p>Likewise in message #14, EP2 adds a Path header with flow token and
        'ob' parameter.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Path: &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr;ob&gt;
</pre></div>
<p>Message #16 tells Bob's UA that outbound registration was
        successful, and shows both Contacts. Note that only the Path
        corresponding to the current registration is returned.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #16

SIP/2.0 200 OK
Via: SIP/2.0/TCP 192.0.2.2;branch=z9hG4bKnqr9bym
From: Bob &lt;sip:bob@example.com&gt;;tag=755285EABDE2
To: Bob &lt;sip:bob@example.com&gt;;tag=49A9AD0B3F6A
Call-ID: E05133BD26DD
Supported: path, outbound
Require: outbound
CSeq: 1 REGISTER
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=1;expires=3600
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=2;expires=3600
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
Path: &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr;ob&gt;
Content-Length: 0
</pre></div>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.3"></a><h3>9.3.&nbsp;
Incoming call and proxy crash</h3>

<p>In this example, after registration, EP1 crashes and reboots.
        Before Bob's UA notices that its flow to EP1 is no longer responding,
        Alice calls Bob. Bob's authoritative proxy first tries the flow to
        EP1, but EP1 no longer has a flow to Bob so it responds with a 430
        Flow Failed response. The proxy removes the stale registration and
        tries the next binding for the same instance.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Bob         EP1   EP2     Proxy     Alice
   |           |     |        |         |
   |    CRASH  X     |        |         |
   |        Reboot   |        |         |
   |           |     |        |         |
21)|           |     |        |&lt;-INVITE-|
22)|           |&lt;---INVITE----|         |
23)|           |----430------&gt;|         |
24)|           |     |&lt;-INVITE|         |
25)|&lt;---INVITE-------|        |         |
26)|----200 OK------&gt;|        |         |
27)|           |     |200 OK-&gt;|         |
28)|           |     |        |-200 OK-&gt;|
29)|           |     |&lt;----------ACK----|
30)|&lt;---ACK----------|        |         |
   |           |     |        |         |
31)|           |     |&lt;----------BYE----|
32)|&lt;---BYE----------|        |         |
33)|----200 OK------&gt;|        |         |
34)|           |     |--------200 OK---&gt;|
   |           |     |        |         |
</pre></div>
<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #21

INVITE sip:bob@example.com SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
</pre></div>
<p>Bob's proxy rewrites the Request-URI to the Contact URI used in
        Bob's registration, and places the path for one of the registrations
        towards Bob's UA instance into a Route header field. This Route goes
        through EP1.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #22

INVITE sip:bob@192.0.2.2;transport=tcp SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
Route: &lt;sip:VskztcQ/S8p4WPbOnHbuyh5iJvJIW3ib@ep1.example.com;lr;ob&gt;
</pre></div>
<p>Since EP1 just rebooted, it does not have the flow described in the
        flow token. It returns a 430 Flow Failed response.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #23

SIP/2.0 430 Flow Failed
To: Bob &lt;sip:bob@example.com&gt;
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
</pre></div>
<p>The proxy deletes the binding for this path and tries to forward
        the INVITE again, this time with the path through EP2.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #24

INVITE sip:bob@192.0.2.2;transport=tcp SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
Route: &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr;ob&gt;
</pre></div>
<p>In message #25, EP2 needs to add a Record-Route header field value,
        so that any subsequent in-dialog messages from Alice's UA arrive at
        Bob's UA. EP2 can determine it needs to Record-Route since the request
        is a dialog-forming request and the Route header contained a flow
        token and an 'ob' parameter. This Record-Route information is passed
        back to Alice's UA in the responses (messages #26, 27, and 28)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #25

INVITE sip:bob@192.0.2.2;transport=tcp SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
Record-Route:
  &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr&gt;

Message #26

SIP/2.0 200 OK
To: Bob &lt;sip:bob@example.com&gt;;tag=skduk2
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 INVITE
Record-Route:
  &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr&gt;
</pre></div>
<p>At this point, both UAs have the correct route-set for the dialog.
        Any subsequent requests in this dialog will route correctly. For
        example, the ACK request in message #29 is sent form Alice's UA
        directly to EP2. The BYE request in message #31 uses the same
        route-set.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #29

ACK sip:bob@192.0.2.2;transport=tcp SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;;tag=skduk2
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 1 ACK
Route: &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr&gt;

Message #31

BYE sip:bob@192.0.2.2;transport=tcp SIP/2.0
To: Bob &lt;sip:bob@example.com&gt;;tag=skduk2
From: Alice &lt;sip:alice@a.example&gt;;tag=02935
Call-ID: klmvCxVWGp6MxJp2T2mb
CSeq: 2 BYE
Route: &lt;sip:wazHDLdIMtUg6r0I/oRZ15zx3zHE1w1Z@ep2.example.com;lr&gt;
</pre></div>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.4"></a><h3>9.4.&nbsp;
Re-registration</h3>

<p>Somewhat later, Bob's UA sends keep alives to both its edge
        proxies, but it discovers that the flow with EP1 failed. Bob's UA
        re-registers through EP1 using the same reg-id and Call-ID it
        previously used.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Bob         EP1   EP2     Proxy     Alice
   |           |     |        |         |
35)|------2CRLF-----&gt;|        |         |
36)|&lt;------CRLF------|        |         |
37)|--2CRLF-&gt;X |     |        |         |
   |           |     |        |         |
38)|-REGISTER-&gt;|     |        |         |
39)|           |---REGISTER--&gt;|         |
40)|           |&lt;----200 OK---|         |
41)|&lt;-200 OK---|     |        |         |
   |           |     |        |         |

Message #38

REGISTER sip:example.com SIP/2.0
From: Bob &lt;sip:bob@example.com&gt;;tag=7F94778B653B
To: Bob &lt;sip:bob@example.com&gt;
Call-ID: 16CB75F21C70
CSeq: 2 REGISTER
Supported: path, outbound
Route: &lt;sip:ep1.example.com;lr&gt;
Contact: &lt;sip:bob@192.0.2.2;transport=tcp&gt;;reg-id=1
 ;+sip.instance="&lt;urn:uuid:00000000-0000-1000-8000-AABBCCDDEEFF&gt;"
</pre></div>
<p>In message #39, EP1 inserts a Path header with a new flow
        token:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Path: &lt;sip:3yJEbr1GYZK9cPYk5Snocez6DzO7w+AX@ep1.example.com;lr;ob&gt;
</pre></div>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.5"></a><h3>9.5.&nbsp;
Outgoing call</h3>

<p>Finally, Bob makes an outgoing call to Alice. Bob's UA includes an
        'ob' parameter in its Contact URI in message #42. EP1 adds a
        Record-Route with a flow-token in message #43. The route-set is
        returned to Bob in the response (messages #45, 46, and 47) and either
        Bob or Alice can send in-dialog requests.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Bob         EP1   EP2     Proxy     Alice
   |           |     |        |         |
42)|--INVITE--&gt;|     |        |         |
43)|           |---INVITE----&gt;|         |
44)|           |     |        |-INVITE-&gt;|
45)|           |     |        |&lt;--200---|
46)|           |&lt;----200 OK---|         |
47)|&lt;-200 OK---|     |        |         |
48)|--ACK-----&gt;|     |        |         |
49)|           |-----ACK---------------&gt;|
   |           |     |        |         |
50)|-- BYE----&gt;|     |        |         |
51)|           |-----------BYE---------&gt;|
52)|           |&lt;----------200 OK-------|
53)|&lt;--200 OK--|     |        |         |
   |           |     |        |         |

Message #42

INVITE sip:alice@a.example SIP/2.0
From: Bob &lt;sip:bob@example.com&gt;;tag=ldw22z
To: Alice &lt;sip:alice@a.example&gt;
Call-ID: 95KGsk2V/Eis9LcpBYy3
CSeq: 1 INVITE
Route: &lt;sip:ep1.example.com;lr&gt;
Contact: &lt;sip:bob@192.0.2.2;transport=tcp;ob&gt;
</pre></div>
<p>In message #43, EP1 adds the following Record-Route header.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Record-Route:
  &lt;sip:3yJEbr1GYZK9cPYk5Snocez6DzO7w+AX@ep1.example.com;lr&gt;
</pre></div>
<p>When EP1 receives the BYE (message #50) from Bob's UA, it can tell
        that the request is an "outgoing" request (since the source of the
        request matches the flow in the flow token) and simply deletes its
        Route header field value and forwards the request on to Alice's
        UA.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Message #50

BYE sip:alice@a.example SIP/2.0
From: Bob &lt;sip:bob@example.com&gt;;tag=ldw22z
To: Alice &lt;sip:alice@a.example&gt;;tag=plqus8
Call-ID: 95KGsk2V/Eis9LcpBYy3
CSeq: 2 BYE
Route: &lt;sip:3yJEbr1GYZK9cPYk5Snocez6DzO7w+AX@ep1.example.com;lr&gt;
Contact: &lt;sip:bob@192.0.2.2;transport=tcp;ob&gt;
</pre></div>
<a name="grammar"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Grammar</h3>

<p>This specification defines a new header field "Flow-Timer", new
      Contact header field parameters, reg-id and +sip.instance. The grammar
      includes the definitions from <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and
      includes the definition of uric from <a class='info' href='#RFC3986'>[RFC3986]<span> (</span><span class='info'>Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;Uniform Resource Identifier (URI): Generic Syntax,&rdquo; January&nbsp;2005.</span><span>)</span></a>.
      Flow-Timer is an extension-header from the message-header in the <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> ABNF.
</p>
<p>The ABNF<a class='info' href='#RFC5234'>[RFC5234]<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; January&nbsp;2008.</span><span>)</span></a> is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 <dfn>Flow-Timer</dfn>     = "<span class='str'>Flow-Timer</span>" <cite class='id'>HCOLON</cite> <span class='rep'>1*</span><cite class='key'>DIGIT</cite>

 <dfn>contact-params</dfn> =/ <cite class='id'>c-p-reg</cite> / <cite class='id'>c-p-instance</cite>

 <dfn>c-p-reg</dfn>        = "<span class='str'>reg-id</span>" <cite class='id'>EQUAL</cite> <span class='rep'>1*</span><cite class='key'>DIGIT</cite> <em>; 1 to (2**31 - 1)</em>

 <dfn>c-p-instance</dfn>   =  "<span class='str'>+sip.instance</span>" <cite class='id'>EQUAL</cite>
                   <cite class='key'>DQUOTE</cite> "<span class='str'>&lt;</span>" <cite class='id'>instance-val</cite> "<span class='str'>&gt;</span>" <cite class='key'>DQUOTE</cite>

 <dfn>instance-val</dfn>   = <span class='rep'>*</span><cite class='id'>uric</cite> <em>; defined in RFC 3986 </em>
</pre></div>
<p>The value of the reg-id MUST NOT be 0 and MUST be less than
      2**31.
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>
</p>
<a name="iana-flow-timer"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.1"></a><h3>11.1.&nbsp;
Flow-Timer Header Field</h3>

<p>This specification defines a new SIP header field "Flow-Timer"
        whose syntax is defined in <a class='info' href='#grammar'>Section&nbsp;10<span> (</span><span class='info'>Grammar</span><span>)</span></a>.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Header Name        compact    Reference
  -----------------  -------    ---------
  Flow-Timer                    [RFCXXXX]

 [NOTE TO RFC Editor: Please replace XXXX with
                      the RFC number of this specification.]
</pre></div>
<a name="iana-reg-id"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.2"></a><h3>11.2.&nbsp;
'reg-id' Contact Header Field Parameter</h3>

<p>This specification defines a new Contact header field parameter
        called reg-id in the "Header Field Parameters and Parameter Values"
        sub-registry as per the registry created by <a class='info' href='#RFC3968'>[RFC3968]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>. The syntax is defined in <a class='info' href='#grammar'>Section&nbsp;10<span> (</span><span class='info'>Grammar</span><span>)</span></a>. The required information is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                               Predefined
Header Field            Parameter Name         Values      Reference
----------------------  ---------------------  ----------  ---------
Contact                 reg-id                 No          [RFCXXXX]

 [NOTE TO RFC Editor: Please replace XXXX with
                      the RFC number of this specification.]
</pre></div>
<a name="iana-keepalive"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.3"></a><h3>11.3.&nbsp;
SIP/SIPS URI Parameters</h3>

<p>This specification augments the "SIP/SIPS URI Parameters"
        sub-registry as per the registry created by <a class='info' href='#RFC3969'>[RFC3969]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>. The required information is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Parameter Name     Predefined Values     Reference
--------------     -----------------     ---------
ob                 No                    [RFCXXXX]

    [NOTE TO RFC Editor: Please replace XXXX with
                         the RFC number of this specification.]
</pre></div>
<a name="iana-outbound"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.4"></a><h3>11.4.&nbsp;
SIP Option Tag</h3>

<p>This specification registers a new SIP option tag, as per the
        guidelines in Section 27.1 of <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Name:</dt>
<dd>outbound
</dd>
<dt>Description:</dt>
<dd>This option-tag is used to identify UAs
            and Registrars which support extensions for Client Initiated
            Connections. A UA places this option in a Supported header to
            communicate its support for this extension. A Registrar places
            this option-tag in a Require header to indicate to the registering
            User Agent that the Registrar used registrations using the binding
            rules defined in this extension.
</dd>
</dl></blockquote>

<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.5"></a><h3>11.5.&nbsp;
430 (Flow Failed) Response Code</h3>

<p>This document registers a new SIP response code (430 Flow Failed),
        as per the guidelines in Section 27.4 of <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. This response code is used by an Edge Proxy
        to indicate to the Authoritative Proxy that a specific flow to a UA
        instance has failed. Other flows to the same instance could still
        succeed. The Authoritative Proxy SHOULD attempt to forward to another
        target (flow) with the same instance-id and AOR. Endpoints should
        never receive a 430 response. If an endpoint receives a 430 response
        it should treat it as a 400 (Bad Request) per normal 8.1.3.2/<a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> procedures. This response code is defined by
        the following information, which has been added to the method and
        response-code sub-registry under
        http://www.iana.org/assignments/sip-parameters.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Response Code                               Reference
  ------------------------------------------  ---------
  Request Failure 4xx
    430 Flow Failed                           [RFCXXXX]

    [NOTE TO RFC Editor: Please replace XXXX with
                         the RFC number of this specification.]
</pre></div>
<a name="bad-first-hop"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.6"></a><h3>11.6.&nbsp;
439 (First Hop Lacks Outbound Support) Response Code</h3>

<p>This document registers a new SIP response code (439 First Hop
        Lacks Outbound Support), as per the guidelines in Section 27.4 of
        <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. This response code is used by a
        registrar to indicate that it supports the 'outbound' feature
        described in this specification, but that the first outbound proxy
        that the user is attempting to register through does not. Note that
        this response code is only appropriate in the case that the
        registering user agent advertises support for outbound processing by
        including the outbound option tag in a Supported header field. Proxies
        MUST NOT send a 439 response to any requests that do not contain a
        reg-id parameter and an outbound option tag in a Supported header
        field. This response code is defined by the following information,
        which has been added to the method and response-code sub-registry
        under http://www.iana.org/assignments/sip-parameters.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Response Code                               Reference
  ------------------------------------------  ---------
  Request Failure 4xx
    439 First Hop Lacks Outbound Support      [RFCXXXX]

    [NOTE TO RFC Editor: Please replace XXXX with
                         the RFC number of this specification.]
</pre></div>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.7"></a><h3>11.7.&nbsp;
Media Feature Tag</h3>

<p>This section registers a new media feature tag, per the procedures
        defined in <a class='info' href='#RFC2506'>[RFC2506]<span> (</span><span class='info'>Holtman, K., Mutz, A., and T. Hardie, &ldquo;Media Feature Tag Registration Procedure,&rdquo; March&nbsp;1999.</span><span>)</span></a>. The tag is placed into the
        sip tree, which is defined in <a class='info' href='#RFC3840'>[RFC3840]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Indicating User Agent Capabilities in the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>.
</p>
<p>Media feature tag name: sip.instance
</p>
<p>ASN.1 Identifier: New assignment by IANA.
</p>
<p>Summary of the media feature indicated by this tag: This feature
        tag contains a string containing a URN that indicates a unique
        identifier associated with the UA instance registering the
        Contact.
</p>
<p>Values appropriate for use with this feature tag: String.
</p>
<p>The feature tag is intended primarily for use in the following
        applications, protocols, services, or negotiation mechanisms: This
        feature tag is most useful in a communications application, for
        describing the capabilities of a device, such as a phone or PDA.
</p>
<p>Examples of typical use: Routing a call to a specific device.
</p>
<p>Related standards or documents: RFC XXXX
</p>
<p>[Note to IANA: Please replace XXXX with the RFC number of this
        specification.]
</p>
<p>Security Considerations: This media feature tag can be used in ways
        which affect application behaviors. For example, the <a class='info' href='#RFC3841'>SIP caller preferences extension<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a> [RFC3841] allows for
        call routing decisions to be based on the values of these parameters.
        Therefore, if an attacker can modify the values of this tag, they
        might be able to affect the behavior of applications. As a result,
        applications which utilize this media feature tag SHOULD provide a
        means for ensuring its integrity. Similarly, this feature tag should
        only be trusted as valid when it comes from the user or user agent
        described by the tag. As a result, protocols for conveying this
        feature tag SHOULD provide a mechanism for guaranteeing
        authenticity.
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Security Considerations</h3>

<p>One of the key security concerns in this work is making sure that an
      attacker cannot hijack the sessions of a valid user and cause all calls
      destined to that user to be sent to the attacker. Note that the intent
      is not to prevent existing active attacks on SIP UDP and TCP traffic,
      but to insure that no new attacks are added by introducing the outbound
      mechanism.
</p>
<p>The simple case is when there are no edge proxies. In this case, the
      only time an entry can be added to the routing for a given AOR is when
      the registration succeeds. SIP already protects against attackers being
      able to successfully register, and this scheme relies on that security.
      Some implementers have considered the idea of just saving the
      instance-id without relating it to the AOR with which it registered.
      This idea will not work because an attacker's UA can impersonate a valid
      user's instance-id and hijack that user's calls.
</p>
<p>The more complex case involves one or more edge proxies. When a UA
      sends a REGISTER request through an Edge Proxy on to the registrar, the
      Edge Proxy inserts a Path header field value. If the registration is
      successfully authenticated, the registrar stores the value of the Path
      header field. Later when the registrar forwards a request destined for
      the UA, it copies the stored value of the Path header field into the
      Route header field of the request and forwards the request to the Edge
      Proxy.
</p>
<p>The only time an Edge Proxy will route over a particular flow is when
      it has received a Route header that has the flow identifier information
      that it has created. An incoming request would have gotten this
      information from the registrar. The registrar will only save this
      information for a given AOR if the registration for the AOR has been
      successful; and the registration will only be successful if the UA can
      correctly authenticate. Even if an attacker has spoofed some bad
      information in the Path header sent to the registrar, the attacker will
      not be able to get the registrar to accept this information for an AOR
      that does not belong to the attacker. The registrar will not hand out
      this bad information to others, and others will not be misled into
      contacting the attacker.
</p>
<p>The Security Considerations discussed in <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> are also
      relevant to this document. For the security considerations of generating
      flow tokens, please also see <a class='info' href='#flowtokens'>Section&nbsp;5.2<span> (</span><span class='info'>Generating Flow Tokens</span><span>)</span></a>. A
      discussion of preventing the avalanche restart problem is in <a class='info' href='#recovery'>Section&nbsp;4.5<span> (</span><span class='info'>Flow Recovery</span><span>)</span></a>.
</p>
<p>This document does not change the mandatory to implement security
      mechanisms in SIP. User Agents are already required to implement Digest
      authentication while support of TLS is recommended; proxy servers are
      already required to implement Digest and TLS.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Operational Notes on Transports</h3>

<p>This entire section is non-normative.
</p>
<p><a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> requires proxies, registrars, and User
      Agents to implement both TCP and UDP but deployments can chose which
      transport protocols they want to use. Deployments need to be careful in
      choosing what transports to use. Many SIP features and extensions, such
      as large presence notification bodies, result in SIP requests that can
      be too large to be reasonably transported over UDP. <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> states that when a request is too large for
      UDP, the device sending the request attempts to switch over to TCP. It
      is important to note that when using outbound, this will only work if
      the UA has formed both UDP and TCP outbound flows. This specification
      allows the UA to do so but in most cases it will probably make more
      sense for the UA to form a TCP outbound connection only, rather than
      forming both UDP and TCP flows. One of the key reasons that many
      deployments choose not to use TCP has to do with the difficulty of
      building proxies that can maintain a very large number of active TCP
      connections. Many deployments today use SIP in such a way that the
      messages are small enough that they work over UDP but they can not take
      advantage of all the functionality SIP offers. Deployments that use only
      UDP outbound connections are going to fail with sufficiently large SIP
      messages.
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
Requirements</h3>

<p>This specification was developed to meet the following
      requirements:
</p>
<p></p>
<ol class="text">
<li>Must be able to detect that a UA supports these mechanisms.
</li>
<li>Support UAs behind NATs.
</li>
<li>Support TLS to a UA without a stable DNS name or IP address.
</li>
<li>Detect failure of a connection and be able to correct for
          this.
</li>
<li>Support many UAs simultaneously rebooting.
</li>
<li>Support a NAT rebooting or resetting.
</li>
<li>Minimize initial startup load on a proxy.
</li>
<li>Support architectures with edge proxies.
</li>
</ol>

<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
Acknowledgments</h3>

<p>Fran&ccedil;ois Audet acted as document shepherd for this draft,
      tracking hundreds of comments and incorporating many grammatical fixes
      as well as prodding the editors to "get on with it". Jonathan Rosenberg,
      Erkki Koivusalo, and Byron Campen provided many comments and useful
      text. Dave Oran came up with the idea of using the most recent
      registration first in the proxy. Alan Hawrylyshen co-authored the draft
      that formed the initial text of this specification. Additionally, many
      of the concepts here originated at a connection reuse meeting at IETF 60
      that included the authors, Jon Peterson, Jonathan Rosenberg, Alan
      Hawrylyshen, and Paul Kyzivat. The TCP design team consisting of Chris
      Boulton, Scott Lawrence, Rajnish Jain, Vijay K. Gurbani, and Ganesh
      Jayadevan provided input and text. Nils Ohlmeier provided many fixes and
      initial implementation experience. In addition, thanks to the following
      folks for useful comments: Fran&ccedil;ois Audet, Flemming Andreasen,
      Mike Hammer, Dan Wing, Srivatsa Srinivasan, Dale Worely, Juha Heinanen,
      Eric Rescorla, Lyndsay Campbell, Christer Holmberg, Kevin Johns, Jeroen
      van Bemmel, Derek MacDonald, Dean Willis and Robert Sparks.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.16"></a><h3>16.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2141">[RFC2141]</a></td>
<td class="author-text"><a href="mailto:jayhawk@ds.internic.net">Moats, R.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2141">URN Syntax</a>,&rdquo; RFC&nbsp;2141, May&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2141.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2141.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2141.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2506">[RFC2506]</a></td>
<td class="author-text"><a href="mailto:koen@win.tue.nl">Holtman, K.</a>, <a href="mailto:andy_mutz@hp.com">Mutz, A.</a>, and <a href="mailto:hardie@equinix.com">T. Hardie</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2506">Media Feature Tag Registration Procedure</a>,&rdquo; BCP&nbsp;31, RFC&nbsp;2506, March&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2506.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3263">[RFC3263]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3263">Session Initiation Protocol (SIP): Locating SIP Servers</a>,&rdquo; RFC&nbsp;3263, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3327">[RFC3327]</a></td>
<td class="author-text">Willis, D. and B. Hoeneisen, &ldquo;<a href="http://tools.ietf.org/html/rfc3327">Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts</a>,&rdquo; RFC&nbsp;3327, December&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3327.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3581">[RFC3581]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3581">An Extension to the Session Initiation Protocol (SIP) for Symmetric Response Routing</a>,&rdquo; RFC&nbsp;3581, August&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3581.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3629">[RFC3629]</a></td>
<td class="author-text">Yergeau, F., &ldquo;<a href="http://tools.ietf.org/html/rfc3629">UTF-8, a transformation format of ISO 10646</a>,&rdquo; STD&nbsp;63, RFC&nbsp;3629, November&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3629.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3840">[RFC3840]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3840">Indicating User Agent Capabilities in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3840, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3840.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3841">[RFC3841]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3841">Caller Preferences for the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3841, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3841.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3968">[RFC3968]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3968">The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;98, RFC&nbsp;3968, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3968.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3969">[RFC3969]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3969">The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;99, RFC&nbsp;3969, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3969.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3986">[RFC3986]</a></td>
<td class="author-text"><a href="mailto:timbl@w3.org">Berners-Lee, T.</a>, <a href="mailto:fielding@gbiv.com">Fielding, R.</a>, and <a href="mailto:LMM@acm.org">L. Masinter</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a>,&rdquo; STD&nbsp;66, RFC&nbsp;3986, January&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3986.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3986.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3986.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4122">[RFC4122]</a></td>
<td class="author-text"><a href="mailto:paulle@microsoft.com">Leach, P.</a>, <a href="mailto:michael@refactored-networks.com">Mealling, M.</a>, and <a href="mailto:rsalz@datapower.com">R. Salz</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc4122">A Universally Unique IDentifier (UUID) URN Namespace</a>,&rdquo; RFC&nbsp;4122, July&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4122.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4122.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4122.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5234">[RFC5234]</a></td>
<td class="author-text">Crocker, D. and P. Overell, &ldquo;<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; STD&nbsp;68, RFC&nbsp;5234, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5234.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5389">[RFC5389]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>,&rdquo; RFC&nbsp;5389, October&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5389.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.2.&nbsp;Informational References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-gruu">[I-D.ietf-sip-gruu]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP)</a>,&rdquo; draft-ietf-sip-gruu-15 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-config-framework">[I-D.ietf-sipping-config-framework]</a></td>
<td class="author-text">Channabasappa, S., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-config-framework-17.txt">A Framework for Session Initiation Protocol User Agent Profile Delivery</a>,&rdquo; draft-ietf-sipping-config-framework-17 (work in progress), February&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-config-framework-17.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-nat-scenarios">[I-D.ietf-sipping-nat-scenarios]</a></td>
<td class="author-text">Boulton, C., Rosenberg, J., Camarillo, G., and F. Audet, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-nat-scenarios-10.txt">Best Current Practices for NAT Traversal for Client-Server SIP</a>,&rdquo; draft-ietf-sipping-nat-scenarios-10 (work in progress), February&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-nat-scenarios-10.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC0768">[RFC0768]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc768">User Datagram Protocol</a>,&rdquo; STD&nbsp;6, RFC&nbsp;768, August&nbsp;1980 (<a href="http://www.rfc-editor.org/rfc/rfc768.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC0793">[RFC0793]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>,&rdquo; STD&nbsp;7, RFC&nbsp;793, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc793.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2104">[RFC2104]</a></td>
<td class="author-text"><a href="mailto:hugo@watson.ibm.com">Krawczyk, H.</a>, <a href="mailto:mihir@cs.ucsd.edu">Bellare, M.</a>, and <a href="mailto:canetti@watson.ibm.com">R. Canetti</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>,&rdquo; RFC&nbsp;2104, February&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2104.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2782">[RFC2782]</a></td>
<td class="author-text"><a href="mailto:arnt@troll.no">Gulbrandsen, A.</a>, Vixie, P., and <a href="mailto:levone@microsoft.com">L. Esibov</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2782">A DNS RR for specifying the location of services (DNS SRV)</a>,&rdquo; RFC&nbsp;2782, February&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2782.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3320">[RFC3320]</a></td>
<td class="author-text">Price, R., Bormann, C., Christoffersson, J., Hannu, H., Liu, Z., and J. Rosenberg, &ldquo;<a href="http://tools.ietf.org/html/rfc3320">Signaling Compression (SigComp)</a>,&rdquo; RFC&nbsp;3320, January&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3320.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3489">[RFC3489]</a></td>
<td class="author-text">Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;<a href="http://tools.ietf.org/html/rfc3489">STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs)</a>,&rdquo; RFC&nbsp;3489, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3489.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4340">[RFC4340]</a></td>
<td class="author-text">Kohler, E., Handley, M., and S. Floyd, &ldquo;<a href="http://tools.ietf.org/html/rfc4340">Datagram Congestion Control Protocol (DCCP)</a>,&rdquo; RFC&nbsp;4340, March&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4340.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4648">[RFC4648]</a></td>
<td class="author-text">Josefsson, S., &ldquo;<a href="http://tools.ietf.org/html/rfc4648">The Base16, Base32, and Base64 Data Encodings</a>,&rdquo; RFC&nbsp;4648, October&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4648.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4960">[RFC4960]</a></td>
<td class="author-text">Stewart, R., &ldquo;<a href="http://tools.ietf.org/html/rfc4960">Stream Control Transmission Protocol</a>,&rdquo; RFC&nbsp;4960, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4960.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5246">[RFC5246]</a></td>
<td class="author-text">Dierks, T. and E. Rescorla, &ldquo;<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>,&rdquo; RFC&nbsp;5246, August&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5246.txt">TXT</a>).</td></tr>
</table>

<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Default Flow Registration Backoff Times</h3>

<p>The base-time used for the flow re-registration backoff times
      described in <a class='info' href='#recovery'>Section&nbsp;4.5<span> (</span><span class='info'>Flow Recovery</span><span>)</span></a> are configurable. If the
      base-time-all-fail value is set to the default of 30 seconds and the
      base-time-not-failed value is set to the default of 90 seconds, the
      following table shows the resulting amount of time the UA will wait to
      retry registration.
</p><table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left">
<tr><th align="left"># of reg failures</th><th align="left">all flows unusable</th><th align="left">&gt; 1 non-failed flow</th></tr>
<tr>
<td align="left">0</td>
<td align="left">0 s</td>
<td align="left">0 s</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">30-60 s</td>
<td align="left">90-180 s</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">1-2 min</td>
<td align="left">3-6 min</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">2-4 min</td>
<td align="left">6-12 min</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">4-8 min</td>
<td align="left">12-24 min</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">8-16 min</td>
<td align="left">15-30 min</td>
</tr>
<tr>
<td align="left">6 or more</td>
<td align="left">15-30 min</td>
<td align="left">15-30 min</td>
</tr>
</table>
<br clear="all" />

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cullen Jennings (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">170 West Tasman Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Mailstop SJC-21/2</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Jose, CA  95134</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 408 902-3341</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:fluffy@cisco.com">fluffy@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Rohan Mahy (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Unaffiliated</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:rohan@ekabal.com">rohan@ekabal.com</a></td></tr>
</table>
</body></html>
