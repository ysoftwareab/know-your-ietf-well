<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Traversal Using Relays around NAT (TURN) Extensions for TCP Allocations</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Traversal Using Relays around NAT (TURN) Extensions for TCP Allocations">
<meta name="keywords" content="NAT, TURN, STUN">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Behave</td><td class="header">S. Perreault, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Viagénie</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Expires: January 9, 2011</td><td class="header">jdrosen.net</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">July 8, 2010</td></tr>
</table></td></tr></table>
<h1><br />Traversal Using Relays around NAT (TURN) Extensions for TCP Allocations<br />draft-ietf-behave-turn-tcp-07.txt</h1>

<h3>Abstract</h3>

<p>This specification defines an extension of Traversal
Using Relays around NAT (TURN), a relay protocol for Network Address Translation
(NAT) traversal, to allow a TURN client to request TCP allocations, and defines
new requests and indications for the TURN server to open and accept TCP
connections with the client's peers.  TURN and this extension both
purposefully restrict the ways in which the relayed address can be
used. In particular, it prevents users from running general purpose
servers from ports obtained from the TURN server.
  
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on January 9, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Conventions<br />
<a href="#anchor3">3.</a>&nbsp;
Overview of Operation<br />
<a href="#client">4.</a>&nbsp;
Client Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.1.</a>&nbsp;
Creating an Allocation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.2.</a>&nbsp;
Refreshing an Allocation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.3.</a>&nbsp;
Initiating a Connection<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.4.</a>&nbsp;
Receiving a Connection<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">4.5.</a>&nbsp;
Sending and Receiving Data<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.6.</a>&nbsp;
Data Connection Maintenance<br />
<a href="#server">5.</a>&nbsp;
TURN Server Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">5.1.</a>&nbsp;
Receiving a TCP Allocate Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.2.</a>&nbsp;
Receiving a Connect Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#accept">5.3.</a>&nbsp;
Receiving a TCP Connection on a Relayed Transport Address<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">5.4.</a>&nbsp;
Receiving a ConnectionBind Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.5.</a>&nbsp;
Data Connection Maintenance<br />
<a href="#anchor14">6.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">6.1.</a>&nbsp;
New STUN Methods<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">6.2.</a>&nbsp;
New STUN Attributes<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">6.2.1.</a>&nbsp;
CONNECTION-ID<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">6.3.</a>&nbsp;
New STUN Error Codes<br />
<a href="#anchor19">7.</a>&nbsp;
Security Considerations<br />
<a href="#anchor20">8.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
Traversal Using Relays around NAT (TURN)
<a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a> is an extension to the Session
Traversal Utilities for NAT <a class='info' href='#RFC5389'>[RFC5389]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a> protocol. TURN
allows for clients to communicate with a TURN server, and ask it to
allocate ports on one of its host interfaces, and then relay traffic
between that port and the client itself. TURN, when used in concert
with STUN and Interactive Connectivity Establishment (ICE)
<a class='info' href='#RFC5245'>[RFC5245]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; April&nbsp;2010.</span><span>)</span></a> form a solution for NAT traversal
for UDP-based media sessions.

</p>
<p>
However, TURN itself does not provide a way for a client to allocate a
TCP-based port on a TURN server. Such an allocation is needed for
cases where a TCP-based session is desired with a peer, and NATs
prevent a direct TCP connection. Examples include application sharing
between desktop softphones, or transmission of pictures during a voice
communications session.

</p>
<p>
This document defines an extension to TURN which allows a client to
obtain a TCP allocation. It also allows the client to initiate outgoing TCP
connections from that allocation to peers, and accept incoming TCP connection
requests from peers made towards that allocation.

</p>
<p>The term "TCP allocation" means a TURN allocation where TCP is used as the
  transport protocol instead of UDP. Such an allocation is uniquely identified
  by its relayed transport address, which consists of an IP address and TCP port
  (defined in <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a>).
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Conventions</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
    "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
    document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview of Operation</h3>
<br /><hr class="insert" />
<a name="fig-turn-tcp-mod"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                                   +--------+
                                                   |        |
                                                   | Peer1  |
                                                /  |        |
                                               /   |        |
                                              /    +--------+
                                             /
                                            /
                                           / Peer Data 1
                                          /
   +--------+  Control       +--------+  /
   |        | -------------- |        | /
   | Client | Client Data 1  | TURN   |
   |        | -------------- | Server | \
   |        | -------------- |        |  \
   +--------+ Client Data 2  +--------+   \
                                           \
                                            \
                                             \     +--------+
                                              \    |        |
                                   Peer Data 2 \   | Peer2  |
                                                \  |        |
                                                   |        |
                                                   +--------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: TURN TCP Model&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The overall model for TURN-TCP is shown in <a class='info' href='#fig-turn-tcp-mod'>Figure&nbsp;1<span> (</span><span class='info'>TURN TCP Model</span><span>)</span></a>.
  The client will have two different types of connections to its TURN server.
  For each allocated relayed transport address, it will have a single control
  connection.  Control connections are used to obtain allocations and open up
  new connections. Furthermore, for each connection to a peer, the client will
  have a single connection to its TURN server. These connections are called data
  connections. Consequently, there is a data connection from the client to its
  TURN server (the client data connection) and one from the TURN server to a
  peer (the peer data connection). Actual application data is sent on these
  connections. Indeed, after an initial TURN message which binds the client data
  connection to a peer data connection, only application data can be sent - no
  TURN messaging. This is in contrast to the control connection, which only
  allows TURN messages and not application data.
</p>
<p>
To obtain a TCP-based allocation, a client first opens a TCP or TLS connection
to its TURN server. The client then sends an Allocate request over that control
connection. That request contains a REQUESTED-TRANSPORT attribute, which
indicates a TCP-based allocation is desired. A server which supports this
extension will allocate a TCP relayed transport address and begin listening for connection requests
on it. It then returns the allocated relayed transport address to the client in the response
to the Allocate request. The connection on which the Allocate request was sent
is the control connection.

</p>
<p>
If a client wishes to establish a TCP connection to a peer from that relayed
transport address, it issues a Connect request to the TURN server over the
control connection. That request contains a XOR-PEER-ADDRESS attribute
identifying the peer IP address and port (i.e. its "transport address") to which
a connection is to be made. The TURN server attempts to open the TCP connection,
and assuming it succeeds, then responds to the Connect request with a success
response. The server also creates a connection identifier associated with this
connection, and passes that connection identifier back to the client in the
success response.  Note that a maximum of one connection to a given peer
transport address can be established per allocation.

</p>
<p>
  </p>
<blockquote class="text">
<p>Note: Establishing a relayed connection from the client to a peer is done
      in two steps. First, the allocation is created, and second, the connection
      is established. Combining the two is not desirable for NAT traversal. It
      is expected that, between the first and second steps, the client will
      communicate off-band with the peer (e.g. using ICE <a class='info' href='#RFC5245'>[RFC5245]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; April&nbsp;2010.</span><span>)</span></a>) and tell it the relayed transport
      address that the TURN server allocated and from which it is about to
      initiate a connection. The peer can then "get ready": open holes in its
      firewall, try to poke holes in a NAT, attempt a TCP simultaneous open,
      etc.
</p>
</blockquote><p>

</p>
<p>
In order to actually send data on the new connection or otherwise
utilize it in any way, the client establishes a new TCP connection to
its TURN server. Once established, it issues a ConnectionBind request to the
server over this new connection. That request echoes back the connection
identifier to the TURN server. The TURN server uses it to correlate the two
connections. As a consequence, the TCP connection to the peer is
associated with a TCP connection to the client 1-to-1. The two
connections are now data connections. At this point, if the server
receives data from the peer, it forwards that data towards the client,
without any kind of encapsulation. Any data received by the TURN
server from the client over the client data connection are forwarded
to the peer, again without encapsulation or framing of any kind. Once
a connection has been bound using the ConnectionBind request, TURN
messaging is no longer permitted on the connection. 

</p>
<p>
In a similar way, when a peer opens a TCP connection towards the relayed
transport address, the server checks if there is a permission in place for that
peer. If there is none, the connection is closed. Permissions are created with
the CreatePermission request sent over the control connection, just as for UDP
TURN. If there is a permission in place, the TURN server sends, to the client, a
ConnectionAttempt Indication over the control connection. That indication
contains a connection identifier. Once again, the client initiates a separate
TCP connection to its TURN server, and over that connection, issues a
ConnectionBind request. Once received, the TURN server will begin relaying data
back and forth.  The server closes the peer data connection if no ConnectionBind
request is received after a timeout.

</p>
<p>
If the client closes a client data connection, the corresponding peer
data connection is closed. If the peer closes a peer data connection, the
corresponding client data connection is closed. In this way, the status of
the connection is directly known to the client.

</p>
<p>The TURN server will relay the data between the client and peer data
  connections.  End-to-end flow control is maintained by the relay process: if
  the relay process is no longer able to write data to the destination of the
  relayed data, the relay process stops reading data from the source.
</p>
<a name="client"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Client Processing</h3>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Creating an Allocation</h3>

<p>
To create a TCP allocation, a client MUST initiate a new TCP or TLS
connection to its TURN server, identical to the TCP or TLS procedures
defined in <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a>. TCP allocations
cannot be obtained using a UDP association between client and server.

</p>
<p>
Once set up, a client MUST send a TURN Allocate request. That request
MUST contain a REQUESTED-TRANSPORT attribute whose value is 6,
corresponding to TCP.

</p>
<p>
The request MUST NOT include a DONT-FRAGMENT, RESERVATION-TOKEN or
EVEN-PORT attribute. The corresponding features are specific to UDP
based capabilities and are not utilized by TURN-TCP. However, a
LIFETIME attribute MAY be included, with semantics identical to the
UDP case.

</p>
<p>
The procedures for authentication of the Allocate request and
processing of success and failure responses are identical to those for
UDP. 

</p>
<p>
Once a success response is received, the TCP connection to the TURN
server is called the control connection for that allocation.

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Refreshing an Allocation</h3>

<p>
The procedures for refreshing an allocation are identical to those for
UDP. Note that the Refresh MUST be sent on the control connection.

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Initiating a Connection</h3>

<p>
To initiate a TCP connection to a peer, a client MUST send a Connect
request over the control connection for the desired allocation.
The Connect request MUST include a
XOR-PEER-ADDRESS attribute containing the transport address of the
peer to which a connection is desired. 

</p>
<p>
If the connection is successfully established, the client will receive
a success response. That response will contain a CONNECTION-ID
attribute. The client MUST initiate a new TCP connection to the
server, utilizing the same destination transport address to which the control
connection was established. This connection MUST be made using a
different local transport address. Authentication of the client by the
server MUST use the same method and credentials as for the control connection.
Once established, the client MUST send a ConnectionBind request over the new
connection. That request MUST include the CONNECTION-ID attribute, echoed from
the Connect Success response. When a response to the ConnectionBind request is
received, if it is a success, the TCP connection on which it was sent is called
the client data connection corresponding to the peer.

</p>
<p>
If the result of the Connect request was a Error Response, and the
response code was 447 (Connection Timeout or Failure), it means that the TURN
server was unable to connect to the peer. The client MAY retry with the same
XOR-PEER-ADDRESS attribute, but MUST wait at least 10 seconds. 

</p>
<p>As with any other request, multiple Connect requests MAY be sent
  simultaneously. However, Connect requests with the same XOR-PEER-ADDRESS
  parameter MUST NOT be sent simultaneously.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Receiving a Connection</h3>

<p>After an Allocate request is successfully processed by the server, the
    client will start receiving a
    ConnectionAttempt indication each time a peer for which a permission has
    been installed attempts a new connection to
    the relayed transport address. This indication will contain a CONNECTION-ID and a
    XOR-PEER-ADDRESS attributes. If the client wishes to accept this connection,
    it MUST initiate a new TCP connection to the server, utilizing the same
    destination transport address to which the control connection was
    established. This connection MUST be made using a different local transport
    address. Authentication of the client by the server MUST use the same method
    and credentials as for the control connection. Once established, the client
    MUST send a ConnectionBind request over the new connection. That request
    MUST include the CONNECTION-ID attribute, echoed from the ConnectionAttempt
    indication. When a response to the ConnectionBind request is received, if it
    is a success, the TCP connection on which it was sent is called the client
    data connection corresponding to the peer.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Sending and Receiving Data</h3>

<p>Once a client data connection is established, data sent on it by the client
    will be relayed as-is to the peer by the server. Similarly, data sent by the
    peer to the server will be relayed as-is to the client over the data
    connection.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Data Connection Maintenance</h3>

<p>The client MUST refresh the allocation corresponding to a data connection,
    using the Refresh request as defined in <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a>, for as long as it wants to keep the data
    connection alive.
</p>
<p>When the client wishes to terminate its relayed connection to the peer, it
    closes the data connection to the server.
</p>
<p>
    </p>
<blockquote class="text">
<p>Note: No mechanism for keeping alive the NAT bindings (potentially on
        the client data connection as well as on the peer data connection) is
        included. This service is not provided by TURN-TCP. If such a feature is
        deemed necessary, it can be implemented higher up the stack, in the
        application protocol being tunneled inside TURN-TCP. Also, TCP
        keep-alives MAY be used to keep the NAT bindings on the client data
        connection alive.
</p>
</blockquote><p>
  
</p>
<a name="server"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
TURN Server Behavior</h3>

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Receiving a TCP Allocate Request</h3>

<p>The process is similar to that defined in <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a>, Section 6.2, with the following
    exceptions:
</p>
<p>
    </p>
<ol class="text">
<li>If the REQUESTED-TRANSPORT attribute is included and specifies a
        protocol other than UDP or TCP, the server MUST reject the request with
        a 442 (Unsupported Transport Protocol) error.  If the value is UDP, and
        if UDP transport is allowed by local policy, the server MUST continue
        with the procedures of <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a> instead of
        this document. If the value is UDP, and if UDP transport is forbidden by
        local policy, the server MUST reject the request with a 403 (Forbidden)
        error.
</li>
<li>If the client connection transport is not TCP or TLS, the server MUST
        reject the request with a 400 (Bad Request) error.
</li>
<li>If the request contains the DONT-FRAGMENT, EVEN-PORT, or
        RESERVATION-TOKEN attribute, the server MUST reject the request with a
        400 (Bad Request) error.
</li>
<li>A TCP relayed transport address MUST be allocated instead of a UDP
        one.
</li>
<li>The RESERVATION-TOKEN attribute MUST NOT be present in the success
        response.
</li>
</ol><p>
  
</p>
<p>If all checks pass, the server MUST start accepting incoming TCP
    connections on the relayed transport address. Refer to <a class='info' href='#accept'>Section&nbsp;5.3<span> (</span><span class='info'>Receiving a TCP Connection on a Relayed Transport Address</span><span>)</span></a> for details.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Receiving a Connect Request</h3>

<p>When the server receives a Connect request, it processes as follows.
</p>
<p>If the request is received on a TCP connection for which no allocation
    exists, the server MUST return a 437 (Allocation Mismatch) error.
</p>
<p>If the server is currently processing a Connect request for this allocation
    with the same XOR-PEER-ADDRESS, it MUST return a 446 (Connection Already
    Exists) error.
</p>
<p>If the server has already successfully processed a Connect request for this
    allocation with the same XOR-PEER-ADDRESS, and the resulting client and peer
    data connections are either pending or active, it MUST return a 446
    (Connection Already Exists) error.
</p>
<p>If the request does not contain a XOR-PEER-ADDRESS attribute, or if such
    attribute is invalid, the server MUST return a 400 (Bad Request) error.
</p>
<p>If the new connection is forbidden by local policy, the server MUST reject
    the request with a 403 (Forbidden) error.
</p>
<p>Otherwise, the server MUST initiate an outgoing TCP connection. The local
    endpoint is the relayed transport address associated with the allocation.
    The remote endpoint is the one indicated by the XOR-PEER-ADDRESS attribute.
    If the connection attempt fails or times out, the server MUST return a 447
    (Connection Timeout or Failure) error. The timeout value MUST be at least 30
    seconds.
</p>
<p>If the connection is successful, it is now called a peer data connection.
    The server MUST buffer any data received from the client. The server adjusts
    its advertised TCP receive window to reflect the amount of empty buffer
    space.
</p>
<p>The server MUST include the CONNECTION-ID attribute in the Connect success
    response. The attribute's value MUST uniquely identify the peer data
    connection.
</p>
<p>If no ConnectionBind request associated with this peer data connection is
    received after 30 seconds, the peer data connection MUST be closed.
</p>
<a name="accept"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Receiving a TCP Connection on a Relayed Transport Address</h3>

<p>When a server receives an incoming TCP connection on a relayed transport
    address, it processes as follows.
</p>
<p>The server MUST accept the connection. If it is not successful,
    nothing is sent to the client over the control connection.
</p>
<p>If the connection is successfully accepted, it is now called a peer data
    connection. The server MUST buffer any data received from the peer. The
    server adjusts its advertised TCP receive window to reflect the amount of
    empty buffer space.
</p>
<p>If no permission for this peer has been installed for this allocation, the
    server MUST close the connection with the peer immediately after it has been
    accepted.
</p>
<p>Otherwise, the server sends a ConnectionAttempt indication to the client
    over the control connection. The indication MUST include a XOR-PEER-ADDRESS
    attribute containing the peer's transport address, as well as a CONNECTION-ID
    attribute uniquely identifying the peer data connection.
</p>
<p>If no ConnectionBind request associated with this peer data connection is
    received after 30 seconds, the peer data connection MUST be closed.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Receiving a ConnectionBind Request</h3>

<p>When a server receives a ConnectionBind request, it processes as
    follows.
</p>
<p>If the client connection transport is not TCP or TLS, the server MUST
    return a 400 (Bad Request) error.
</p>
<p>If the request does not contain the CONNECTION-ID attribute, or if this
    attribute does not refer to an existing pending connection, the server
    MUST return a 400 (Bad Request) error.
</p>
<p>Otherwise, the client connection is now called a client data connection.
    Data received on it MUST be sent as-is to the associated peer data
    connection.
</p>
<p>Data received on the associated peer data connection MUST be sent as-is on
    this client data connection. This includes data that was received after the
    associated Connect or request was successfully processed and before
    this ConnectionBind request was received.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
Data Connection Maintenance</h3>

<p>If the allocation associated with a data connection expires, the data
    connection MUST be closed.
</p>
<p>When a client data connection is closed, the server MUST close the
    corresponding peer data connection.
</p>
<p>When a peer data connection is closed, the server MUST close the
    corresponding client data connection.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<p>
This specification defines several new STUN methods, STUN attributes,
and STUN error codes.  This section directs IANA to add these new
protocol elements to the IANA registry of STUN protocol elements.

</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
New STUN Methods</h3>

<p>This section lists the codepoints for the new STUN methods defined
    in this specification.  See <a class='info' href='#client'>Section&nbsp;4<span> (</span><span class='info'>Client Processing</span><span>)</span></a> and <a class='info' href='#server'>Section&nbsp;5<span> (</span><span class='info'>TURN Server Behavior</span><span>)</span></a> for the semantics of these new methods.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0x000A :  Connect
0x000B :  ConnectionBind
0x000C :  ConnectionAttempt
</pre></div>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
New STUN Attributes</h3>

<p>This STUN extension defines the following new attributes:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0x002A :  CONNECTION-ID
</pre></div>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.1"></a><h3>6.2.1.&nbsp;
CONNECTION-ID</h3>

<p>The CONNECTION-ID attributes uniquely identifies a peer data connection. It
    is a 32-bit unsigned integral value.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
New STUN Error Codes</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
446    Connection Already Exists
447    Connection Timeout or Failure
</pre></div>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>After a TCP connection is established between the server and a peer, and
    before a ConnectionBind request is received from the client, the server
    buffers all data received from the peer. This protocol specification lets
    the server drop the connection if the buffer size is about to exceed a
    limit defined by local policy. This policy should ensure that memory
    resources are not exceeded. See also <a class='info' href='#RFC4732'>[RFC4732]<span> (</span><span class='info'>Handley, M., Rescorla, E., and IAB, &ldquo;Internet Denial-of-Service Considerations,&rdquo; December&nbsp;2006.</span><span>)</span></a>, Section
    2.1.3.
</p>
<p>All the security considerations applicable to STUN <a class='info' href='#RFC5389'>[RFC5389]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a>
    and TURN <a class='info' href='#RFC5766'>[RFC5766]<span> (</span><span class='info'>Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; April&nbsp;2010.</span><span>)</span></a> are applicable to this
    document as well.
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgements</h3>

<p>Thanks to Rohan Mahy and Philip Matthews for their initial work on
        getting this document started.
</p>
<p>The authors would also like to thank Alfred E. Heggestad, Ari Keranen,
      Marc Petit-Huguenin, Dave Thaler, and Dan Wing for their comments and
      suggestions.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC5389">[RFC5389]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>,&rdquo; RFC&nbsp;5389, October&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5389.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5766">[RFC5766]</a></td>
<td class="author-text">Mahy, R., Matthews, P., and J. Rosenberg, &ldquo;<a href="http://tools.ietf.org/html/rfc5766">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>,&rdquo; RFC&nbsp;5766, April&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5766.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC5245">[RFC5245]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; RFC&nbsp;5245, April&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5245.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4732">[RFC4732]</a></td>
<td class="author-text">Handley, M., Rescorla, E., and IAB, &ldquo;<a href="http://tools.ietf.org/html/rfc4732">Internet Denial-of-Service Considerations</a>,&rdquo; RFC&nbsp;4732, December&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4732.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Simon Perreault (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Viagénie</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">2600 boul. Laurier, suite 625</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Québec, QC  G1V 4W1</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 418 656 9254</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:simon.perreault@viagenie.ca">simon.perreault@viagenie.ca</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.viagenie.ca">http://www.viagenie.ca</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">jdrosen.net</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Monmouth, NJ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@jdrosen.net">jdrosen@jdrosen.net</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.jdrosen.net">http://www.jdrosen.net</a></td></tr>
</table>
</body></html>
